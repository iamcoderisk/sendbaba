{% extends "base.html" %}

{% block title %}Send Email - SendBaba{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/templates.css">

<div class="max-w-4xl mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">üìß Send Email</h1>
        <p class="text-gray-600 mt-2">Send a single email or test your setup</p>
    </div>

    {% if not domains or domains|length == 0 %}
    <!-- No domains warning -->
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg">
        <div class="flex items-center mb-4">
            <div class="text-4xl mr-4">üìß</div>
            <div>
                <h3 class="text-lg font-semibold text-yellow-800">No Verified Domains</h3>
                <p class="text-yellow-700">You need to add and verify a domain before sending emails</p>
            </div>
        </div>
        <a href="/dashboard/domains/" 
           class="inline-block px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
            Add Your First Domain
        </a>
    </div>
    {% else %}

    <!-- Send Email Form -->
    <div class="bg-white rounded-lg shadow-lg p-8">
        <form id="sendEmailForm" action="/api/emails/send" method="POST">
            <!-- From Section -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">From Email *</label>
                <div class="flex items-center space-x-4">
                    <input type="text" name="from_name" placeholder="sender" required
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                    <span class="text-gray-500">@</span>
                    <select name="from_domain" required
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                        {% for domain in domains %}
                        <option value="{{ domain.domain_name }}">{{ domain.domain_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <p class="text-xs text-gray-500 mt-1">Example: hello@{{ domains[0].domain_name }}</p>
            </div>

            <!-- To Email -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">To Email *</label>
                <input type="email" name="to_email" required
                       placeholder="recipient@example.com"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
            </div>

            <!-- Subject -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Subject *</label>
                <input type="text" name="subject" required
                       placeholder="Enter email subject"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
            </div>

            <!-- Email Body -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Email Content *</label>
                <textarea name="html_body" id="htmlBody" rows="15" required
                          placeholder="<html><body><h1>Hello!</h1><p>Your message here...</p></body></html>"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none font-mono text-sm"></textarea>
                <p class="text-xs text-gray-500 mt-2">
                    ‚ú® HTML is supported for better formatting
                </p>
            </div>

            <!-- Actions -->
            <div class="flex justify-between items-center pt-6 border-t">
                <a href="/dashboard/" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cancel
                </a>
                <button type="submit" id="sendBtn"
                        class="px-8 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                    <i class="fas fa-paper-plane mr-2"></i>Send Email
                </button>
            </div>
        </form>
    </div>

    {% endif %}
</div>

<script>
document.getElementById('sendEmailForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('sendBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/api/emails/send', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Email sent successfully!');
            this.reset();
        } else {
            alert('‚ùå Error: ' + (data.error || 'Failed to send'));
        }
    } catch (error) {
        alert('‚ùå Network error: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send Email';
    }
});
</script>
{% endblock %}
