{% extends "base.html" %}

{% block title %}Reply Details - SendBaba{% endblock %}

{% block content %}
<div class="p-6 md:p-8">
    <div class="mb-6">
        <a href="{{ url_for('replies.index') }}" class="text-purple-600 hover:text-purple-700">
            <i class="fas fa-arrow-left mr-2"></i>Back to Replies
        </a>
    </div>
    
    <div class="grid md:grid-cols-3 gap-6">
        <!-- Main Reply Content -->
        <div class="md:col-span-2 space-y-6">
            <!-- Reply Details -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center gap-3 mb-4">
                    <div class="text-4xl">ğŸ’¬</div>
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold">{{ reply.from_name or reply.from_email }}</h2>
                        <div class="text-sm text-gray-600">{{ reply.from_email }}</div>
                    </div>
                    
                    <!-- Status Badge -->
                    {% if reply.responded %}
                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                        âœ… Responded
                    </span>
                    {% else %}
                    <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm">
                        â³ Needs Response
                    </span>
                    {% endif %}
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                    <div>
                        <span class="text-gray-600">Received:</span>
                        <span class="font-semibold ml-2">{{ reply.created_at.strftime('%b %d, %Y %I:%M %p') }}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Campaign:</span>
                        <span class="font-semibold ml-2">
                            {% if reply.campaign %}{{ reply.campaign.name }}{% else %}N/A{% endif %}
                        </span>
                    </div>
                </div>
                
                {% if reply.subject %}
                <div class="mb-4">
                    <div class="text-sm text-gray-600 mb-1">Subject:</div>
                    <div class="font-semibold text-lg">{{ reply.subject }}</div>
                </div>
                {% endif %}
                
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="whitespace-pre-wrap text-gray-800">{{ reply.text_body }}</div>
                </div>
            </div>
            
            <!-- Response Section -->
            {% if not reply.responded %}
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="font-semibold text-lg mb-4">âœï¸ Your Response</h3>
                
                <textarea 
                    id="responseText"
                    class="w-full border rounded-lg p-4 mb-4"
                    rows="8"
                    placeholder="Type your response here..."
                ></textarea>
                
                <div class="flex gap-3">
                    <button 
                        onclick="sendResponse()"
                        class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-semibold"
                    >
                        ğŸ“§ Send Response
                    </button>
                    
                    <button 
                        onclick="useTemplate()"
                        class="border border-gray-300 px-6 py-3 rounded-lg hover:bg-gray-50"
                    >
                        ğŸ“ Use Template
                    </button>
                </div>
            </div>
            {% else %}
            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                <h3 class="font-semibold text-green-900 mb-3">
                    âœ… Response Sent
                    {% if reply.auto_responded %}by AI{% endif %}
                </h3>
                <div class="text-sm text-gray-600 mb-3">
                    {{ reply.responded_at.strftime('%b %d, %Y %I:%M %p') }}
                </div>
                <div class="bg-white rounded-lg p-4">
                    <div class="whitespace-pre-wrap text-gray-800">{{ reply.response_text }}</div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- AI Insights Sidebar -->
        <div class="space-y-6">
            <!-- AI Analysis -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="font-semibold mb-4">ğŸ§  AI Analysis</h3>
                
                <div class="space-y-4">
                    <!-- Sentiment -->
                    <div>
                        <div class="text-sm text-gray-600 mb-1">Sentiment</div>
                        <div class="flex items-center gap-2">
                            {% if reply.sentiment == 'positive' %}
                            <span class="text-2xl">ğŸ˜Š</span>
                            <span class="font-semibold text-green-600">Positive</span>
                            {% elif reply.sentiment == 'negative' %}
                            <span class="text-2xl">ğŸ˜</span>
                            <span class="font-semibold text-red-600">Negative</span>
                            {% else %}
                            <span class="text-2xl">ğŸ˜</span>
                            <span class="font-semibold text-gray-600">Neutral</span>
                            {% endif %}
                            {% if reply.sentiment_score %}
                            <span class="text-sm text-gray-500">({{ (reply.sentiment_score * 100)|round }}%)</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Intent -->
                    <div>
                        <div class="text-sm text-gray-600 mb-1">Intent</div>
                        <div class="font-semibold">{{ reply.intent|replace('_', ' ')|title }}</div>
                    </div>
                    
                    <!-- Category -->
                    <div>
                        <div class="text-sm text-gray-600 mb-1">Category</div>
                        <div class="font-semibold">{{ reply.category|replace('_', ' ')|title }}</div>
                    </div>
                    
                    <!-- Urgency -->
                    <div>
                        <div class="text-sm text-gray-600 mb-1">Urgency</div>
                        <div class="flex items-center gap-2">
                            {% if reply.urgency == 'high' %}
                            <span class="text-red-600 font-semibold">ğŸ”¥ High</span>
                            {% elif reply.urgency == 'medium' %}
                            <span class="text-yellow-600 font-semibold">âš¡ Medium</span>
                            {% else %}
                            <span class="text-gray-600 font-semibold">â±ï¸ Low</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Suggestions -->
            {% if suggestions %}
            <div class="bg-gradient-to-br from-purple-500 to-blue-500 rounded-lg p-6 text-white">
                <h3 class="font-semibold mb-4">ğŸ’¡ AI Suggestions</h3>
                
                <div class="space-y-3">
                    {% for suggestion in suggestions %}
                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                        <div class="font-semibold mb-1">{{ suggestion.message }}</div>
                        <div class="text-sm opacity-90">{{ suggestion.reason }}</div>
                        <div class="mt-2 text-xs">
                            Priority: 
                            {% if suggestion.priority == 'critical' %}ğŸ”´ Critical
                            {% elif suggestion.priority == 'high' %}ğŸŸ  High
                            {% else %}ğŸŸ¢ Medium{% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Contact Info -->
            {% if reply.contact %}
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="font-semibold mb-4">ğŸ‘¤ Contact Info</h3>
                
                <div class="space-y-2 text-sm">
                    <div>
                        <span class="text-gray-600">Name:</span>
                        <span class="font-semibold ml-2">
                            {{ reply.contact.first_name }} {{ reply.contact.last_name }}
                        </span>
                    </div>
                    <div>
                        <span class="text-gray-600">Email:</span>
                        <span class="font-semibold ml-2">{{ reply.contact.email }}</span>
                    </div>
                    {% if reply.contact.tags %}
                    <div>
                        <span class="text-gray-600">Tags:</span>
                        <div class="mt-1 flex flex-wrap gap-1">
                            {% for tag in reply.contact.tags %}
                            <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function sendResponse() {
    const response = document.getElementById('responseText').value;
    
    if (!response.trim()) {
        alert('Please type a response');
        return;
    }
    
    if (!confirm('Send this response?')) {
        return;
    }
    
    fetch('/dashboard/replies/{{ reply.id }}/respond', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({response: response})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Response sent successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to send'));
        }
    });
}

function useTemplate() {
    const templates = {
        'pricing': `Hi there,

Thanks for your interest in SendBaba!

Here's our pricing:

ğŸ“¦ Starter: $9/month - 5,000 contacts
ğŸ“¦ Growth: $29/month - 25,000 contacts  
ğŸ“¦ Pro: $99/month - 100,000 contacts

Would you like to schedule a call?

Best regards,
The SendBaba Team`,
        'demo_request': `Hi there,

I'd love to show you SendBaba!

Book a demo: https://sendbaba.com/demo

Best regards,
The SendBaba Team`
    };
    
    const category = '{{ reply.category }}';
    const template = templates[category] || templates['pricing'];
    document.getElementById('responseText').value = template;
}
</script>
{% endblock %}
