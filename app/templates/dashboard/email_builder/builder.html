<!DOCTYPE html>
<html>
<head>
    <title>{% if template %}Edit Template{% else %}Create Template{% endif %} - SendBaba</title>
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <link rel="stylesheet" href="https://unpkg.com/grapesjs-preset-newsletter/dist/grapesjs-preset-newsletter.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #1a1a2e; color: white; }
        .top-bar input { background: #2d2d44; border: none; padding: 8px 12px; border-radius: 4px; color: white; width: 250px; }
        .top-bar .actions { display: flex; gap: 10px; }
        .top-bar .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-size: 14px; }
        .btn-secondary { background: #3d3d5c; color: white; }
        .btn-primary { background: #8B5CF6; color: white; }
        .btn:hover { opacity: 0.9; }
        #gjs { border: none; }
        .gjs-one-bg { background-color: #1a1a2e; }
        .gjs-two-color { color: #ddd; }
        .gjs-three-bg { background-color: #2d2d44; }
        .gjs-four-color, .gjs-four-color-h:hover { color: #8B5CF6; }
    </style>
    <script src="https://scripts.sirv.com/sirvjs/v3/sirv.js"></script>
</head>
<body>
    <div class="top-bar">
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="/dashboard/email-builder" style="color: white; text-decoration: none;">
                <i class="fas fa-arrow-left"></i>
            </a>
            <input type="text" id="templateName" value="{{ template.name if template else 'Untitled Template' }}" placeholder="Template name">
        </div>
        <div class="actions">
            <button class="btn btn-secondary" onclick="previewEmail()"><i class="fas fa-eye"></i> Preview</button>
            <button class="btn btn-secondary" onclick="sendTest()"><i class="fas fa-paper-plane"></i> Test</button>
            <button class="btn btn-secondary" onclick="saveTemplate('draft')"><i class="fas fa-save"></i> Save Draft</button>
            <button class="btn btn-primary" onclick="saveTemplate('active')"><i class="fas fa-check"></i> Publish</button>
        </div>
    </div>
    
    <div id="gjs"></div>

    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://unpkg.com/grapesjs-preset-newsletter"></script>
    <script>
        const templateId = '{{ template.id if template else "" }}';
        
        const editor = grapesjs.init({
            container: '#gjs',
            height: 'calc(100vh - 52px)',
            width: 'auto',
            plugins: ['grapesjs-preset-newsletter'],
            pluginsOpts: {
                'grapesjs-preset-newsletter': {
                    modalTitleImport: 'Import HTML',
                    modalTitleExport: 'Export HTML',
                }
            },
            storageManager: templateId ? {
                type: 'remote',
                stepsBeforeSave: 3,
                urlStore: `/dashboard/email-builder/api/gjs/store/${templateId}`,
                urlLoad: `/dashboard/email-builder/api/gjs/load/${templateId}`,
                contentTypeJson: true,
                storeComponents: true,
                storeStyles: true,
                storeHtml: true,
                storeCss: true,
            } : false,
            assetManager: {
                upload: '/dashboard/email-builder/api/assets/upload',
                uploadName: 'file',
                assets: [],
                autoAdd: true
            },
            deviceManager: {
                devices: [
                    { name: 'Desktop', width: '' },
                    { name: 'Tablet', width: '768px', widthMedia: '992px' },
                    { name: 'Mobile', width: '320px', widthMedia: '480px' },
                ]
            }
        });

        fetch('/dashboard/email-builder/api/assets')
            .then(r => r.json())
            .then(data => {
                if (data.assets) editor.AssetManager.add(data.assets);
            });

        editor.on('storage:start:store', () => {
            document.querySelector('.btn-primary').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        });
        editor.on('storage:end:store', () => {
            document.querySelector('.btn-primary').innerHTML = '<i class="fas fa-check"></i> Publish';
        });

        async function saveTemplate(status) {
            const html = editor.getHtml();
            const css = editor.getCss();
            const components = JSON.stringify(editor.getComponents());
            const styles = JSON.stringify(editor.getStyle());
            
            const data = {
                name: document.getElementById('templateName').value,
                gjs_html: html,
                gjs_css: css,
                gjs_components: components,
                gjs_styles: styles,
                status: status
            };
            
            const url = templateId 
                ? `/dashboard/email-builder/api/templates/${templateId}`
                : '/dashboard/email-builder/api/templates';
            
            const response = await fetch(url, {
                method: templateId ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (!templateId && result.template) {
                    window.location.href = `/dashboard/email-builder/${result.template.id}/edit`;
                } else {
                    alert(status === 'active' ? 'Template published!' : 'Draft saved!');
                }
            }
        }

        function previewEmail() {
            const html = editor.getHtml();
            const css = editor.getCss();
            const fullHtml = `<!DOCTYPE html><html><head><style>${css}</style>    <script src="https://scripts.sirv.com/sirvjs/v3/sirv.js"></script>
</head><body>${html}</body></html>`;
            const win = window.open('', '_blank');
            win.document.write(fullHtml);
        }

        async function sendTest() {
            const email = prompt('Enter email address for test:');
            if (!email) return;
            
            if (!templateId) {
                alert('Please save the template first');
                return;
            }
            
            const response = await fetch(`/dashboard/email-builder/api/templates/${templateId}/send-test`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ to_email: email })
            });
            
            const result = await response.json();
            alert(result.success ? 'Test email sent!' : result.error);
        }
    </script>
</body>
</html>
