{% extends "dashboard/base.html" %}

{% block title %}Bulk Send{% endblock %}

{% block content %}
<div class="p-6 max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Send Bulk Email</h1>

    <form method="POST" action="{{ url_for('bulk_send.send') }}" id="bulkSendForm">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left: Contact Lists Selection -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow p-6 sticky top-6">
                    <h3 class="text-lg font-semibold mb-4">Select Recipients</h3>
                    
                    {% if contact_lists %}
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        {% for list in contact_lists %}
                        <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-red-500 cursor-pointer transition">
                            <input type="checkbox" name="list_ids[]" value="{{ list.id }}" 
                                   class="rounded text-red-500 mr-3" onchange="updateRecipientCount()">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">{{ list.name }}</div>
                                <div class="text-sm text-gray-500">{{ list.total_contacts }} contacts</div>
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <div class="text-sm text-blue-800 mb-2">
                            <strong id="totalRecipients">0</strong> recipients selected
                        </div>
                        <button type="button" onclick="previewRecipients()" 
                                class="text-sm text-blue-600 hover:text-blue-800">
                            <i class="fas fa-eye mr-1"></i>Preview recipients
                        </button>
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-users text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-600 mb-4">No contact lists yet</p>
                        <a href="{{ url_for('contact.import_page') }}" 
                           class="text-red-500 hover:text-red-700 font-semibold">
                            Import Contacts
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Right: Email Content -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Compose Email</h3>
                    
                    <div class="space-y-4">
                        <!-- From Details -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">From Name</label>
                                <input type="text" name="from_name" value="SendBaba"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">From Email</label>
                                <input type="email" name="from_email" value="noreply@sendbaba.com"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                        </div>

                        <!-- Subject -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Subject *</label>
                            <input type="text" name="subject" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                                placeholder="Your email subject">
                        </div>

                        <!-- Message -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Message (HTML) *</label>
                            <textarea name="html_content" required rows="15"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 font-mono text-sm"
                                placeholder="<html>&#10;<body>&#10;  <h1>Hello {{first_name}}!</h1>&#10;  <p>Your message here...</p>&#10;</body>&#10;</html>"></textarea>
                            
                            <div class="mt-2 flex items-center justify-between">
                                <div class="text-sm text-gray-500">
                                    <i class="fas fa-info-circle"></i>
                                    Use: {{first_name}}, {{last_name}}, {{email}}, {{company}}
                                </div>
                                <button type="button" onclick="showTemplates()" 
                                        class="text-sm text-red-500 hover:text-red-700">
                                    <i class="fas fa-file-alt mr-1"></i>Use Template
                                </button>
                            </div>
                        </div>

                        <!-- Quick Templates -->
                        <div id="templateSelector" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quick Templates</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button type="button" onclick="useTemplate('welcome')" 
                                        class="px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-red-500 transition">
                                    Welcome
                                </button>
                                <button type="button" onclick="useTemplate('newsletter')" 
                                        class="px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-red-500 transition">
                                    Newsletter
                                </button>
                                <button type="button" onclick="useTemplate('promo')" 
                                        class="px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-red-500 transition">
                                    Promotional
                                </button>
                            </div>
                        </div>

                        <!-- Submit -->
                        <div class="flex justify-between pt-6 border-t">
                            <a href="{{ url_for('dashboard.index') }}" 
                               class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                Cancel
                            </a>
                            <button type="submit" 
                                    class="bg-red-500 text-white px-8 py-3 rounded-lg hover:bg-red-600 transition font-semibold"
                                    onclick="return confirmSend()">
                                <i class="fas fa-paper-plane mr-2"></i>Send to All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Preview Recipients</h3>
            <button onclick="closePreview()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <div id="previewContent" class="max-h-96 overflow-y-auto">
            <div class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-4xl text-gray-300"></i>
            </div>
        </div>
    </div>
</div>

<script>
function updateRecipientCount() {
    const checkboxes = document.querySelectorAll('input[name="list_ids[]"]:checked');
    let total = 0;
    
    checkboxes.forEach(checkbox => {
        const label = checkbox.closest('label');
        const contactsText = label.querySelector('.text-sm').textContent;
        const count = parseInt(contactsText.match(/\d+/)[0]);
        total += count;
    });
    
    document.getElementById('totalRecipients').textContent = total;
}

function previewRecipients() {
    const checkboxes = document.querySelectorAll('input[name="list_ids[]"]:checked');
    
    if (checkboxes.length === 0) {
        alert('Please select at least one contact list');
        return;
    }
    
    const formData = new FormData();
    checkboxes.forEach(cb => formData.append('list_ids[]', cb.value));
    
    document.getElementById('previewModal').classList.remove('hidden');
    
    fetch('{{ url_for("bulk_send.preview") }}', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        let html = `
            <div class="mb-4 p-4 bg-green-50 rounded-lg">
                <div class="text-lg font-semibold text-green-800">
                    ${data.total_contacts} contacts will receive this email
                </div>
            </div>
            <div class="space-y-2">
                <h4 class="font-semibold">Sample Recipients:</h4>
        `;
        
        data.sample_contact.forEach(contact => {
            html += `
                <div class="p-3 bg-gray-50 rounded">
                    <div class="font-medium">${contact.name}</div>
                    <div class="text-sm text-gray-600">${contact.email}</div>
                </div>
            `;
        });
        
        html += '</div>';
        document.getElementById('previewContent').innerHTML = html;
    });
}

function closePreview() {
    document.getElementById('previewModal').classList.add('hidden');
}

function showTemplates() {
    const selector = document.getElementById('templateSelector');
    selector.classList.toggle('hidden');
}

function useTemplate(type) {
    const templates = {
        welcome: `<!DOCTYPE html>
<html>
<head><meta charset="utf-8">    <script src="https://scripts.sirv.com/sirvjs/v3/sirv.js"></script>
</head>
<body style="font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto;">
    <h1 style="color: #E84142;">Welcome {{first_name}}!</h1>
    <p style="font-size: 16px; color: #333;">
        We're excited to have you join our community.
    </p>
    <p>Best regards,<br>The SendBaba Team</p>
</body>
</html>`,
        newsletter: `<!DOCTYPE html>
<html>
<head><meta charset="utf-8">    <script src="https://scripts.sirv.com/sirvjs/v3/sirv.js"></script>
</head>
<body style="margin: 0; padding: 0; background-color: #f5f5f5;">
    <div style="max-width: 600px; margin: 0 auto; background-color: white;">
        <div style="background-color: #E84142; padding: 30px; text-align: center;">
            <h1 style="color: white; margin: 0;">Newsletter Update</h1>
        </div>
        <div style="padding: 30px;">
            <h2>Hi {{first_name}},</h2>
            <p>Here's what's new this week...</p>
        </div>
    </div>
</body>
</html>`,
        promo: `<!DOCTYPE html>
<html>
<head><meta charset="utf-8">    <script src="https://scripts.sirv.com/sirvjs/v3/sirv.js"></script>
</head>
<body style="margin: 0; padding: 0;">
    <div style="max-width: 600px; margin: 0 auto; text-align: center;">
        <div style="background: linear-gradient(135deg, #E84142 0%, #FF6B6B 100%); padding: 50px 30px; color: white;">
            <h1 style="margin: 0; font-size: 36px;">ðŸŽ‰ SPECIAL OFFER</h1>
            <p style="font-size: 24px; margin: 20px 0;">Just for {{first_name}}!</p>
        </div>
        <div style="padding: 40px 30px;">
            <p style="font-size: 18px; color: #333;">
                Don't miss this exclusive offer...
            </p>
        </div>
    </div>
</body>
</html>`
    };
    
    document.querySelector('textarea[name="html_content"]').value = templates[type];
}

function confirmSend() {
    const total = document.getElementById('totalRecipients').textContent;
    
    if (total === '0') {
        alert('Please select at least one contact list');
        return false;
    }
    
    return confirm(`Send this email to ${total} recipients?`);
}
</script>
{% endblock %}
