{% extends "dashboard/base.html" %}
{% block title %}View Reply - SendBaba{% endblock %}
{% block content %}
<div class="p-6" x-data="replyView()">
    <div class="max-w-4xl mx-auto">
        <a href="/dashboard/replies" class="text-purple-600 mb-4 inline-block"><i class="fas fa-arrow-left mr-2"></i>Back to Inbox</a>
        
        <div class="bg-white rounded-lg shadow">
            <!-- Header -->
            <div class="p-4 border-b">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-xl font-bold">{{ reply.subject or '(No subject)' }}</h1>
                        <div class="text-gray-600 mt-1">
                            From: <strong>{{ reply.from_name or reply.from_email }}</strong> &lt;{{ reply.from_email }}&gt;
                        </div>
                        <div class="text-sm text-gray-500">{{ reply.received_at.strftime('%B %d, %Y at %I:%M %p') }}</div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="archiveReply()" class="px-3 py-1 border rounded text-sm"><i class="fas fa-archive mr-1"></i>Archive</button>
                        <button @click="markSpam()" class="px-3 py-1 border rounded text-sm text-red-600"><i class="fas fa-ban mr-1"></i>Spam</button>
                    </div>
                </div>
            </div>
            
            <!-- AI Analysis -->
            <div class="p-4 bg-purple-50 border-b">
                <h3 class="font-medium text-purple-900 mb-2"><i class="fas fa-robot mr-2"></i>AI Analysis</h3>
                <div class="grid grid-cols-4 gap-4 text-sm">
                    <div>
                        <div class="text-gray-500">Sentiment</div>
                        <div class="font-medium {{ 'text-green-600' if reply.sentiment == 'positive' else 'text-red-600' if reply.sentiment == 'negative' else 'text-gray-600' }}">
                            {{ reply.sentiment|capitalize if reply.sentiment else 'Unknown' }}
                        </div>
                    </div>
                    <div>
                        <div class="text-gray-500">Intent</div>
                        <div class="font-medium">{{ reply.intent.replace('_', ' ')|title if reply.intent else 'Unknown' }}</div>
                    </div>
                    <div>
                        <div class="text-gray-500">Urgency</div>
                        <div class="font-medium {{ 'text-red-600' if reply.urgency in ['high', 'critical'] else '' }}">
                            {{ reply.urgency|capitalize if reply.urgency else 'Low' }}
                        </div>
                    </div>
                    <div>
                        <div class="text-gray-500">Category</div>
                        <div class="font-medium">{{ reply.category|capitalize if reply.category else 'Uncategorized' }}</div>
                    </div>
                </div>
                {% if reply.ai_summary %}
                <div class="mt-3 p-2 bg-white rounded">
                    <div class="text-xs text-gray-500 mb-1">Summary</div>
                    <div class="text-sm">{{ reply.ai_summary }}</div>
                </div>
                {% endif %}
            </div>
            
            <!-- Body -->
            <div class="p-4 border-b">
                <div class="prose max-w-none">
                    {% if reply.body_html %}
                    {{ reply.body_html|safe }}
                    {% else %}
                    <pre class="whitespace-pre-wrap font-sans">{{ reply.body_text }}</pre>
                    {% endif %}
                </div>
            </div>
            
            <!-- Reply Form -->
            <div class="p-4">
                <h3 class="font-medium mb-3">Send Reply</h3>
                {% if reply.suggested_response %}
                <div class="mb-3 p-3 bg-blue-50 rounded-lg">
                    <div class="text-xs text-blue-600 mb-1"><i class="fas fa-lightbulb mr-1"></i>Suggested Response</div>
                    <div class="text-sm">{{ reply.suggested_response }}</div>
                    <button @click="useSuggestion('{{ reply.suggested_response }}')" class="text-blue-600 text-sm mt-2">Use this</button>
                </div>
                {% endif %}
                <textarea x-model="responseBody" rows="5" class="w-full px-3 py-2 border rounded-lg mb-3" placeholder="Type your response..."></textarea>
                <div class="flex justify-end gap-2">
                    <button class="px-4 py-2 border rounded-lg">Save Draft</button>
                    <button @click="sendResponse()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <i class="fas fa-paper-plane mr-2"></i>Send Reply
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function replyView() {
    return {
        replyId: '{{ reply.id }}',
        responseBody: '',
        
        useSuggestion(text) {
            this.responseBody = text;
        },
        
        async sendResponse() {
            if (!this.responseBody.trim()) {
                alert('Please enter a response');
                return;
            }
            
            const response = await fetch(`/dashboard/replies/api/${this.replyId}/send-response`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ body: this.responseBody })
            });
            
            const result = await response.json();
            if (result.success) {
                alert('Response sent!');
                window.location.href = '/dashboard/replies';
            } else {
                alert(result.error || 'Failed to send');
            }
        },
        
        async archiveReply() {
            await fetch(`/dashboard/replies/api/${this.replyId}/archive`, { method: 'POST' });
            window.location.href = '/dashboard/replies';
        },
        
        async markSpam() {
            await fetch(`/dashboard/replies/api/${this.replyId}/spam`, { method: 'POST' });
            window.location.href = '/dashboard/replies';
        }
    }
}
</script>
{% endblock %}
