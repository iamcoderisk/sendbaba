{% extends "dashboard/base.html" %}
{% block title %}{{ campaign.name }} - SendBaba{% endblock %}
{% block page_title %}Campaign Report{% endblock %}
{% block page_subtitle %}{{ campaign.name }}{% endblock %}

{% block extra_css %}
<style>
    .report-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }
    .header-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    .back-btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 10px;
        color: #6b7280;
        text-decoration: none;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .back-btn:hover {
        color: #F97316;
        background: #fff7ed;
    }
    .header-info h2 {
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 4px;
    }
    .header-info p {
        color: #6b7280;
        font-size: 14px;
    }
    .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        background: #d1fae5;
        color: #059669;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
    }
    .sent-date {
        color: #6b7280;
        font-size: 14px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }
    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .stat-value {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 4px;
    }
    .stat-value.blue { color: #3b82f6; }
    .stat-value.green { color: #10b981; }
    .stat-value.yellow { color: #f59e0b; }
    .stat-value.purple { color: #8b5cf6; }
    .stat-value.red { color: #ef4444; }
    .stat-value.orange { color: #F97316; }
    .stat-label {
        font-size: 12px;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .content-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    .tabs-nav {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
    }
    .tab-btn {
        padding: 16px 24px;
        background: transparent;
        border: none;
        font-weight: 600;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tab-btn:hover {
        color: #F97316;
        background: #fff7ed;
    }
    .tab-btn.active {
        color: #F97316;
    }
    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: #F97316;
        border-radius: 3px 3px 0 0;
    }
    
    .tab-content {
        display: none;
        padding: 24px;
    }
    .tab-content.active {
        display: block;
    }
    
    .filter-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 12px;
    }
    .filter-btns {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .filter-btn {
        padding: 8px 16px;
        background: #f3f4f6;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
    }
    .filter-btn:hover, .filter-btn.active {
        background: #F97316;
        color: white;
    }
    .btn-export {
        padding: 10px 20px;
        background: linear-gradient(135deg, #F97316, #EA580C);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 14px rgba(249, 115, 22, 0.3);
        transition: all 0.2s;
    }
    .btn-export:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4);
    }
    
    .recipients-table {
        width: 100%;
        border-collapse: collapse;
    }
    .recipients-table th {
        text-align: left;
        padding: 14px 16px;
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #e5e7eb;
    }
    .recipients-table td {
        padding: 16px;
        border-bottom: 1px solid #f3f4f6;
    }
    .recipients-table tr:hover {
        background: #fafafa;
    }
    .recipient-name {
        font-weight: 600;
        color: #1f2937;
    }
    .recipient-email {
        font-size: 13px;
        color: #6b7280;
    }
    .status-pill {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    .status-sent { background: #dbeafe; color: #2563eb; }
    .status-delivered { background: #d1fae5; color: #059669; }
    .status-opened { background: #fef3c7; color: #d97706; }
    .status-clicked { background: #ede9fe; color: #7c3aed; }
    .status-failed { background: #fee2e2; color: #dc2626; }
    .status-bounced { background: #fecaca; color: #b91c1c; }
    
    .timestamp {
        font-size: 13px;
        color: #6b7280;
    }
    .timestamp i {
        margin-right: 4px;
    }
    .timestamp.opened { color: #d97706; }
    .timestamp.clicked { color: #7c3aed; }
    
    .email-preview {
        max-width: 700px;
        margin: 0 auto;
        background: #f3f4f6;
        border-radius: 12px;
        padding: 24px;
    }
    .email-preview-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .details-list {
        max-width: 600px;
    }
    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 16px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .detail-row:last-child {
        border-bottom: none;
    }
    .detail-label {
        color: #6b7280;
    }
    .detail-value {
        font-weight: 600;
        color: #1f2937;
    }
    
    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        .report-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .recipients-table {
            font-size: 14px;
        }
        .recipients-table th, .recipients-table td {
            padding: 12px 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="report-header">
    <div class="header-left">
        <a href="/dashboard/campaigns" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="header-info">
            <h2>{{ campaign.name }}</h2>
            <p>{{ campaign.subject }}</p>
        </div>
    </div>
    <div class="header-right">
        <span class="status-badge">
            <i class="fas fa-check-circle"></i>
            {{ campaign.status|title }}
        </span>
        {% if campaign.sent_at %}
        <span class="sent-date">
            Sent {{ campaign.sent_at.strftime('%b %d, %Y at %I:%M %p') }}
        </span>
        {% endif %}
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value blue">{{ stats.total }}</div>
        <div class="stat-label">Total Sent</div>
    </div>
    <div class="stat-card">
        <div class="stat-value green">{{ stats.delivered }}</div>
        <div class="stat-label">Delivered</div>
    </div>
    <div class="stat-card">
        <div class="stat-value yellow">{{ stats.opens }}</div>
        <div class="stat-label">Opens</div>
    </div>
    <div class="stat-card">
        <div class="stat-value purple">{{ stats.clicks }}</div>
        <div class="stat-label">Clicks</div>
    </div>
    <div class="stat-card">
        <div class="stat-value orange">{{ stats.open_rate }}%</div>
        <div class="stat-label">Open Rate</div>
    </div>
    <div class="stat-card">
        <div class="stat-value purple">{{ stats.click_rate }}%</div>
        <div class="stat-label">Click Rate</div>
    </div>
    <div class="stat-card">
        <div class="stat-value red">{{ stats.failed + stats.bounced }}</div>
        <div class="stat-label">Failed</div>
    </div>
</div>

<div class="content-card">
    <div class="tabs-nav">
        <button class="tab-btn active" onclick="switchTab('recipients')">
            <i class="fas fa-users"></i> Recipients ({{ stats.total }})
        </button>
        <button class="tab-btn" onclick="switchTab('content')">
            <i class="fas fa-envelope"></i> Email Content
        </button>
        <button class="tab-btn" onclick="switchTab('details')">
            <i class="fas fa-info-circle"></i> Details
        </button>
    </div>

    <div id="tab-recipients" class="tab-content active">
        <div class="filter-bar">
            <div class="filter-btns">
                <button onclick="filterRecipients('all')" class="filter-btn active">All</button>
                <button onclick="filterRecipients('delivered')" class="filter-btn">Delivered</button>
                <button onclick="filterRecipients('opened')" class="filter-btn">Opened</button>
                <button onclick="filterRecipients('clicked')" class="filter-btn">Clicked</button>
                <button onclick="filterRecipients('failed')" class="filter-btn">Failed</button>
            </div>
            <button onclick="exportRecipients()" class="btn-export">
                <i class="fas fa-download"></i> Export CSV
            </button>
        </div>

        <table class="recipients-table">
            <thead>
                <tr>
                    <th>Recipient</th>
                    <th>Status</th>
                    <th>Sent</th>
                    <th>Opened</th>
                    <th>Clicked</th>
                </tr>
            </thead>
            <tbody>
                {% for r in recipients %}
                <tr>
                    <td>
                        <div class="recipient-name">{{ r.name or 'Unknown' }}</div>
                        <div class="recipient-email">{{ r.email }}</div>
                    </td>
                    <td>
                        <span class="status-pill status-{{ r.status }}">{{ r.status|title }}</span>
                    </td>
                    <td class="timestamp">
                        {{ r.sent_at.strftime('%b %d, %I:%M %p') if r.sent_at else '-' }}
                    </td>
                    <td>
                        {% if r.opened_at %}
                        <span class="timestamp opened">
                            <i class="fas fa-eye"></i>{{ r.opened_at.strftime('%b %d, %I:%M %p') }}
                        </span>
                        {% else %}
                        <span class="timestamp">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if r.clicked_at %}
                        <span class="timestamp clicked">
                            <i class="fas fa-mouse-pointer"></i>{{ r.clicked_at.strftime('%b %d, %I:%M %p') }}
                        </span>
                        {% else %}
                        <span class="timestamp">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="tab-content" class="tab-content">
        <div class="email-preview">
            <div class="email-preview-content">
                {{ campaign.html_content|safe }}
            </div>
        </div>
    </div>

    <div id="tab-details" class="tab-content">
        <div class="details-list">
            <div class="detail-row">
                <span class="detail-label">From Name</span>
                <span class="detail-value">{{ campaign.from_name or 'Not set' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">From Email</span>
                <span class="detail-value">{{ campaign.from_email or 'Not set' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Reply-To</span>
                <span class="detail-value">{{ campaign.reply_to or 'Same as from' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Subject</span>
                <span class="detail-value">{{ campaign.subject }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Preview Text</span>
                <span class="detail-value">{{ campaign.preview_text or 'None' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Created</span>
                <span class="detail-value">{{ campaign.created_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Sent</span>
                <span class="detail-value">{{ campaign.sent_at.strftime('%b %d, %Y at %I:%M %p') if campaign.sent_at else 'Not sent' }}</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.target.closest('.tab-btn').classList.add('active');
    document.getElementById('tab-' + tab).classList.add('active');
}

function filterRecipients(status) {
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    window.location.href = window.location.pathname + '?status=' + status;
}

function exportRecipients() {
    window.location.href = '/dashboard/campaigns/api/export/{{ campaign.id }}';
}
</script>
{% endblock %}
