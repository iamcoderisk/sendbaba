{% extends "dashboard/base.html" %}
{% block title %}Email Templates - SendBaba{% endblock %}
{% block page_title %}Email Templates{% endblock %}
{% block page_subtitle %}Choose from {{ templates|length }} professional templates{% endblock %}

{% block extra_css %}
<style>
/* Header */
.templates-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
}
.back-btn {
    color: #6b7280;
    text-decoration: none;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.back-btn:hover { color: #F97316; }

/* Search & Filter */
.filter-bar {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}
.search-box {
    position: relative;
}
.search-box input {
    padding: 12px 20px 12px 45px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 15px;
    width: 280px;
    transition: all 0.3s;
}
.search-box input:focus {
    outline: none;
    border-color: #F97316;
    box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
}
.search-box i {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
}

/* Category Pills */
.category-pills {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 30px;
}
.category-pill {
    padding: 10px 20px;
    border-radius: 50px;
    border: 2px solid #e5e7eb;
    background: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-transform: capitalize;
}
.category-pill:hover {
    border-color: #F97316;
    color: #F97316;
}
.category-pill.active {
    background: linear-gradient(135deg, #F97316, #EA580C);
    border-color: #F97316;
    color: white;
}

/* Templates Grid */
.templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 24px;
}
.template-card {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}
.template-card:hover {
    border-color: #F97316;
    box-shadow: 0 12px 40px rgba(249,115,22,0.15);
    transform: translateY(-4px);
}
.template-card.hidden { display: none; }

/* Preview Area */
.template-preview {
    height: 200px;
    background: #f3f4f6;
    position: relative;
    overflow: hidden;
}
.template-preview iframe {
    width: 200%;
    height: 400px;
    transform: scale(0.5);
    transform-origin: top left;
    pointer-events: none;
    border: none;
}
.template-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, transparent 60%, rgba(0,0,0,0.6));
    opacity: 0;
    transition: opacity 0.3s;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 20px;
}
.template-card:hover .template-overlay { opacity: 1; }
.preview-btn {
    background: white;
    color: #111;
    padding: 10px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}
.preview-btn:hover {
    background: #F97316;
    color: white;
}

/* Template Info */
.template-info {
    padding: 20px;
}
.template-category {
    display: inline-block;
    background: #FFF7ED;
    color: #EA580C;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 10px;
}
.template-name {
    font-size: 18px;
    font-weight: 700;
    color: #111;
    margin-bottom: 6px;
}
.template-desc {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 15px;
}
.template-actions {
    display: flex;
    gap: 10px;
}
.btn-use {
    flex: 1;
    background: linear-gradient(135deg, #F97316, #EA580C);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 600;
    text-align: center;
    text-decoration: none;
    transition: all 0.3s;
}
.btn-use:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 15px rgba(249,115,22,0.4);
}
.btn-preview-small {
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    background: white;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.3s;
}
.btn-preview-small:hover {
    border-color: #F97316;
    color: #F97316;
}

/* Modal */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 40px;
}
.modal-overlay.active { display: flex; }
.modal-content {
    background: white;
    border-radius: 20px;
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.modal-header {
    padding: 20px 30px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.modal-title {
    font-size: 20px;
    font-weight: 700;
}
.modal-close {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: none;
    background: #f3f4f6;
    cursor: pointer;
    font-size: 20px;
    transition: all 0.2s;
}
.modal-close:hover {
    background: #fee2e2;
    color: #ef4444;
}
.modal-body {
    flex: 1;
    overflow: auto;
    padding: 0;
}
.modal-body iframe {
    width: 100%;
    height: 500px;
    border: none;
}
.modal-footer {
    padding: 20px 30px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6b7280;
}
.empty-state i {
    font-size: 48px;
    margin-bottom: 20px;
    color: #d1d5db;
}

/* Stats */
.stats-bar {
    display: flex;
    gap: 30px;
    margin-bottom: 30px;
    padding: 20px 30px;
    background: linear-gradient(135deg, #FFF7ED, #FFEDD5);
    border-radius: 16px;
}
.stat-item {
    text-align: center;
}
.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #EA580C;
}
.stat-label {
    font-size: 13px;
    color: #92400E;
}

@media (max-width: 768px) {
    .templates-grid { grid-template-columns: 1fr; }
    .filter-bar { width: 100%; }
    .search-box input { width: 100%; }
}
</style>
{% endblock %}

{% block content %}
<div class="templates-header">
    <a href="{{ url_for('campaigns.list_campaigns') }}" class="back-btn">
        <i class="fas fa-arrow-left"></i> Back to Campaigns
    </a>
    <div class="filter-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search templates..." onkeyup="filterTemplates()">
        </div>
    </div>
</div>

<div class="stats-bar">
    <div class="stat-item">
        <div class="stat-value">{{ templates|length }}</div>
        <div class="stat-label">Templates</div>
    </div>
    <div class="stat-item">
        <div class="stat-value">{{ categories|length }}</div>
        <div class="stat-label">Categories</div>
    </div>
    <div class="stat-item">
        <div class="stat-value">100%</div>
        <div class="stat-label">Responsive</div>
    </div>
</div>

<div class="category-pills">
    <button class="category-pill active" onclick="filterByCategory('all')">All</button>
    {% for cat in categories %}
    <button class="category-pill" onclick="filterByCategory('{{ cat }}')">{{ cat|replace('_', ' ') }}</button>
    {% endfor %}
</div>

<div class="templates-grid">
    <!-- Blank Template -->
    <div class="template-card" data-category="blank" data-name="blank">
        <div class="template-preview" style="background: linear-gradient(135deg, #e5e7eb, #d1d5db); display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-plus" style="font-size: 48px; color: #9ca3af;"></i>
        </div>
        <div class="template-info">
            <span class="template-category">Start Fresh</span>
            <h3 class="template-name">Blank Canvas</h3>
            <p class="template-desc">Start from scratch with a blank template</p>
            <div class="template-actions">
                <a href="{{ url_for('campaigns.design_campaign', template_id='blank') }}" class="btn-use">
                    <i class="fas fa-plus"></i> Start Blank
                </a>
            </div>
        </div>
    </div>

    {% for template in templates %}
    <div class="template-card" data-category="{{ template.category }}" data-name="{{ template.name|lower }}">
        <div class="template-preview">
            <iframe srcdoc="{{ template.html_content|e }}" sandbox="allow-same-origin"></iframe>
            <div class="template-overlay">
                <button class="preview-btn" onclick="openPreview('{{ template.id }}', '{{ template.name|e }}')">
                    <i class="fas fa-eye"></i> Preview
                </button>
            </div>
        </div>
        <div class="template-info">
            <span class="template-category">{{ template.category|replace('_', ' ') }}</span>
            <h3 class="template-name">{{ template.name }}</h3>
            <p class="template-desc">{{ template.description or template.subject }}</p>
            <div class="template-actions">
                <a href="{{ url_for('campaigns.design_campaign', template_id=template.id) }}" class="btn-use">
                    Use Template
                </a>
                <button class="btn-preview-small" onclick="openPreview('{{ template.id }}', '{{ template.name|e }}')">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if not templates %}
<div class="empty-state">
    <i class="fas fa-inbox"></i>
    <h3>No templates found</h3>
    <p>Templates will appear here once added to the database</p>
</div>
{% endif %}

<!-- Preview Modal -->
<div class="modal-overlay" id="previewModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Template Preview</h3>
            <button class="modal-close" onclick="closePreview()">&times;</button>
        </div>
        <div class="modal-body">
            <iframe id="previewFrame" srcdoc=""></iframe>
        </div>
        <div class="modal-footer">
            <button onclick="closePreview()" style="padding: 12px 24px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; cursor: pointer;">Cancel</button>
            <a href="#" id="useTemplateBtn" class="btn-use" style="text-decoration: none;">Use This Template</a>
        </div>
    </div>
</div>

<script>
const templates = {{ templates|tojson|safe }};

function filterByCategory(category) {
    document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
    event.target.classList.add('active');
    
    document.querySelectorAll('.template-card').forEach(card => {
        const cardCat = card.dataset.category;
        if (category === 'all' || cardCat === category || cardCat === 'blank') {
            card.classList.remove('hidden');
        } else {
            card.classList.add('hidden');
        }
    });
}

function filterTemplates() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.template-card').forEach(card => {
        const name = card.dataset.name;
        const category = card.dataset.category;
        if (name.includes(search) || category.includes(search)) {
            card.classList.remove('hidden');
        } else {
            card.classList.add('hidden');
        }
    });
}

function openPreview(templateId, templateName) {
    const template = templates.find(t => t.id == templateId);
    if (template) {
        document.getElementById('modalTitle').textContent = templateName;
        document.getElementById('previewFrame').srcdoc = template.html_content;
        document.getElementById('useTemplateBtn').href = '/dashboard/campaigns/design/' + templateId;
        document.getElementById('previewModal').classList.add('active');
    }
}

function closePreview() {
    document.getElementById('previewModal').classList.remove('active');
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closePreview();
});

document.getElementById('previewModal').addEventListener('click', (e) => {
    if (e.target.id === 'previewModal') closePreview();
});
</script>
{% endblock %}
