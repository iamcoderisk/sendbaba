{% extends "dashboard/base.html" %}
{% block title %}Send Campaign - {{ campaign.name }}{% endblock %}

{% block extra_css %}
<style>
.send-container { max-width: 800px; margin: 0 auto; padding: 20px; }
.card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 24px; margin-bottom: 20px; }
.card-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
.card-title i { color: #F97316; }
.summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
.summary-item { padding: 12px; background: #f8fafc; border-radius: 8px; }
.summary-label { font-size: 12px; color: #64748b; margin-bottom: 4px; }
.summary-value { font-size: 14px; font-weight: 500; color: #1e293b; word-break: break-all; }
.recipient-option { padding: 16px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; margin-bottom: 10px; transition: all 0.2s; }
.recipient-option:hover { border-color: #F97316; background: #fff7ed; }
.recipient-option.selected { border-color: #F97316; background: #fff7ed; }
.recipient-option input { display: none; }
.option-header { display: flex; justify-content: space-between; align-items: center; }
.option-title { font-weight: 600; font-size: 15px; }
.option-count { background: #F97316; color: white; padding: 4px 10px; border-radius: 20px; font-size: 13px; }
.option-desc { font-size: 13px; color: #64748b; margin-top: 6px; }
.btn-row { display: flex; gap: 12px; margin-top: 24px; }
.btn { padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; }
.btn-back { background: #f1f5f9; color: #475569; }
.btn-back:hover { background: #e2e8f0; }
.btn-send { background: #F97316; color: white; flex: 1; justify-content: center; }
.btn-send:hover { background: #ea580c; }
.btn-send:disabled { background: #fed7aa; cursor: not-allowed; }
.warning { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
.warning i { color: #f59e0b; }
.preview-box { background: #f8fafc; border-radius: 8px; padding: 16px; margin-top: 16px; max-height: 200px; overflow: auto; }
.toast { position: fixed; bottom: 20px; right: 20px; background: #1e293b; color: white; padding: 12px 20px; border-radius: 8px; display: none; z-index: 1000; }
.toast.success { background: #10b981; }
.toast.error { background: #ef4444; }
.toast.show { display: block; animation: slideUp 0.3s ease; }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.sending-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
.sending-overlay.show { display: flex; }
.sending-box { background: white; padding: 40px; border-radius: 12px; text-align: center; }
.sending-box i { font-size: 48px; color: #F97316; margin-bottom: 16px; }
.sending-box h3 { margin-bottom: 8px; }
</style>
{% endblock %}

{% block content %}
<div class="send-container">
    <div class="card">
        <div class="card-title"><i class="fas fa-envelope"></i> Campaign Summary</div>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-label">Campaign Name</div>
                <div class="summary-value">{{ campaign.name }}</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Subject Line</div>
                <div class="summary-value">{{ campaign.subject or 'Not set' }}</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">From</div>
                <div class="summary-value">{{ campaign.from_name }} &lt;{{ campaign.from_email }}&gt;</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Reply To</div>
                <div class="summary-value">{{ campaign.reply_to or campaign.from_email }}</div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-title"><i class="fas fa-users"></i> Select Recipients</div>
        
        {% if contacts_count == 0 %}
        <div class="warning">
            <i class="fas fa-exclamation-triangle"></i>
            <span>You have no contacts yet. <a href="{{ url_for('contacts.list_contacts') }}">Import contacts</a> first.</span>
        </div>
        {% else %}
        
        <label class="recipient-option selected" onclick="selectOption(this)">
            <input type="radio" name="recipients" value="all" checked>
            <div class="option-header">
                <span class="option-title"><i class="fas fa-users"></i> All Contacts</span>
                <span class="option-count">{{ "{:,}".format(contacts_count) }}</span>
            </div>
            <div class="option-desc">Send to all active contacts in your list</div>
        </label>
        
        {% for segment in segments %}
        <label class="recipient-option" onclick="selectOption(this)">
            <input type="radio" name="recipients" value="segment_{{ segment.id }}">
            <div class="option-header">
                <span class="option-title"><i class="fas fa-filter"></i> {{ segment.name }}</span>
                <span class="option-count">{{ "{:,}".format(segment.count) }}</span>
            </div>
            <div class="option-desc">Send to this segment only</div>
        </label>
        {% endfor %}
        
        {% endif %}
    </div>
    
    <div class="btn-row">
        <a href="{{ url_for('campaigns.design_campaign') }}?campaign_id={{ campaign.id }}" class="btn btn-back">
            <i class="fas fa-arrow-left"></i> Back to Editor
        </a>
        <button class="btn btn-send" onclick="sendCampaign()" {% if contacts_count == 0 %}disabled{% endif %}>
            <i class="fas fa-paper-plane"></i> Send Campaign to {{ "{:,}".format(contacts_count) }} Contacts
        </button>
    </div>
</div>

<div class="sending-overlay" id="sendingOverlay">
    <div class="sending-box">
        <i class="fas fa-spinner fa-spin"></i>
        <h3>Sending Campaign...</h3>
        <p>Please wait while we queue your emails</p>
    </div>
</div>

<div class="toast" id="toast"></div>
{% endblock %}

{% block extra_js %}
<script>
const campaignId = '{{ campaign.id }}';

function selectOption(el) {
    document.querySelectorAll('.recipient-option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    el.querySelector('input').checked = true;
}

function toast(msg, type='success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + type + ' show';
    setTimeout(() => t.classList.remove('show'), 4000);
}

async function sendCampaign() {
    document.getElementById('sendingOverlay').classList.add('show');
    
    try {
        const resp = await fetch('/dashboard/campaigns/api/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ campaign_id: campaignId })
        });
        
        const data = await resp.json();
        document.getElementById('sendingOverlay').classList.remove('show');
        
        if (data.success) {
            toast(data.message || 'Campaign sent successfully!', 'success');
            setTimeout(() => {
                window.location.href = '/dashboard/campaigns';
            }, 2000);
        } else {
            toast(data.error || 'Failed to send campaign', 'error');
        }
    } catch (e) {
        document.getElementById('sendingOverlay').classList.remove('show');
        toast('Error sending campaign: ' + e.message, 'error');
    }
}
</script>
{% endblock %}
