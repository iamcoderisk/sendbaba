{% extends "dashboard/base.html" %}
{% block title %}Email Designer - {{ campaign_name }}{% endblock %}
{% block page_title %}{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary: #F97316;
    --primary-dark: #EA580C;
    --primary-light: #FFF7ED;
    --sidebar-w: 290px;
    --props-w: 260px;
    --header-h: 52px;
    --text-dark: #1e293b;
    --text-muted: #64748b;
    --border: #e2e8f0;
    --bg-light: #f8fafc;
    --success: #10B981;
    --error: #EF4444;
    --warning: #F59E0B;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow: hidden; font-size: 13px; }

.editor { display: flex; height: 100vh; background: #e5e7eb; }

/* === SIDEBAR === */
.sidebar {
    width: var(--sidebar-w);
    background: white;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
}

.side-header {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
}
.side-header a { color: var(--text-muted); font-size: 14px; }
.side-header a:hover { color: var(--primary); }
.side-header h2 { font-size: 14px; font-weight: 600; }

.side-tabs { display: flex; border-bottom: 1px solid var(--border); }
.side-tab {
    flex: 1;
    padding: 8px 4px;
    text-align: center;
    font-size: 10px;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
}
.side-tab i { display: block; font-size: 14px; margin-bottom: 2px; }
.side-tab:hover { color: var(--primary); }
.side-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

.side-body { flex: 1; overflow-y: auto; padding: 12px; }

/* Form */
.sec { margin-bottom: 16px; }
.sec-title { font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
.sec-title i { color: var(--primary); font-size: 11px; }
.fg { margin-bottom: 10px; }
.fl { display: block; font-size: 11px; font-weight: 500; color: var(--text-dark); margin-bottom: 3px; }
.fl .req { color: var(--error); }
.fi {
    width: 100%;
    padding: 7px 9px;
    border: 1px solid var(--border);
    border-radius: 5px;
    font-size: 12px;
}
.fi:focus { outline: none; border-color: var(--primary); }
.fi-select {
    appearance: none;
    background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E") no-repeat right 8px center;
    padding-right: 26px;
}
.hint { font-size: 10px; color: var(--text-muted); margin-top: 2px; }

.color-pick { display: flex; gap: 6px; align-items: center; }
.color-pick input[type="color"] { width: 28px; height: 28px; border: 1px solid var(--border); border-radius: 4px; padding: 1px; cursor: pointer; }
.color-pick input[type="text"] { flex: 1; }

/* Blocks */
.blocks { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
.blk {
    background: var(--bg-light);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 4px;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s;
}
.blk:hover { border-color: var(--primary); background: var(--primary-light); transform: translateY(-1px); }
.blk i { font-size: 16px; color: var(--primary); display: block; margin-bottom: 3px; }
.blk span { font-size: 9px; font-weight: 500; }

/* Layers */
.layers { display: flex; flex-direction: column; gap: 5px; }
.layer {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    background: var(--bg-light);
    border: 1px solid var(--border);
    border-radius: 5px;
    cursor: pointer;
    font-size: 11px;
}
.layer:hover { border-color: var(--primary); }
.layer.active { background: var(--primary-light); border-color: var(--primary); }
.layer i { color: var(--primary); font-size: 12px; }
.layer .info { flex: 1; }
.layer .name { font-weight: 500; }
.layer .meta { font-size: 9px; color: var(--text-muted); }
.layer .acts { display: flex; gap: 2px; opacity: 0; }
.layer:hover .acts { opacity: 1; }
.layer .acts button { background: none; border: none; padding: 3px; cursor: pointer; font-size: 10px; color: var(--text-muted); border-radius: 3px; }
.layer .acts button:hover { background: white; color: var(--primary); }

.add-sec {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    padding: 10px;
    border: 2px dashed var(--border);
    border-radius: 5px;
    color: var(--text-muted);
    font-size: 11px;
    cursor: pointer;
    margin-top: 8px;
}
.add-sec:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

.test-btn {
    width: 100%;
    padding: 8px;
    background: var(--bg-light);
    border: 1px solid var(--border);
    border-radius: 5px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    margin-top: 6px;
}
.test-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

/* === CANVAS === */
.canvas-wrap { flex: 1; display: flex; flex-direction: column; min-width: 0; }

.canvas-head {
    height: var(--header-h);
    background: white;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 12px;
}
.canvas-head-l, .canvas-head-r { display: flex; align-items: center; gap: 6px; }

.dev-btns { display: flex; background: var(--bg-light); border-radius: 5px; padding: 2px; }
.dev-btns button { background: none; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; color: var(--text-muted); font-size: 12px; }
.dev-btns button.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.08); }

.status { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
.status.saved { color: var(--success); }
.status.dirty { color: var(--warning); }

.btn { padding: 6px 12px; border-radius: 5px; font-size: 12px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; border: none; }
.btn-ghost { background: transparent; color: var(--text-muted); }
.btn-ghost:hover { background: var(--bg-light); }
.btn-out { background: white; border: 1px solid var(--border); color: var(--text-dark); }
.btn-out:hover { background: var(--bg-light); }
.btn-pri { background: var(--primary); color: white; }
.btn-pri:hover { background: var(--primary-dark); }

.canvas-body { flex: 1; overflow: auto; padding: 20px; display: flex; justify-content: center; }
.canvas-frame { width: 620px; transition: width 0.3s; }
.canvas-frame.mobile { width: 360px; }
.canvas-content { background: white; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-height: 350px; overflow: hidden; }

/* Email Elements */
.e-sec { position: relative; border: 2px solid transparent; transition: border-color 0.15s; }
.e-sec:hover { border-color: rgba(249,115,22,0.4); }
.e-sec.sel { border-color: var(--primary); }

.sec-bar { position: absolute; top: -26px; left: 50%; transform: translateX(-50%); background: #1e293b; border-radius: 4px; padding: 2px; display: none; gap: 1px; z-index: 10; }
.e-sec:hover .sec-bar, .e-sec.sel .sec-bar { display: flex; }
.sec-bar button { background: none; border: none; color: rgba(255,255,255,0.7); padding: 3px 5px; cursor: pointer; border-radius: 2px; font-size: 9px; }
.sec-bar button:hover { background: rgba(255,255,255,0.1); color: white; }

.e-el { position: relative; border: 2px solid transparent; transition: border-color 0.15s; }
.e-el:hover { border-color: rgba(99,102,241,0.4); }
.e-el.sel { border-color: #6366F1; }

.el-bar { position: absolute; top: -22px; right: 2px; background: #6366F1; border-radius: 3px; padding: 2px; display: none; gap: 1px; z-index: 10; }
.e-el:hover .el-bar, .e-el.sel .el-bar { display: flex; }
.el-bar button { background: none; border: none; color: white; padding: 2px 4px; cursor: pointer; border-radius: 2px; font-size: 8px; }
.el-bar button:hover { background: rgba(255,255,255,0.2); }

.empty-c { padding: 50px 30px; text-align: center; color: var(--text-muted); }
.empty-c i { font-size: 36px; opacity: 0.3; margin-bottom: 10px; }
.empty-c h3 { font-size: 15px; color: var(--text-dark); margin-bottom: 5px; }
.empty-c p { font-size: 12px; margin-bottom: 12px; }

.drop-z { padding: 20px; text-align: center; color: var(--text-muted); font-size: 11px; border: 2px dashed var(--border); border-radius: 5px; margin: 10px; }
.e-sec.drag-over .drop-z { border-color: var(--primary); background: var(--primary-light); }

/* === PROPS === */
.props {
    width: var(--props-w);
    background: white;
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
}
.props-head { padding: 10px 12px; border-bottom: 1px solid var(--border); }
.props-head h3 { font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
.props-head h3 i { color: var(--primary); }
.props-body { flex: 1; overflow-y: auto; padding: 12px; }

.pg { margin-bottom: 14px; border-bottom: 1px solid var(--border); padding-bottom: 14px; }
.pg:last-child { border-bottom: none; }
.pg-title { font-size: 9px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
.pr { margin-bottom: 8px; }
.pr:last-child { margin-bottom: 0; }
.pl { font-size: 10px; font-weight: 500; color: var(--text-dark); margin-bottom: 3px; display: block; }
.pi { width: 100%; padding: 5px 7px; border: 1px solid var(--border); border-radius: 4px; font-size: 11px; }
.pi:focus { outline: none; border-color: var(--primary); }
.pi-ta { min-height: 50px; resize: vertical; font-family: inherit; }
.pi-sel { appearance: none; background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E") no-repeat right 6px center; padding-right: 22px; }
.pi-clr { display: flex; gap: 5px; align-items: center; }
.pi-clr input[type="color"] { width: 24px; height: 24px; border: 1px solid var(--border); border-radius: 3px; padding: 1px; cursor: pointer; }
.pi-clr input[type="text"] { flex: 1; }
.pr-row { display: flex; gap: 6px; }
.pr-row > div { flex: 1; }

.empty-p { text-align: center; padding: 30px 15px; color: var(--text-muted); }
.empty-p i { font-size: 28px; opacity: 0.3; margin-bottom: 8px; display: block; }
.empty-p h4 { font-size: 12px; color: var(--text-dark); margin-bottom: 3px; }
.empty-p p { font-size: 10px; }

/* Toast */
.toast-wrap { position: fixed; bottom: 14px; right: 14px; z-index: 9999; }
.toast { background: #1e293b; color: white; padding: 8px 14px; border-radius: 5px; font-size: 12px; display: flex; align-items: center; gap: 6px; margin-top: 6px; animation: slideUp 0.3s ease; }
.toast.success { background: var(--success); }
.toast.error { background: var(--error); }
@keyframes slideUp { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* Modal */
.modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
.modal-bg.show { display: flex; }
.modal-box { background: white; border-radius: 8px; max-width: 650px; width: 95%; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
.modal-top { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.modal-top h3 { font-size: 14px; }
.modal-close { background: none; border: none; font-size: 18px; cursor: pointer; color: var(--text-muted); }
.modal-cnt { flex: 1; overflow: auto; padding: 16px; }
.prev-frame { width: 100%; min-height: 450px; border: 1px solid var(--border); border-radius: 5px; }
</style>
{% endblock %}

{% block content %}
<div class="editor">
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="side-header">
            <a href="{{ url_for('campaigns.list_campaigns') }}" title="Back"><i class="fas fa-arrow-left"></i></a>
            <h2>Email Designer</h2>
        </div>
        
        <div class="side-tabs">
            <div class="side-tab active" data-t="settings"><i class="fas fa-cog"></i>Settings</div>
            <div class="side-tab" data-t="blocks"><i class="fas fa-th-large"></i>Blocks</div>
            <div class="side-tab" data-t="layers"><i class="fas fa-layer-group"></i>Layers</div>
        </div>
        
        <div class="side-body">
            <!-- SETTINGS -->
            <div class="pane" id="settingsPane">
                <div class="sec">
                    <div class="sec-title"><i class="fas fa-file-alt"></i> Campaign</div>
                    <div class="fg">
                        <label class="fl">Name <span class="req">*</span></label>
                        <input type="text" class="fi" id="inpName" value="{{ campaign_name }}" placeholder="Campaign name">
                    </div>
                    <div class="fg">
                        <label class="fl">Subject <span class="req">*</span></label>
                        <input type="text" class="fi" id="inpSubject" value="{{ campaign_subject }}" placeholder="Email subject line">
                    </div>
                    <div class="fg">
                        <label class="fl">Preview Text</label>
                        <input type="text" class="fi" id="inpPreview" value="{{ campaign_preview_text }}" placeholder="Shows in inbox preview">
                    </div>
                </div>
                
                <div class="sec">
                    <div class="sec-title"><i class="fas fa-user"></i> Sender</div>
                    <div class="fg">
                        <label class="fl">From Name <span class="req">*</span></label>
                        <input type="text" class="fi" id="inpFromName" value="{{ campaign_from_name }}" placeholder="Your Name">
                    </div>
                    <div class="fg">
                        <label class="fl">From Email <span class="req">*</span></label>
                        <select class="fi fi-select" id="inpFromEmail">
                            <option value="">Select verified email...</option>
                            {% if domains %}
                                {% for d in domains %}
                                <option value="noreply@{{ d.domain }}" {% if campaign_from_email == 'noreply@' ~ d.domain %}selected{% endif %}>noreply@{{ d.domain }}</option>
                                <option value="hello@{{ d.domain }}" {% if campaign_from_email == 'hello@' ~ d.domain %}selected{% endif %}>hello@{{ d.domain }}</option>
                                <option value="info@{{ d.domain }}" {% if campaign_from_email == 'info@' ~ d.domain %}selected{% endif %}>info@{{ d.domain }}</option>
                                <option value="marketing@{{ d.domain }}" {% if campaign_from_email == 'marketing@' ~ d.domain %}selected{% endif %}>marketing@{{ d.domain }}</option>
                                <option value="news@{{ d.domain }}" {% if campaign_from_email == 'news@' ~ d.domain %}selected{% endif %}>news@{{ d.domain }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="" disabled>No verified domains - add one in Settings</option>
                            {% endif %}
                        </select>
                        {% if not domains %}
                        <div class="hint" style="color:var(--warning);">⚠️ No verified domains. <a href="{{ url_for('domain.list_domains') }}">Add domain</a></div>
                        {% endif %}
                    </div>
                    <div class="fg">
                        <label class="fl">Reply-To</label>
                        <input type="email" class="fi" id="inpReplyTo" value="{{ campaign_reply_to }}" placeholder="replies@company.com">
                    </div>
                </div>
                
                <div class="sec">
                    <div class="sec-title"><i class="fas fa-palette"></i> Styles</div>
                    <div class="fg">
                        <label class="fl">Background</label>
                        <div class="color-pick">
                            <input type="color" id="sBg" value="#f4f4f5">
                            <input type="text" class="fi" id="sBgT" value="#f4f4f5">
                        </div>
                    </div>
                    <div class="fg">
                        <label class="fl">Content BG</label>
                        <div class="color-pick">
                            <input type="color" id="sCon" value="#ffffff">
                            <input type="text" class="fi" id="sConT" value="#ffffff">
                        </div>
                    </div>
                    <div class="fg">
                        <label class="fl">Button Color</label>
                        <div class="color-pick">
                            <input type="color" id="sBtn" value="#F97316">
                            <input type="text" class="fi" id="sBtnT" value="#F97316">
                        </div>
                    </div>
                </div>
                
                <div class="sec">
                    <div class="sec-title"><i class="fas fa-paper-plane"></i> Test</div>
                    <div class="fg">
                        <label class="fl">Test Email</label>
                        <input type="email" class="fi" id="inpTest" placeholder="your@email.com">
                    </div>
                    <button class="test-btn" onclick="sendTest()"><i class="fas fa-paper-plane"></i> Send Test</button>
                </div>
            </div>
            
            <!-- BLOCKS -->
            <div class="pane" id="blocksPane" style="display:none;">
                <div class="sec-title"><i class="fas fa-th-large"></i> Drag or Click to Add</div>
                <div class="blocks">
                    <div class="blk" data-type="heading" draggable="true"><i class="fas fa-heading"></i><span>Heading</span></div>
                    <div class="blk" data-type="text" draggable="true"><i class="fas fa-align-left"></i><span>Text</span></div>
                    <div class="blk" data-type="image" draggable="true"><i class="fas fa-image"></i><span>Image</span></div>
                    <div class="blk" data-type="button" draggable="true"><i class="fas fa-square"></i><span>Button</span></div>
                    <div class="blk" data-type="divider" draggable="true"><i class="fas fa-minus"></i><span>Divider</span></div>
                    <div class="blk" data-type="spacer" draggable="true"><i class="fas fa-arrows-alt-v"></i><span>Spacer</span></div>
                    <div class="blk" data-type="logo" draggable="true"><i class="fas fa-star"></i><span>Logo</span></div>
                    <div class="blk" data-type="social" draggable="true"><i class="fas fa-share-alt"></i><span>Social</span></div>
                    <div class="blk" data-type="html" draggable="true"><i class="fas fa-code"></i><span>HTML</span></div>
                    <div class="blk" data-type="footer" draggable="true"><i class="fas fa-shoe-prints"></i><span>Footer</span></div>
                </div>
            </div>
            
            <!-- LAYERS -->
            <div class="pane" id="layersPane" style="display:none;">
                <div class="sec-title"><i class="fas fa-layer-group"></i> Sections</div>
                <div class="layers" id="layerList"></div>
                <div class="add-sec" onclick="addSec()"><i class="fas fa-plus"></i> Add Section</div>
            </div>
        </div>
    </div>
    
    <!-- CANVAS -->
    <div class="canvas-wrap">
        <div class="canvas-head">
            <div class="canvas-head-l">
                <div class="dev-btns">
                    <button class="active" onclick="setDev('desktop')"><i class="fas fa-desktop"></i></button>
                    <button onclick="setDev('mobile')"><i class="fas fa-mobile-alt"></i></button>
                </div>
            </div>
            <div class="canvas-head-r">
                <div class="status" id="status"><i class="fas fa-check-circle"></i> Saved</div>
                <button class="btn btn-ghost" onclick="undo()" title="Ctrl+Z"><i class="fas fa-undo"></i></button>
                <button class="btn btn-ghost" onclick="redo()" title="Ctrl+Y"><i class="fas fa-redo"></i></button>
                <button class="btn btn-out" onclick="preview()"><i class="fas fa-eye"></i> Preview</button>
                <button class="btn btn-out" onclick="save()"><i class="fas fa-save"></i> Save</button>
                <button class="btn btn-pri" onclick="proceed()">Continue <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
        <div class="canvas-body">
            <div class="canvas-frame" id="frame">
                <div class="canvas-content" id="canvas"></div>
            </div>
        </div>
    </div>
    
    <!-- PROPS -->
    <div class="props">
        <div class="props-head"><h3 id="pTitle"><i class="fas fa-sliders-h"></i> Properties</h3></div>
        <div class="props-body" id="pBody">
            <div class="empty-p"><i class="fas fa-mouse-pointer"></i><h4>No Selection</h4><p>Click any element to edit</p></div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal-bg" id="modal">
    <div class="modal-box">
        <div class="modal-top"><h3><i class="fas fa-eye"></i> Preview</h3><button class="modal-close" onclick="closeModal()">&times;</button></div>
        <div class="modal-cnt"><iframe id="prevFrame" class="prev-frame"></iframe></div>
    </div>
</div>

<!-- Toast -->
<div class="toast-wrap" id="toasts"></div>
{% endblock %}

{% block extra_js %}
<script>
const D={data:null,selSec:null,selEl:null,dirty:!1,cid:'{{campaign_id}}',tid:'{{template_id}}',hist:[],hIdx:-1};
const DEF={globalStyles:{backgroundColor:'#f4f4f5',contentBackgroundColor:'#ffffff',fontFamily:'Arial,sans-serif',maxWidth:'620px',defaultButtonColor:'#F97316'},sections:[]};

document.addEventListener('DOMContentLoaded',async()=>{initTabs();initClr();initBlk();await loadTpl();render();updLayers();saveHist();});

async function loadTpl(){
    if(D.tid&&D.tid!=='blank'){
        try{
            const r=await fetch(`/dashboard/campaigns/api/template/${D.tid}`);
            if(r.ok){const d=await r.json();console.log('Loaded:',d);if(d.json_data){D.data=typeof d.json_data==='string'?JSON.parse(d.json_data):d.json_data;toast('Template loaded','success');syncClr();return;}}
        }catch(e){console.error(e);}
    }
    D.data=JSON.parse(JSON.stringify(DEF));
}

function syncClr(){const g=D.data?.globalStyles||{};setClr('sBg',g.backgroundColor||'#f4f4f5');setClr('sCon',g.contentBackgroundColor||'#ffffff');setClr('sBtn',g.defaultButtonColor||'#F97316');}
function setClr(id,v){document.getElementById(id).value=v;document.getElementById(id+'T').value=v;}

function initTabs(){document.querySelectorAll('.side-tab').forEach(t=>{t.onclick=()=>{document.querySelectorAll('.side-tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.querySelectorAll('.pane').forEach(p=>p.style.display='none');document.getElementById(t.dataset.t+'Pane').style.display='block';};});}

function initClr(){['sBg','sCon','sBtn'].forEach(id=>{const c=document.getElementById(id),t=document.getElementById(id+'T');c.oninput=()=>{t.value=c.value;updGStyle(id,c.value);};t.oninput=()=>{if(/^#[0-9A-Fa-f]{6}$/.test(t.value)){c.value=t.value;updGStyle(id,t.value);}};});}
function updGStyle(id,v){if(!D.data.globalStyles)D.data.globalStyles={};const m={sBg:'backgroundColor',sCon:'contentBackgroundColor',sBtn:'defaultButtonColor'};D.data.globalStyles[m[id]]=v;dirty();render();}

function initBlk(){document.querySelectorAll('.blk').forEach(b=>{b.onclick=()=>addBlk(b.dataset.type);b.ondragstart=e=>e.dataTransfer.setData('type',b.dataset.type);});}
function addBlk(type){let sid=D.selSec;if(!sid&&D.data.sections?.length)sid=D.data.sections[D.data.sections.length-1].id;if(!sid){addSec();sid=D.selSec;}addEl(sid,type);}

function render(){
    const c=document.getElementById('canvas'),g=D.data?.globalStyles||{};
    if(!D.data?.sections?.length){c.innerHTML=`<div class="empty-c"><i class="fas fa-plus-circle"></i><h3>Start Building</h3><p>Add sections and blocks</p><button class="btn btn-pri" onclick="addSec()"><i class="fas fa-plus"></i> Add Section</button></div>`;c.style.background=g.contentBackgroundColor||'#fff';return;}
    let h=`<div style="background:${g.backgroundColor||'#f4f4f5'};padding:16px;"><div style="max-width:${g.maxWidth||'620px'};margin:0 auto;background:${g.contentBackgroundColor||'#fff'};border-radius:6px;overflow:hidden;font-family:${g.fontFamily||'Arial,sans-serif'};">`;
    D.data.sections.forEach((s,i)=>h+=renderSec(s,i));
    h+='</div></div>';c.innerHTML=h;
}

function renderSec(s,i){
    const st=css(s.style||{}),sel=D.selSec===s.id;
    let h=`<div class="e-sec ${sel?'sel':''}" data-sid="${s.id}" style="${st}" onclick="selSec('${s.id}',event)" ondragover="dragO(event)" ondrop="drop(event,'${s.id}')">`;
    h+=`<div class="sec-bar"><button onclick="mvSecUp('${s.id}',event)"><i class="fas fa-arrow-up"></i></button><button onclick="mvSecDn('${s.id}',event)"><i class="fas fa-arrow-down"></i></button><button onclick="dupSec('${s.id}',event)"><i class="fas fa-copy"></i></button><button onclick="delSec('${s.id}',event)"><i class="fas fa-trash"></i></button></div>`;
    if(s.elements?.length)s.elements.forEach((e,j)=>h+=renderEl(e,s.id,j));
    else h+=`<div class="drop-z"><i class="fas fa-plus"></i> Drop blocks here</div>`;
    return h+'</div>';
}

function renderEl(el,sid,i){
    const sel=D.selEl===el.id,g=D.data.globalStyles||{},st=el.style||{};
    let cnt='';
    switch(el.type){
        case'heading':const lv=el.level||'h2',fs={h1:'26px',h2:'22px',h3:'18px',h4:'16px',h5:'14px',h6:'12px'}[lv];cnt=`<${lv} style="margin:0;font-size:${fs};${css(st)}">${el.text||'Heading'}</${lv}>`;break;
        case'text':cnt=`<p style="margin:0;line-height:1.6;${css(st)}">${el.text||'Your text here...'}</p>`;break;
        case'image':const img=`<img src="${el.src||'https://via.placeholder.com/580x220/e2e8f0/64748b?text=Image'}" alt="${el.alt||''}" style="max-width:100%;display:block;${css(st)}">`;cnt=el.link?`<a href="${el.link}">${img}</a>`:img;break;
        case'button':const bg=st.backgroundColor||g.defaultButtonColor||'#F97316',clr=st.color||'#fff',rad=st.borderRadius||'5px';cnt=`<div style="text-align:${el.align||'center'};padding:6px 0;"><a href="${el.link||'#'}" style="display:inline-block;background:${bg};color:${clr};padding:10px 24px;border-radius:${rad};text-decoration:none;font-weight:600;">${el.text||'Button'}</a></div>`;break;
        case'divider':cnt=`<hr style="border:none;border-top:1px solid #e2e8f0;margin:14px 0;">`;break;
        case'spacer':cnt=`<div style="height:${st.height||'20px'};"></div>`;break;
        case'logo':const logo=`<img src="${el.src||'https://via.placeholder.com/140x40/F97316/fff?text=LOGO'}" alt="Logo" style="max-height:45px;">`;cnt=`<div style="text-align:center;">${el.link?`<a href="${el.link}">${logo}</a>`:logo}</div>`;break;
        case'social':const nets=el.networks||[{name:'fb',icon:'https://img.icons8.com/color/28/facebook.png',url:'#'},{name:'tw',icon:'https://img.icons8.com/color/28/twitter.png',url:'#'}];cnt=`<div style="text-align:center;padding:6px 0;">${nets.map(n=>`<a href="${n.url}" style="margin:0 5px;"><img src="${n.icon}" width="24"></a>`).join('')}</div>`;break;
        case'html':cnt=el.html||'<div style="padding:14px;background:#f8fafc;text-align:center;color:#64748b;">Custom HTML</div>';break;
        case'footer':cnt=`<div style="text-align:center;font-size:11px;color:#64748b;"><p style="margin:0 0 5px;">${el.text||'© 2024 Company'}</p><a href="${el.unsubscribeUrl||'#'}" style="color:#64748b;">Unsubscribe</a></div>`;break;
        default:cnt=`<div style="padding:10px;background:#fef2f2;color:#ef4444;">Unknown: ${el.type}</div>`;
    }
    return `<div class="e-el ${sel?'sel':''}" data-eid="${el.id}" data-sid="${sid}" onclick="selEl('${el.id}','${sid}',event)"><div class="el-bar"><button onclick="mvElUp('${el.id}','${sid}',event)"><i class="fas fa-arrow-up"></i></button><button onclick="mvElDn('${el.id}','${sid}',event)"><i class="fas fa-arrow-down"></i></button><button onclick="dupEl('${el.id}','${sid}',event)"><i class="fas fa-copy"></i></button><button onclick="delEl('${el.id}','${sid}',event)"><i class="fas fa-trash"></i></button></div>${cnt}</div>`;
}

function css(o){return Object.entries(o).map(([k,v])=>`${k.replace(/([A-Z])/g,'-$1').toLowerCase()}:${v}`).join(';');}

function selSec(id,e){e?.stopPropagation();if(e?.target.closest('.e-el'))return;D.selSec=id;D.selEl=null;render();updLayers();showSecP(id);}
function selEl(eid,sid,e){e?.stopPropagation();D.selEl=eid;D.selSec=sid;render();showElP(eid,sid);}
function clearSel(){D.selSec=null;D.selEl=null;render();updLayers();showEmpty();}

function showEmpty(){document.getElementById('pTitle').innerHTML='<i class="fas fa-sliders-h"></i> Properties';document.getElementById('pBody').innerHTML='<div class="empty-p"><i class="fas fa-mouse-pointer"></i><h4>No Selection</h4><p>Click any element</p></div>';}

function showSecP(id){
    const s=findSec(id);if(!s)return;const st=s.style||{};
    document.getElementById('pTitle').innerHTML='<i class="fas fa-layer-group"></i> Section';
    document.getElementById('pBody').innerHTML=`
        <div class="pg"><div class="pg-title">Background</div><div class="pr"><label class="pl">Color</label><div class="pi-clr"><input type="color" value="${st.backgroundColor||'#ffffff'}" onchange="updSecSt('${id}','backgroundColor',this.value)"><input type="text" class="pi" value="${st.backgroundColor||'#ffffff'}" onchange="updSecSt('${id}','backgroundColor',this.value)"></div></div></div>
        <div class="pg"><div class="pg-title">Spacing</div><div class="pr"><label class="pl">Padding</label><input type="text" class="pi" value="${st.padding||'20px'}" onchange="updSecSt('${id}','padding',this.value)"></div></div>
        <div class="pg"><div class="pg-title">Alignment</div><div class="pr"><label class="pl">Text Align</label><select class="pi pi-sel" onchange="updSecSt('${id}','textAlign',this.value)"><option value="">Default</option><option value="left" ${st.textAlign==='left'?'selected':''}>Left</option><option value="center" ${st.textAlign==='center'?'selected':''}>Center</option><option value="right" ${st.textAlign==='right'?'selected':''}>Right</option></select></div></div>`;
}

function showElP(eid,sid){
    const sec=findSec(sid),el=sec?.elements?.find(e=>e.id===eid);if(!el)return;
    const nm={heading:'Heading',text:'Text',image:'Image',button:'Button',divider:'Divider',spacer:'Spacer',logo:'Logo',social:'Social',html:'HTML',footer:'Footer'};
    document.getElementById('pTitle').innerHTML=`<i class="fas fa-edit"></i> ${nm[el.type]||el.type}`;
    const st=el.style||{},g=D.data.globalStyles||{};
    let h='';
    switch(el.type){
        case'heading':h=`<div class="pg"><div class="pg-title">Content</div><div class="pr"><label class="pl">Text</label><input type="text" class="pi" value="${esc(el.text||'')}" oninput="updEl('${eid}','${sid}','text',this.value)"></div><div class="pr"><label class="pl">Level</label><select class="pi pi-sel" onchange="updEl('${eid}','${sid}','level',this.value)">${['h1','h2','h3','h4','h5','h6'].map(l=>`<option value="${l}" ${el.level===l?'selected':''}>${l.toUpperCase()}</option>`).join('')}</select></div></div><div class="pg"><div class="pg-title">Style</div><div class="pr"><label class="pl">Color</label><div class="pi-clr"><input type="color" value="${st.color||'#1e293b'}" onchange="updElSt('${eid}','${sid}','color',this.value)"><input type="text" class="pi" value="${st.color||'#1e293b'}" onchange="updElSt('${eid}','${sid}','color',this.value)"></div></div><div class="pr"><label class="pl">Font Size</label><input type="text" class="pi" value="${st.fontSize||''}" onchange="updElSt('${eid}','${sid}','fontSize',this.value)" placeholder="e.g., 24px"></div><div class="pr"><label class="pl">Font Weight</label><select class="pi pi-sel" onchange="updElSt('${eid}','${sid}','fontWeight',this.value)"><option value="">Normal</option><option value="500" ${st.fontWeight==='500'?'selected':''}>Medium</option><option value="600" ${st.fontWeight==='600'?'selected':''}>Semi-Bold</option><option value="700" ${st.fontWeight==='700'?'selected':''}>Bold</option></select></div></div>`;break;
        case'text':h=`<div class="pg"><div class="pg-title">Content</div><div class="pr"><label class="pl">Text</label><textarea class="pi pi-ta" oninput="updEl('${eid}','${sid}','text',this.value)">${esc(el.text||'')}</textarea></div></div><div class="pg"><div class="pg-title">Style</div><div class="pr"><label class="pl">Color</label><div class="pi-clr"><input type="color" value="${st.color||'#374151'}" onchange="updElSt('${eid}','${sid}','color',this.value)"><input type="text" class="pi" value="${st.color||'#374151'}" onchange="updElSt('${eid}','${sid}','color',this.value)"></div></div><div class="pr"><label class="pl">Font Size</label><input type="text" class="pi" value="${st.fontSize||'16px'}" onchange="updElSt('${eid}','${sid}','fontSize',this.value)"></div><div class="pr"><label class="pl">Line Height</label><input type="text" class="pi" value="${st.lineHeight||'1.6'}" onchange="updElSt('${eid}','${sid}','lineHeight',this.value)"></div><div class="pr"><label class="pl">Text Align</label><select class="pi pi-sel" onchange="updElSt('${eid}','${sid}','textAlign',this.value)"><option value="">Default</option><option value="left" ${st.textAlign==='left'?'selected':''}>Left</option><option value="center" ${st.textAlign==='center'?'selected':''}>Center</option><option value="right" ${st.textAlign==='right'?'selected':''}>Right</option></select></div></div>`;break;
        case'image':h=`<div class="pg"><div class="pg-title">Image</div><div class="pr"><label class="pl">URL</label><input type="text" class="pi" value="${el.src||''}" onchange="updEl('${eid}','${sid}','src',this.value)"></div><div class="pr"><label class="pl">Alt</label><input type="text" class="pi" value="${el.alt||''}" onchange="updEl('${eid}','${sid}','alt',this.value)"></div><div class="pr"><label class="pl">Link</label><input type="text" class="pi" value="${el.link||''}" onchange="updEl('${eid}','${sid}','link',this.value)"></div></div><div class="pg"><div class="pg-title">Style</div><div class="pr"><label class="pl">Border Radius</label><input type="text" class="pi" value="${st.borderRadius||'0'}" onchange="updElSt('${eid}','${sid}','borderRadius',this.value)"></div></div>`;break;
        case'button':h=`<div class="pg"><div class="pg-title">Button</div><div class="pr"><label class="pl">Text</label><input type="text" class="pi" value="${esc(el.text||'')}" oninput="updEl('${eid}','${sid}','text',this.value)"></div><div class="pr"><label class="pl">Link</label><input type="text" class="pi" value="${el.link||''}" onchange="updEl('${eid}','${sid}','link',this.value)"></div></div><div class="pg"><div class="pg-title">Colors</div><div class="pr"><label class="pl">Background</label><div class="pi-clr"><input type="color" value="${st.backgroundColor||g.defaultButtonColor||'#F97316'}" onchange="updElSt('${eid}','${sid}','backgroundColor',this.value)"><input type="text" class="pi" value="${st.backgroundColor||g.defaultButtonColor||'#F97316'}" onchange="updElSt('${eid}','${sid}','backgroundColor',this.value)"></div></div><div class="pr"><label class="pl">Text</label><div class="pi-clr"><input type="color" value="${st.color||'#ffffff'}" onchange="updElSt('${eid}','${sid}','color',this.value)"><input type="text" class="pi" value="${st.color||'#ffffff'}" onchange="updElSt('${eid}','${sid}','color',this.value)"></div></div></div><div class="pg"><div class="pg-title">Style</div><div class="pr"><label class="pl">Radius</label><input type="text" class="pi" value="${st.borderRadius||'5px'}" onchange="updElSt('${eid}','${sid}','borderRadius',this.value)"></div><div class="pr"><label class="pl">Align</label><select class="pi pi-sel" onchange="updEl('${eid}','${sid}','align',this.value)"><option value="left" ${el.align==='left'?'selected':''}>Left</option><option value="center" ${(el.align||'center')==='center'?'selected':''}>Center</option><option value="right" ${el.align==='right'?'selected':''}>Right</option></select></div></div>`;break;
        case'spacer':h=`<div class="pg"><div class="pg-title">Size</div><div class="pr"><label class="pl">Height</label><input type="text" class="pi" value="${st.height||'20px'}" onchange="updElSt('${eid}','${sid}','height',this.value)"></div></div>`;break;
        case'logo':h=`<div class="pg"><div class="pg-title">Logo</div><div class="pr"><label class="pl">Image URL</label><input type="text" class="pi" value="${el.src||''}" onchange="updEl('${eid}','${sid}','src',this.value)"></div><div class="pr"><label class="pl">Link</label><input type="text" class="pi" value="${el.link||''}" onchange="updEl('${eid}','${sid}','link',this.value)"></div></div>`;break;
        case'html':h=`<div class="pg"><div class="pg-title">HTML</div><div class="pr"><label class="pl">Code</label><textarea class="pi pi-ta" style="min-height:100px;font-family:monospace;font-size:10px;" onchange="updEl('${eid}','${sid}','html',this.value)">${esc(el.html||'')}</textarea></div></div>`;break;
        case'footer':h=`<div class="pg"><div class="pg-title">Footer</div><div class="pr"><label class="pl">Text</label><input type="text" class="pi" value="${esc(el.text||'')}" oninput="updEl('${eid}','${sid}','text',this.value)"></div><div class="pr"><label class="pl">Unsubscribe URL</label><input type="text" class="pi" value="${el.unsubscribeUrl||'{{unsubscribe_url}}'}" onchange="updEl('${eid}','${sid}','unsubscribeUrl',this.value)"></div></div>`;break;
        default:h='<p style="color:#64748b;font-size:11px;">No properties</p>';
    }
    h+=`<div class="pg"><div class="pg-title">Spacing</div><div class="pr-row"><div><label class="pl">Top</label><input type="text" class="pi" value="${st.marginTop||'0'}" onchange="updElSt('${eid}','${sid}','marginTop',this.value)"></div><div><label class="pl">Bottom</label><input type="text" class="pi" value="${st.marginBottom||'0'}" onchange="updElSt('${eid}','${sid}','marginBottom',this.value)"></div></div></div>`;
    document.getElementById('pBody').innerHTML=h;
}

function genId(){return'i'+Math.random().toString(36).substr(2,7);}
function findSec(id){return D.data?.sections?.find(s=>s.id===id);}
function findSecIdx(id){return D.data?.sections?.findIndex(s=>s.id===id)??-1;}

function addSec(){if(!D.data.sections)D.data.sections=[];const ns={id:genId(),type:'content',style:{padding:'20px'},elements:[]};D.data.sections.push(ns);D.selSec=ns.id;D.selEl=null;dirty();saveHist();render();updLayers();showSecP(ns.id);toast('Section added');}

function addEl(sid,type){const sec=findSec(sid);if(!sec)return;if(!sec.elements)sec.elements=[];const ne=mkEl(type);sec.elements.push(ne);D.selEl=ne.id;D.selSec=sid;dirty();saveHist();render();showElP(ne.id,sid);toast(`${type} added`);}

function mkEl(type){const id=genId(),g=D.data?.globalStyles||{};return{heading:{id,type,level:'h2',text:'New Heading',style:{}},text:{id,type,text:'Enter your text here...',style:{}},image:{id,type,src:'https://via.placeholder.com/580x220/e2e8f0/64748b?text=Image',alt:'',style:{borderRadius:'6px'}},button:{id,type,text:'Click Here',link:'#',align:'center',style:{backgroundColor:g.defaultButtonColor||'#F97316',borderRadius:'5px'}},divider:{id,type,style:{}},spacer:{id,type,style:{height:'20px'}},logo:{id,type,src:'https://via.placeholder.com/140x40/F97316/fff?text=LOGO',link:'',style:{}},social:{id,type,networks:[{name:'fb',icon:'https://img.icons8.com/color/28/facebook.png',url:'#'},{name:'tw',icon:'https://img.icons8.com/color/28/twitter.png',url:'#'},{name:'ig',icon:'https://img.icons8.com/color/28/instagram-new.png',url:'#'}],style:{}},html:{id,type,html:'<div style="padding:14px;background:#f8fafc;text-align:center;">Custom HTML</div>',style:{}},footer:{id,type,text:'© 2024 {{company_name}}',unsubscribeUrl:'{{unsubscribe_url}}',style:{}}}[type]||{id,type,style:{}};}

function updEl(eid,sid,k,v){const sec=findSec(sid),el=sec?.elements?.find(e=>e.id===eid);if(el){el[k]=v;dirty();render();}}
function updElSt(eid,sid,k,v){const sec=findSec(sid),el=sec?.elements?.find(e=>e.id===eid);if(el){if(!el.style)el.style={};el.style[k]=v;dirty();render();}}
function updSecSt(sid,k,v){const sec=findSec(sid);if(sec){if(!sec.style)sec.style={};sec.style[k]=v;dirty();render();}}

function mvSecUp(id,e){e?.stopPropagation();const i=findSecIdx(id);if(i>0){[D.data.sections[i],D.data.sections[i-1]]=[D.data.sections[i-1],D.data.sections[i]];dirty();saveHist();render();updLayers();}}
function mvSecDn(id,e){e?.stopPropagation();const i=findSecIdx(id);if(i<D.data.sections.length-1){[D.data.sections[i],D.data.sections[i+1]]=[D.data.sections[i+1],D.data.sections[i]];dirty();saveHist();render();updLayers();}}
function dupSec(id,e){e?.stopPropagation();const s=findSec(id);if(s){const ns=JSON.parse(JSON.stringify(s));ns.id=genId();ns.elements=ns.elements?.map(x=>({...x,id:genId()}))||[];const i=findSecIdx(id);D.data.sections.splice(i+1,0,ns);dirty();saveHist();render();updLayers();toast('Duplicated');}}
function delSec(id,e){e?.stopPropagation();if(confirm('Delete section?')){const i=findSecIdx(id);D.data.sections.splice(i,1);D.selSec=null;D.selEl=null;dirty();saveHist();render();updLayers();showEmpty();toast('Deleted');}}

function mvElUp(eid,sid,e){e?.stopPropagation();const sec=findSec(sid),i=sec?.elements?.findIndex(x=>x.id===eid);if(i>0){[sec.elements[i],sec.elements[i-1]]=[sec.elements[i-1],sec.elements[i]];dirty();saveHist();render();}}
function mvElDn(eid,sid,e){e?.stopPropagation();const sec=findSec(sid),i=sec?.elements?.findIndex(x=>x.id===eid);if(i<sec.elements.length-1){[sec.elements[i],sec.elements[i+1]]=[sec.elements[i+1],sec.elements[i]];dirty();saveHist();render();}}
function dupEl(eid,sid,e){e?.stopPropagation();const sec=findSec(sid),el=sec?.elements?.find(x=>x.id===eid);if(el){const ne=JSON.parse(JSON.stringify(el));ne.id=genId();const i=sec.elements.findIndex(x=>x.id===eid);sec.elements.splice(i+1,0,ne);dirty();saveHist();render();toast('Duplicated');}}
function delEl(eid,sid,e){e?.stopPropagation();const sec=findSec(sid),i=sec?.elements?.findIndex(x=>x.id===eid);if(i>=0){sec.elements.splice(i,1);D.selEl=null;dirty();saveHist();render();showSecP(sid);toast('Deleted');}}

function updLayers(){const l=document.getElementById('layerList'),secs=D.data?.sections||[];if(!secs.length){l.innerHTML='<p style="text-align:center;color:#64748b;font-size:11px;padding:15px;">No sections</p>';return;}l.innerHTML=secs.map((s,i)=>`<div class="layer ${D.selSec===s.id?'active':''}" onclick="selSec('${s.id}')"><i class="fas fa-layer-group"></i><div class="info"><div class="name">Section ${i+1}</div><div class="meta">${s.elements?.length||0} elements</div></div><div class="acts"><button onclick="mvSecUp('${s.id}',event)"><i class="fas fa-arrow-up"></i></button><button onclick="mvSecDn('${s.id}',event)"><i class="fas fa-arrow-down"></i></button><button onclick="delSec('${s.id}',event)"><i class="fas fa-trash"></i></button></div></div>`).join('');}

function dragO(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function drop(e,sid){e.preventDefault();e.currentTarget.classList.remove('drag-over');const type=e.dataTransfer.getData('type');if(type)addEl(sid,type);}

function setDev(v){document.querySelectorAll('.dev-btns button').forEach(b=>b.classList.remove('active'));document.querySelector(`.dev-btns button:${v==='desktop'?'first':'last'}-child`).classList.add('active');document.getElementById('frame').classList.toggle('mobile',v==='mobile');}

function saveHist(){D.hIdx++;D.hist=D.hist.slice(0,D.hIdx);D.hist.push(JSON.stringify(D.data));if(D.hist.length>25){D.hist.shift();D.hIdx--;}}
function undo(){if(D.hIdx>0){D.hIdx--;D.data=JSON.parse(D.hist[D.hIdx]);render();updLayers();showEmpty();toast('Undo');}}
function redo(){if(D.hIdx<D.hist.length-1){D.hIdx++;D.data=JSON.parse(D.hist[D.hIdx]);render();updLayers();showEmpty();toast('Redo');}}
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();e.shiftKey?redo():undo();}if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();save();}});

function dirty(){D.dirty=true;document.getElementById('status').innerHTML='<i class="fas fa-circle"></i> Unsaved';document.getElementById('status').className='status dirty';}

async function save(){
    document.getElementById('status').innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...';
    const html=buildHTML();
    try{
        const r=await fetch('/dashboard/campaigns/api/save-draft',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({campaign_id:D.cid,name:document.getElementById('inpName').value,subject:document.getElementById('inpSubject').value,from_name:document.getElementById('inpFromName').value,from_email:document.getElementById('inpFromEmail').value,reply_to:document.getElementById('inpReplyTo').value,preview_text:document.getElementById('inpPreview').value,html_content:html,json_data:D.data})});
        if(r.ok){D.dirty=false;document.getElementById('status').innerHTML='<i class="fas fa-check-circle"></i> Saved';document.getElementById('status').className='status saved';toast('Saved','success');}else throw new Error();
    }catch(e){document.getElementById('status').innerHTML='<i class="fas fa-times-circle"></i> Error';toast('Save failed','error');}
}

function buildHTML(){const g=D.data?.globalStyles||{};let h=`<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"></head><body style="margin:0;padding:0;background:${g.backgroundColor||'#f4f4f5'};font-family:${g.fontFamily||'Arial,sans-serif'};"><table width="100%" cellpadding="0" cellspacing="0"><tr><td align="center" style="padding:16px;"><table style="max-width:${g.maxWidth||'620px'};width:100%;background:${g.contentBackgroundColor||'#fff'};border-radius:6px;overflow:hidden;">`;(D.data?.sections||[]).forEach(s=>{h+=`<tr><td style="${css(s.style||{})}">`;(s.elements||[]).forEach(el=>h+=buildElHTML(el));h+=`</td></tr>`;});h+=`</table></td></tr></table></body></html>`;return h;}

function buildElHTML(el){const g=D.data?.globalStyles||{},st=el.style||{};switch(el.type){case'heading':return`<${el.level||'h2'} style="margin:0;${css(st)}">${el.text||''}</${el.level||'h2'}>`;case'text':return`<p style="margin:0;line-height:1.6;${css(st)}">${el.text||''}</p>`;case'image':const img=`<img src="${el.src||''}" alt="${el.alt||''}" style="max-width:100%;display:block;${css(st)}">`;return el.link?`<a href="${el.link}">${img}</a>`:img;case'button':return`<div style="text-align:${el.align||'center'};padding:6px 0;"><a href="${el.link||'#'}" style="display:inline-block;background:${st.backgroundColor||g.defaultButtonColor||'#F97316'};color:${st.color||'#fff'};padding:10px 24px;border-radius:${st.borderRadius||'5px'};text-decoration:none;font-weight:600;">${el.text||''}</a></div>`;case'divider':return`<hr style="border:none;border-top:1px solid #e2e8f0;margin:14px 0;">`;case'spacer':return`<div style="height:${st.height||'20px'};"></div>`;case'logo':const logo=`<img src="${el.src||''}" style="max-height:45px;">`;return`<div style="text-align:center;">${el.link?`<a href="${el.link}">${logo}</a>`:logo}</div>`;case'social':return`<div style="text-align:center;padding:6px 0;">${(el.networks||[]).map(n=>`<a href="${n.url}" style="margin:0 5px;"><img src="${n.icon}" width="24"></a>`).join('')}</div>`;case'html':return el.html||'';case'footer':return`<div style="text-align:center;font-size:11px;color:#64748b;"><p style="margin:0 0 5px;">${el.text||''}</p><a href="${el.unsubscribeUrl||'#'}" style="color:#64748b;">Unsubscribe</a></div>`;default:return'';}}

function uploadImg(eid,sid,input){const file=input.files[0];if(!file)return;const status=document.getElementById(`imgStatus_${eid}`);if(file.size>5*1024*1024){status.innerHTML=`<span style="color:#dc2626;">File too large (max 5MB)</span>`;return;}status.innerHTML=`<span style="color:#6366f1;"><i class="fas fa-spinner fa-spin"></i> Uploading...</span>`;const fd=new FormData();fd.append("image",file);fetch("/dashboard/campaigns/api/upload-image",{method:"POST",body:fd}).then(r=>r.json()).then(data=>{if(data.success){updEl(eid,sid,"src",data.url);document.getElementById(`imgUrl_${eid}`).value=data.url;status.innerHTML=`<span style="color:#10b981;"><i class="fas fa-check"></i> Uploaded!</span>`;setTimeout(()=>{status.innerHTML="";},2000);}else{status.innerHTML=`<span style="color:#dc2626;">${data.error}</span>`;}}).catch(e=>{status.innerHTML=`<span style="color:#dc2626;">Upload failed</span>`;});}

function preview(){document.getElementById('prevFrame').srcdoc=buildHTML();document.getElementById('modal').classList.add('show');}
function closeModal(){document.getElementById('modal').classList.remove('show');}

async function sendTest(){
    const email=document.getElementById('inpTest').value;
    if(!email){toast('Enter test email','warning');return;}
    await save();
    const fromEmail=document.getElementById('inpFromEmail')?.value||'';
    const fromName=document.getElementById('inpFromName')?.value||'SendBaba';
    const subject=document.getElementById('inpSubject')?.value||'Test Email';
    const html=buildHTML();
    try{
        const r=await fetch('/dashboard/campaigns/api/send-test',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({campaign_id:D.cid,test_email:email,from_email:fromEmail,from_name:fromName,subject:subject,html:html})});
        const data=await r.json();
        if(data.success){toast('Test sent to '+email,'success');}else{toast(data.error||'Send failed','error');}
    }catch(e){toast('Test failed','error');}
}
function proceed(){
    const name=document.getElementById('inpName').value,subj=document.getElementById('inpSubject').value,from=document.getElementById('inpFromEmail').value;
    if(!name||!subj||!from){toast('Fill required fields','warning');document.querySelector('.side-tab[data-t="settings"]').click();return;}
    save().then(()=>window.location.href=`/dashboard/campaigns/recipients?campaign_id=${D.cid}`);
}

function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}
function toast(msg,type='success'){const t=document.createElement('div');t.className=`toast ${type}`;t.innerHTML=`<i class="fas fa-${type==='success'?'check-circle':type==='error'?'times-circle':'exclamation-circle'}"></i> ${msg}`;document.getElementById('toasts').appendChild(t);setTimeout(()=>t.remove(),3000);}

document.addEventListener('click',e=>{if(!e.target.closest('.e-sec')&&!e.target.closest('.props')&&!e.target.closest('.sidebar'))clearSel();});
</script>
{% endblock %}
