{% extends "dashboard/base.html" %}
{% block title %}Analytics - SendBaba{% endblock %}
{% block page_title %}Analytics{% endblock %}
{% block page_subtitle %}Email performance insights{% endblock %}

{% block extra_css %}
<style>
.stat-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    padding: 1.25rem;
    transition: all 0.2s;
}
.stat-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border-color: #F97316;
}
.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}
.stat-value { font-size: 2rem; font-weight: 700; color: #1f2937; line-height: 1; }
.stat-label { font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; }
.period-btn {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    background: #f3f4f6;
    color: #6b7280;
}
.period-btn.active { background: #F97316; color: white; }
.period-btn:hover:not(.active) { background: #e5e7eb; }
.progress-ring { transform: rotate(-90deg); }
.chart-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    padding: 1.5rem;
}
.live-dot {
    width: 8px; height: 8px;
    background: #22c55e;
    border-radius: 50%;
    animation: pulse 2s infinite;
}
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
.failed-row:hover { background: #fef2f2; }
.status-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
}
.campaign-progress-card {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 16px;
    padding: 1.5rem;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 px-3 py-1.5 bg-green-50 rounded-full text-sm text-green-700 font-medium">
                <span class="live-dot"></span>
                Live
            </div>
            <span class="text-sm text-gray-500">Auto-updates every 10s</span>
        </div>
        
        <div class="flex items-center gap-2">
            <div class="flex bg-gray-100 rounded-lg p-1">
                <button onclick="changePeriod('24h')" class="period-btn {{ 'active' if period == '24h' }}">24h</button>
                <button onclick="changePeriod('7d')" class="period-btn {{ 'active' if period == '7d' }}">7d</button>
                <button onclick="changePeriod('30d')" class="period-btn {{ 'active' if period == '30d' }}">30d</button>
                <button onclick="changePeriod('90d')" class="period-btn {{ 'active' if period == '90d' }}">90d</button>
            </div>
            <button onclick="refreshData()" class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium hover:bg-gray-50 flex items-center gap-2">
                <i class="fas fa-sync-alt" id="refresh-icon"></i> Refresh
            </button>
            <button onclick="exportData()" class="px-4 py-2 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600 flex items-center gap-2">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>

    <!-- Active Campaign Progress (if any sending) -->
    <div id="active-campaign-section" class="hidden">
        <h2 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
            <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
            Active Campaign
        </h2>
        <div id="active-campaign-card"></div>
    </div>

    <!-- Main Stats - Total Sent vs Total Contacts -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Sent / Total Contacts -->
        <div class="stat-card col-span-2 lg:col-span-1">
            <div class="flex items-center justify-between mb-2">
                <div class="stat-icon bg-orange-100">
                    <i class="fas fa-paper-plane text-orange-500"></i>
                </div>
                <span class="text-xs font-medium text-orange-600 bg-orange-50 px-2 py-1 rounded-full" id="send-percent">0%</span>
            </div>
            <div class="stat-value" id="stat-sent">{{ "{:,}".format(overview.total_sent|default(0)) }}</div>
            <div class="stat-label">Sent of <span id="stat-total-contacts" class="font-semibold text-gray-900">{{ "{:,}".format(overview.total_contacts|default(0)) }}</span> contacts</div>
            <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                <div class="bg-orange-500 h-2 rounded-full transition-all" id="send-progress" style="width: 0%"></div>
            </div>
        </div>

        <!-- Delivered -->
        <div class="stat-card">
            <div class="flex items-center justify-between mb-2">
                <div class="stat-icon bg-green-100">
                    <i class="fas fa-check-double text-green-500"></i>
                </div>
                <span class="text-xs font-medium text-green-600" id="delivery-rate">{{ overview.delivery_rate|default(0) }}%</span>
            </div>
            <div class="stat-value text-green-600" id="stat-delivered">{{ "{:,}".format(overview.delivered|default(0)) }}</div>
            <div class="stat-label">Delivered</div>
        </div>

        <!-- Opened -->
        <div class="stat-card">
            <div class="flex items-center justify-between mb-2">
                <div class="stat-icon bg-blue-100">
                    <i class="fas fa-envelope-open text-blue-500"></i>
                </div>
                <span class="text-xs font-medium text-blue-600" id="open-rate">{{ overview.open_rate|default(0) }}%</span>
            </div>
            <div class="stat-value text-blue-600" id="stat-opened">{{ "{:,}".format(overview.opened|default(0)) }}</div>
            <div class="stat-label">Opened</div>
        </div>

        <!-- Failed / Bounced -->
        <div class="stat-card border-red-200">
            <div class="flex items-center justify-between mb-2">
                <div class="stat-icon bg-red-100">
                    <i class="fas fa-exclamation-triangle text-red-500"></i>
                </div>
                <span class="text-xs font-medium text-red-600" id="fail-rate">{{ overview.bounce_rate|default(0) }}%</span>
            </div>
            <div class="stat-value text-red-600" id="stat-failed">{{ "{:,}".format((overview.failed|default(0)) + (overview.bounced|default(0))) }}</div>
            <div class="stat-label">Failed / Bounced</div>
        </div>
    </div>

    <!-- Secondary Stats Row -->
    <div class="grid grid-cols-3 lg:grid-cols-6 gap-3">
        <div class="bg-white border rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-purple-600" id="stat-clicked">{{ "{:,}".format(overview.clicked|default(0)) }}</div>
            <div class="text-xs text-gray-500 mt-1 flex items-center justify-center gap-1">
                <span class="w-2 h-2 bg-purple-400 rounded-full"></span>Clicked
            </div>
        </div>
        <div class="bg-white border rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-yellow-600" id="stat-pending">{{ "{:,}".format(overview.pending|default(0)) }}</div>
            <div class="text-xs text-gray-500 mt-1 flex items-center justify-center gap-1">
                <span class="w-2 h-2 bg-yellow-400 rounded-full"></span>Processing
            </div>
        </div>
        <div class="bg-white border rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-red-600" id="stat-bounced">{{ "{:,}".format(overview.bounced|default(0)) }}</div>
            <div class="text-xs text-gray-500 mt-1 flex items-center justify-center gap-1">
                <span class="w-2 h-2 bg-red-400 rounded-full"></span>Bounced
            </div>
        </div>
        <div class="bg-white border rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-gray-600" id="stat-unsubscribed">{{ "{:,}".format(overview.unsubscribed|default(0)) }}</div>
            <div class="text-xs text-gray-500 mt-1 flex items-center justify-center gap-1">
                <span class="w-2 h-2 bg-gray-400 rounded-full"></span>Unsubscribed
            </div>
        </div>
        <div class="bg-white border rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-blue-600" id="stat-active-contacts">{{ "{:,}".format(overview.active_contacts|default(0)) }}</div>
            <div class="text-xs text-gray-500 mt-1 flex items-center justify-center gap-1">
                <span class="w-2 h-2 bg-blue-400 rounded-full"></span>Active Contacts
            </div>
        </div>
        <div class="bg-white border rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-green-600" id="stat-avg-daily">{{ "{:,}".format(overview.avg_daily|default(0)) }}</div>
            <div class="text-xs text-gray-500 mt-1 flex items-center justify-center gap-1">
                <span class="w-2 h-2 bg-green-400 rounded-full"></span>Avg Daily
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid lg:grid-cols-3 gap-6">
        <!-- Performance Chart -->
        <div class="lg:col-span-2 chart-card">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="font-semibold text-gray-900">Email Performance</h3>
                    <p class="text-sm text-gray-500">Sent vs Failed over time</p>
                </div>
                <div class="flex gap-4 text-xs">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-full"></span> Sent</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-full"></span> Failed</span>
                </div>
            </div>
            <div id="performanceChart" style="height: 280px;"></div>
        </div>

        <!-- Delivery Funnel -->
        <div class="chart-card">
            <h3 class="font-semibold text-gray-900 mb-4">Delivery Funnel</h3>
            <div class="space-y-4" id="funnel-container">
                {% set max_val = [engagement_funnel.sent|default(1), 1]|max %}
                
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600"><i class="fas fa-paper-plane text-orange-500 mr-2"></i>Sent</span>
                        <span class="font-semibold" id="funnel-sent">{{ "{:,}".format(engagement_funnel.sent|default(0)) }}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full" style="width: 100%;"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600"><i class="fas fa-check-double text-green-500 mr-2"></i>Delivered</span>
                        <span class="font-semibold" id="funnel-delivered">{{ "{:,}".format(engagement_funnel.delivered|default(0)) }}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: {{ (engagement_funnel.delivered|default(0) / max_val * 100)|int }}%;"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600"><i class="fas fa-envelope-open text-blue-500 mr-2"></i>Opened</span>
                        <span class="font-semibold" id="funnel-opened">{{ "{:,}".format(engagement_funnel.opened|default(0)) }}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" style="width: {{ (engagement_funnel.opened|default(0) / max_val * 100)|int }}%;"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600"><i class="fas fa-mouse-pointer text-purple-500 mr-2"></i>Clicked</span>
                        <span class="font-semibold" id="funnel-clicked">{{ "{:,}".format(engagement_funnel.clicked|default(0)) }}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-500 h-2 rounded-full" style="width: {{ (engagement_funnel.clicked|default(0) / max_val * 100)|int }}%;"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600"><i class="fas fa-times-circle text-red-500 mr-2"></i>Failed/Bounced</span>
                        <span class="font-semibold" id="funnel-failed">{{ "{:,}".format(engagement_funnel.failed|default(0)) }}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-red-500 h-2 rounded-full" style="width: {{ (engagement_funnel.failed|default(0) / max_val * 100)|int }}%;"></div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-2 mt-6 pt-4 border-t">
                <div class="text-center p-2 bg-green-50 rounded-lg">
                    <div class="text-lg font-bold text-green-600" id="rate-delivery">{{ overview.delivery_rate|default(0) }}%</div>
                    <div class="text-xs text-green-700">Delivery</div>
                </div>
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <div class="text-lg font-bold text-blue-600" id="rate-open">{{ overview.open_rate|default(0) }}%</div>
                    <div class="text-xs text-blue-700">Open</div>
                </div>
                <div class="text-center p-2 bg-purple-50 rounded-lg">
                    <div class="text-lg font-bold text-purple-600" id="rate-click">{{ overview.click_rate|default(0) }}%</div>
                    <div class="text-xs text-purple-700">Click</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Failed Emails Section -->
    <div class="chart-card">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h3 class="font-semibold text-gray-900">Failed & Bounced Emails</h3>
                <p class="text-sm text-gray-500">Emails that couldn't be delivered</p>
            </div>
            <button onclick="exportFailedEmails()" class="px-3 py-1.5 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100 flex items-center gap-2">
                <i class="fas fa-download"></i> Export Failed
            </button>
        </div>
        
        <div id="failed-emails-container">
            {% if failed_emails and failed_emails|length > 0 %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Email</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Reason</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Campaign</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Date</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for email in failed_emails[:20] %}
                        <tr class="failed-row hover:bg-red-50">
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">{{ email.recipient }}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded-full text-xs font-medium 
                                    {% if email.status == 'bounced' %}bg-yellow-100 text-yellow-700
                                    {% else %}bg-red-100 text-red-700{% endif %}">
                                    {{ email.status|capitalize }}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600 max-w-xs truncate">{{ email.error or 'Unknown error' }}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">{{ email.campaign_name or 'N/A' }}</td>
                            <td class="px-4 py-3 text-sm text-gray-500">{{ email.created_at }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if failed_emails|length > 20 %}
            <div class="mt-4 text-center">
                <p class="text-sm text-gray-500">Showing 20 of {{ failed_emails|length }} failed emails</p>
            </div>
            {% endif %}
            {% else %}
            <div class="text-center py-8">
                <div class="w-12 h-12 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-check text-green-500 text-xl"></i>
                </div>
                <p class="text-gray-500">No failed emails in this period</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Campaigns -->
    <div class="chart-card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">Recent Campaigns</h3>
            <a href="/dashboard/campaigns" class="text-sm text-orange-600 hover:text-orange-700 font-medium">View All →</a>
        </div>
        
        {% if top_campaigns %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Campaign</th>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Progress</th>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Opened</th>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Clicked</th>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Failed</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for campaign in top_campaigns[:10] %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">{{ campaign.name or 'Untitled' }}</div>
                            <div class="text-xs text-gray-500">{{ campaign.created_at }}</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium
                                {% if campaign.status == 'sending' %}bg-green-100 text-green-700
                                {% elif campaign.status == 'completed' %}bg-blue-100 text-blue-700
                                {% elif campaign.status == 'failed' %}bg-red-100 text-red-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                {{ campaign.status|capitalize }}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="flex-1 bg-gray-200 rounded-full h-2 min-w-[80px]">
                                    <div class="bg-orange-500 h-2 rounded-full" style="width: {{ (campaign.sent / (campaign.total or 1) * 100)|int }}%"></div>
                                </div>
                                <span class="text-xs text-gray-600">{{ "{:,}".format(campaign.sent) }}/{{ "{:,}".format(campaign.total or 0) }}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-green-600">{{ "{:,}".format(campaign.opened or 0) }}</td>
                        <td class="px-4 py-3 text-sm text-blue-600">{{ "{:,}".format(campaign.clicked or 0) }}</td>
                        <td class="px-4 py-3 text-sm text-red-600">{{ "{:,}".format(campaign.failed or 0) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8">
            <div class="w-12 h-12 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-paper-plane text-orange-300 text-xl"></i>
            </div>
            <p class="text-gray-500 text-sm mb-3">No campaigns yet</p>
            <a href="/dashboard/campaigns/create" class="inline-flex items-center gap-2 px-4 py-2 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600">
                <i class="fas fa-plus"></i> Create Campaign
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Domain Health -->
    {% if domain_stats %}
    <div class="chart-card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">Domain Health</h3>
            <a href="/dashboard/domains" class="text-sm text-orange-600 hover:text-orange-700 font-medium">Manage →</a>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for domain in domain_stats[:3] %}
            <div class="p-4 bg-gray-50 rounded-xl">
                <div class="flex items-center justify-between mb-3">
                    <span class="font-medium text-gray-900 truncate">{{ domain.domain }}</span>
                    <span class="text-sm font-bold {% if domain.health_score >= 90 %}text-green-600{% elif domain.health_score >= 50 %}text-yellow-600{% else %}text-red-600{% endif %}">
                        {{ domain.health_score }}%
                    </span>
                </div>
                <div class="flex gap-2">
                    <span class="text-xs px-2 py-1 rounded {% if domain.dns_verified %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-500{% endif %}">
                        <i class="fas fa-{% if domain.dns_verified %}check{% else %}times{% endif %} mr-1"></i>DNS
                    </span>
                    <span class="text-xs px-2 py-1 rounded {% if domain.dkim_verified %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-500{% endif %}">
                        <i class="fas fa-{% if domain.dkim_verified %}check{% else %}times{% endif %} mr-1"></i>DKIM
                    </span>
                    <span class="text-xs px-2 py-1 rounded {% if domain.spf_verified %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-500{% endif %}">
                        <i class="fas fa-{% if domain.spf_verified %}check{% else %}times{% endif %} mr-1"></i>SPF
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.44.0/dist/apexcharts.min.js"></script>
<script>
const emailTrends = {{ email_trends|safe }};
let autoRefreshInterval = null;

document.addEventListener('DOMContentLoaded', () => {
    initCharts();
    loadActiveCampaign();
    updateSendProgress();
    startAutoRefresh();
});

function initCharts() {
    const perfContainer = document.getElementById('performanceChart');
    if (perfContainer && emailTrends.length > 0) {
        new ApexCharts(perfContainer, {
            series: [
                { name: 'Sent', data: emailTrends.map(d => d.sent || d.total || 0) },
                { name: 'Failed', data: emailTrends.map(d => d.failed || 0) }
            ],
            chart: { type: 'area', height: 280, toolbar: { show: false }, fontFamily: 'inherit' },
            colors: ['#22c55e', '#ef4444'],
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05 } },
            stroke: { curve: 'smooth', width: 2 },
            dataLabels: { enabled: false },
            grid: { borderColor: '#f3f4f6', strokeDashArray: 4 },
            xaxis: {
                categories: emailTrends.map(d => d.label || ''),
                labels: { style: { colors: '#9ca3af', fontSize: '11px' } },
                axisBorder: { show: false },
                axisTicks: { show: false }
            },
            yaxis: {
                labels: {
                    style: { colors: '#9ca3af', fontSize: '11px' },
                    formatter: v => v >= 1000 ? (v/1000).toFixed(0) + 'k' : Math.round(v)
                }
            },
            legend: { show: false },
            tooltip: { theme: 'light', y: { formatter: v => v ? v.toLocaleString() : '0' } }
        }).render();
    } else if (perfContainer) {
        perfContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400"><i class="fas fa-chart-area mr-2"></i>No data yet</div>';
    }
}

function updateSendProgress() {
    const sent = parseInt(document.getElementById('stat-sent').textContent.replace(/,/g, '')) || 0;
    const total = parseInt(document.getElementById('stat-total-contacts').textContent.replace(/,/g, '')) || 1;
    const percent = Math.min(Math.round((sent / total) * 100), 100);
    document.getElementById('send-percent').textContent = percent + '%';
    document.getElementById('send-progress').style.width = percent + '%';
}

async function loadActiveCampaign() {
    try {
        const res = await fetch('/dashboard/analytics/api/active-campaign');
        const data = await res.json();
        
        const section = document.getElementById('active-campaign-section');
        const card = document.getElementById('active-campaign-card');
        
        if (data.success && data.campaign) {
            const c = data.campaign;
            section.classList.remove('hidden');
            card.innerHTML = `
                <div class="campaign-progress-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold">${c.name || 'Untitled Campaign'}</h3>
                            <p class="text-gray-400 text-sm">Started ${c.started_at || 'recently'}</p>
                        </div>
                        <span class="px-3 py-1 bg-green-500 text-white text-xs rounded-full animate-pulse">SENDING</span>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-400">Progress</span>
                            <span class="font-semibold">${(c.sent || 0).toLocaleString()} / ${(c.total || 0).toLocaleString()} (${c.percent || 0}%)</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div class="bg-gradient-to-r from-green-500 to-emerald-400 h-3 rounded-full transition-all" style="width: ${c.percent || 0}%"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-green-400">${(c.sent || 0).toLocaleString()}</div>
                            <div class="text-xs text-gray-400">Sent</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-red-400">${(c.failed || 0).toLocaleString()}</div>
                            <div class="text-xs text-gray-400">Failed</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-orange-400">${c.rate || '0'}</div>
                            <div class="text-xs text-gray-400">Emails/sec</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-blue-400">${c.eta || '--'}</div>
                            <div class="text-xs text-gray-400">ETA</div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            section.classList.add('hidden');
        }
    } catch (e) {
        console.error('Error loading active campaign:', e);
    }
}

function startAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    autoRefreshInterval = setInterval(() => {
        loadActiveCampaign();
        refreshStats();
    }, 10000);
}

async function refreshStats() {
    try {
        const res = await fetch('/dashboard/analytics/api/overview?period={{ period }}');
        const data = await res.json();
        if (data.success) {
            const o = data.overview;
            document.getElementById('stat-sent').textContent = (o.total_sent || 0).toLocaleString();
            document.getElementById('stat-delivered').textContent = (o.delivered || 0).toLocaleString();
            document.getElementById('stat-opened').textContent = (o.opened || 0).toLocaleString();
            document.getElementById('stat-clicked').textContent = (o.clicked || 0).toLocaleString();
            document.getElementById('stat-failed').textContent = ((o.failed || 0) + (o.bounced || 0)).toLocaleString();
            document.getElementById('stat-pending').textContent = (o.pending || 0).toLocaleString();
            document.getElementById('stat-bounced').textContent = (o.bounced || 0).toLocaleString();
            document.getElementById('delivery-rate').textContent = o.delivery_rate + '%';
            document.getElementById('open-rate').textContent = o.open_rate + '%';
            updateSendProgress();
        }
    } catch (e) {
        console.error('Error refreshing stats:', e);
    }
}

function refreshData() {
    document.getElementById('refresh-icon').classList.add('fa-spin');
    Promise.all([loadActiveCampaign(), refreshStats()]).finally(() => {
        setTimeout(() => document.getElementById('refresh-icon').classList.remove('fa-spin'), 500);
    });
}

function changePeriod(period) {
    window.location.href = '/dashboard/analytics?period=' + period;
}

function exportData() {
    window.location.href = '/dashboard/analytics/api/export?period={{ period }}';
}

function exportFailedEmails() {
    window.location.href = '/dashboard/analytics/api/export-failed?period={{ period }}';
}
</script>
{% endblock %}
