{% extends "dashboard/base.html" %}
{% block title %}Analytics - SendBaba{% endblock %}
{% block page_title %}Analytics{% endblock %}
{% block page_subtitle %}Email performance insights{% endblock %}

{% block extra_css %}
<style>
.analytics-grid { display: grid; gap: 1rem; }
.stat-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    padding: 1.25rem;
    transition: all 0.2s;
}
.stat-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border-color: #F97316;
}
.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}
.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
}
.stat-label {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
}
.queue-card {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 16px;
    padding: 1.25rem;
    color: white;
}
.queue-value {
    font-size: 2rem;
    font-weight: 700;
    color: #F97316;
}
.chart-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    padding: 1.5rem;
}
.period-btn {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    background: #f3f4f6;
    color: #6b7280;
}
.period-btn.active {
    background: #F97316;
    color: white;
}
.period-btn:hover:not(.active) {
    background: #e5e7eb;
}
.funnel-bar {
    height: 8px;
    background: #f3f4f6;
    border-radius: 4px;
    overflow: hidden;
}
.funnel-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.8s ease;
}
.mini-stat {
    background: #f9fafb;
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
}
.campaign-row {
    padding: 0.75rem;
    border-radius: 8px;
    transition: background 0.2s;
}
.campaign-row:hover {
    background: #fff7ed;
}
.status-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
}
.status-badge.sending { background: #fef3c7; color: #92400e; }
.status-badge.completed { background: #dcfce7; color: #166534; }
.status-badge.sent { background: #dcfce7; color: #166534; }
.status-badge.failed { background: #fee2e2; color: #991b1b; }
.live-dot {
    width: 8px;
    height: 8px;
    background: #22c55e;
    border-radius: 50%;
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 px-3 py-1.5 bg-green-50 rounded-full text-sm text-green-700 font-medium">
                <span class="live-dot"></span>
                Live
            </div>
            <span class="text-sm text-gray-500">Updated just now</span>
        </div>
        
        <div class="flex items-center gap-2">
            <div class="flex bg-gray-100 rounded-lg p-1">
                <button onclick="changePeriod('24h')" class="period-btn {{ 'active' if period == '24h' }}">24h</button>
                <button onclick="changePeriod('7d')" class="period-btn {{ 'active' if period == '7d' }}">7d</button>
                <button onclick="changePeriod('30d')" class="period-btn {{ 'active' if period == '30d' }}">30d</button>
                <button onclick="changePeriod('90d')" class="period-btn {{ 'active' if period == '90d' }}">90d</button>
            </div>
            <button onclick="exportData()" class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium hover:bg-gray-50 flex items-center gap-2">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>

    <!-- Queue Status (Dark Cards) -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="queue-card">
            <div class="flex items-center gap-2 mb-2">
                <i class="fas fa-clock text-orange-400"></i>
                <span class="text-gray-400 text-sm">Pending</span>
            </div>
            <div class="queue-value">{{ "{:,}".format(queue_stats.pending|default(0)) }}</div>
        </div>
        <div class="queue-card">
            <div class="flex items-center gap-2 mb-2">
                <i class="fas fa-spinner text-blue-400"></i>
                <span class="text-gray-400 text-sm">Processing</span>
            </div>
            <div class="queue-value">{{ "{:,}".format(queue_stats.processing|default(0)) }}</div>
        </div>
        <div class="queue-card">
            <div class="flex items-center gap-2 mb-2">
                <i class="fas fa-check text-green-400"></i>
                <span class="text-gray-400 text-sm">Sent Today</span>
            </div>
            <div class="queue-value">{{ "{:,}".format(queue_stats.completed_today|default(0)) }}</div>
        </div>
        <div class="queue-card">
            <div class="flex items-center gap-2 mb-2">
                <i class="fas fa-times text-red-400"></i>
                <span class="text-gray-400 text-sm">Failed Today</span>
            </div>
            <div class="queue-value">{{ "{:,}".format(queue_stats.failed_today|default(0)) }}</div>
        </div>
    </div>

    <!-- Main Stats -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="stat-card">
            <div class="flex items-start justify-between mb-3">
                <div class="stat-icon bg-orange-100">
                    <i class="fas fa-paper-plane text-orange-500"></i>
                </div>
            </div>
            <div class="stat-value">{{ "{:,}".format(overview.total_sent|default(0)) }}</div>
            <div class="stat-label">Total Sent</div>
            <div class="text-xs text-gray-400 mt-1">{{ "{:,}".format(overview.avg_daily|default(0)|int) }}/day avg</div>
        </div>

        <div class="stat-card">
            <div class="flex items-start justify-between mb-3">
                <div class="stat-icon bg-green-100">
                    <i class="fas fa-check-double text-green-500"></i>
                </div>
                <span class="text-sm font-semibold text-green-600">{{ overview.delivery_rate|default(0) }}%</span>
            </div>
            <div class="stat-value">{{ "{:,}".format(overview.delivered|default(0)) }}</div>
            <div class="stat-label">Delivered</div>
        </div>

        <div class="stat-card">
            <div class="flex items-start justify-between mb-3">
                <div class="stat-icon bg-blue-100">
                    <i class="fas fa-envelope-open text-blue-500"></i>
                </div>
                <span class="text-sm font-semibold text-blue-600">{{ overview.open_rate|default(0) }}%</span>
            </div>
            <div class="stat-value">{{ "{:,}".format(overview.opened|default(0)) }}</div>
            <div class="stat-label">Opened</div>
        </div>

        <div class="stat-card">
            <div class="flex items-start justify-between mb-3">
                <div class="stat-icon bg-purple-100">
                    <i class="fas fa-mouse-pointer text-purple-500"></i>
                </div>
                <span class="text-sm font-semibold text-purple-600">{{ overview.click_rate|default(0) }}%</span>
            </div>
            <div class="stat-value">{{ "{:,}".format(overview.clicked|default(0)) }}</div>
            <div class="stat-label">Clicked</div>
        </div>
    </div>

    <!-- Secondary Stats -->
    <div class="grid grid-cols-3 lg:grid-cols-6 gap-3">
        <div class="mini-stat">
            <div class="text-xl font-bold text-gray-900">{{ "{:,}".format(overview.bounced|default(0)) }}</div>
            <div class="text-xs text-gray-500 mt-1"><span class="inline-block w-2 h-2 bg-red-400 rounded-full mr-1"></span>Bounced</div>
        </div>
        <div class="mini-stat">
            <div class="text-xl font-bold text-gray-900">{{ overview.bounce_rate|default(0) }}%</div>
            <div class="text-xs text-gray-500 mt-1"><span class="inline-block w-2 h-2 bg-orange-400 rounded-full mr-1"></span>Bounce Rate</div>
        </div>
        <div class="mini-stat">
            <div class="text-xl font-bold text-gray-900">{{ "{:,}".format(overview.total_contacts|default(0)) }}</div>
            <div class="text-xs text-gray-500 mt-1"><span class="inline-block w-2 h-2 bg-blue-400 rounded-full mr-1"></span>Contacts</div>
        </div>
        <div class="mini-stat">
            <div class="text-xl font-bold text-gray-900">{{ "{:,}".format(overview.active_contacts|default(0)) }}</div>
            <div class="text-xs text-gray-500 mt-1"><span class="inline-block w-2 h-2 bg-green-400 rounded-full mr-1"></span>Active</div>
        </div>
        <div class="mini-stat">
            <div class="text-xl font-bold text-gray-900">{{ campaign_stats.sent|default(0) }}</div>
            <div class="text-xs text-gray-500 mt-1"><span class="inline-block w-2 h-2 bg-purple-400 rounded-full mr-1"></span>Campaigns</div>
        </div>
        <div class="mini-stat">
            <div class="text-xl font-bold text-gray-900">{{ "{:,}".format(overview.failed|default(0)) }}</div>
            <div class="text-xs text-gray-500 mt-1"><span class="inline-block w-2 h-2 bg-red-400 rounded-full mr-1"></span>Failed</div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid lg:grid-cols-3 gap-6">
        <!-- Performance Chart -->
        <div class="lg:col-span-2 chart-card">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="font-semibold text-gray-900">Email Performance</h3>
                    <p class="text-sm text-gray-500">Delivery over time</p>
                </div>
                <div class="flex gap-4 text-xs">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-500 rounded-full"></span> Sent</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-full"></span> Failed</span>
                </div>
            </div>
            <div id="performanceChart" style="height: 280px;"></div>
        </div>

        <!-- Delivery Funnel -->
        <div class="chart-card">
            <h3 class="font-semibold text-gray-900 mb-4">Delivery Funnel</h3>
            
            <div class="space-y-4">
                {% set max_val = [engagement_funnel.sent|default(0), 1]|max %}
                
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600"><i class="fas fa-paper-plane text-orange-500 mr-2"></i>Sent</span>
                        <span class="font-semibold">{{ "{:,}".format(engagement_funnel.sent|default(0)) }}</span>
                    </div>
                    <div class="funnel-bar">
                        <div class="funnel-fill bg-orange-500" style="width: 100%;"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600"><i class="fas fa-check-double text-green-500 mr-2"></i>Delivered</span>
                        <span class="font-semibold">{{ "{:,}".format(engagement_funnel.delivered|default(0)) }}</span>
                    </div>
                    <div class="funnel-bar">
                        <div class="funnel-fill bg-green-500" style="width: {{ [(engagement_funnel.delivered|default(0) / max_val * 100)|int, 5]|max }}%;"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600"><i class="fas fa-envelope-open text-blue-500 mr-2"></i>Opened</span>
                        <span class="font-semibold">{{ "{:,}".format(engagement_funnel.opened|default(0)) }}</span>
                    </div>
                    <div class="funnel-bar">
                        <div class="funnel-fill bg-blue-500" style="width: {{ [(engagement_funnel.opened|default(0) / max_val * 100)|int, 3]|max }}%;"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600"><i class="fas fa-mouse-pointer text-purple-500 mr-2"></i>Clicked</span>
                        <span class="font-semibold">{{ "{:,}".format(engagement_funnel.clicked|default(0)) }}</span>
                    </div>
                    <div class="funnel-bar">
                        <div class="funnel-fill bg-purple-500" style="width: {{ [(engagement_funnel.clicked|default(0) / max_val * 100)|int, 2]|max }}%;"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600"><i class="fas fa-times-circle text-red-500 mr-2"></i>Failed</span>
                        <span class="font-semibold">{{ "{:,}".format(engagement_funnel.failed|default(0)) }}</span>
                    </div>
                    <div class="funnel-bar">
                        <div class="funnel-fill bg-red-500" style="width: {{ [(engagement_funnel.failed|default(0) / max_val * 100)|int, 2]|max }}%;"></div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-2 mt-6 pt-4 border-t">
                <div class="text-center p-2 bg-green-50 rounded-lg">
                    <div class="text-lg font-bold text-green-600">{{ overview.delivery_rate|default(0) }}%</div>
                    <div class="text-xs text-green-700">Delivery</div>
                </div>
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <div class="text-lg font-bold text-blue-600">{{ overview.open_rate|default(0) }}%</div>
                    <div class="text-xs text-blue-700">Open</div>
                </div>
                <div class="text-center p-2 bg-purple-50 rounded-lg">
                    <div class="text-lg font-bold text-purple-600">{{ overview.click_rate|default(0) }}%</div>
                    <div class="text-xs text-purple-700">Click</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Section -->
    <div class="grid lg:grid-cols-3 gap-6">
        <!-- Hourly Chart -->
        <div class="chart-card">
            <h3 class="font-semibold text-gray-900 mb-4">Send Time Distribution</h3>
            <div id="hourlyChart" style="height: 200px;"></div>
        </div>

        <!-- Recent Campaigns -->
        <div class="lg:col-span-2 chart-card">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-900">Recent Campaigns</h3>
                <a href="/dashboard/campaigns" class="text-sm text-orange-600 hover:text-orange-700 font-medium">View All →</a>
            </div>
            
            {% if top_campaigns %}
            <div class="space-y-2">
                {% for campaign in top_campaigns[:5] %}
                <div class="campaign-row flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-gray-900 truncate">{{ campaign.name }}</div>
                        <div class="text-xs text-gray-500">{{ campaign.created_at }}</div>
                    </div>
                    <div class="flex items-center gap-4 ml-4">
                        <div class="text-right">
                            <div class="font-semibold text-gray-900">{{ "{:,}".format(campaign.sent) }}</div>
                            <div class="text-xs text-gray-500">sent</div>
                        </div>
                        <span class="status-badge {{ campaign.status }}">{{ campaign.status|capitalize }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <div class="w-12 h-12 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-paper-plane text-orange-300 text-xl"></i>
                </div>
                <p class="text-gray-500 text-sm mb-3">No campaigns yet</p>
                <a href="/dashboard/campaigns/create" class="inline-flex items-center gap-2 px-4 py-2 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600">
                    <i class="fas fa-plus"></i> Create Campaign
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Domain Health -->
    {% if domain_stats %}
    <div class="chart-card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">Domain Health</h3>
            <a href="/dashboard/domains" class="text-sm text-orange-600 hover:text-orange-700 font-medium">Manage →</a>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for domain in domain_stats[:3] %}
            <div class="p-4 bg-gray-50 rounded-xl">
                <div class="flex items-center justify-between mb-3">
                    <span class="font-medium text-gray-900 truncate">{{ domain.domain }}</span>
                    <span class="text-sm font-bold {% if domain.health_score >= 90 %}text-green-600{% elif domain.health_score >= 50 %}text-yellow-600{% else %}text-red-600{% endif %}">
                        {{ domain.health_score }}%
                    </span>
                </div>
                <div class="flex gap-2">
                    <span class="text-xs px-2 py-1 rounded {% if domain.dns_verified %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-500{% endif %}">
                        <i class="fas fa-{% if domain.dns_verified %}check{% else %}times{% endif %} mr-1"></i>DNS
                    </span>
                    <span class="text-xs px-2 py-1 rounded {% if domain.dkim_verified %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-500{% endif %}">
                        <i class="fas fa-{% if domain.dkim_verified %}check{% else %}times{% endif %} mr-1"></i>DKIM
                    </span>
                    <span class="text-xs px-2 py-1 rounded {% if domain.spf_verified %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-500{% endif %}">
                        <i class="fas fa-{% if domain.spf_verified %}check{% else %}times{% endif %} mr-1"></i>SPF
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.44.0/dist/apexcharts.min.js"></script>
<script>
const emailTrends = {{ email_trends|safe }};
const hourlyDist = {{ hourly_dist|safe }};

// Performance Chart
const perfContainer = document.getElementById('performanceChart');
if (perfContainer && emailTrends.length > 0) {
    new ApexCharts(perfContainer, {
        series: [
            { name: 'Sent', data: emailTrends.map(d => d.sent || d.total || 0) },
            { name: 'Failed', data: emailTrends.map(d => d.failed || 0) }
        ],
        chart: { type: 'area', height: 280, toolbar: { show: false }, fontFamily: 'inherit' },
        colors: ['#F97316', '#ef4444'],
        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05 } },
        stroke: { curve: 'smooth', width: 2 },
        dataLabels: { enabled: false },
        grid: { borderColor: '#f3f4f6', strokeDashArray: 4 },
        xaxis: {
            categories: emailTrends.map(d => d.label || ''),
            labels: { style: { colors: '#9ca3af', fontSize: '11px' } },
            axisBorder: { show: false },
            axisTicks: { show: false }
        },
        yaxis: {
            labels: {
                style: { colors: '#9ca3af', fontSize: '11px' },
                formatter: v => v >= 1000 ? (v/1000).toFixed(0) + 'k' : Math.round(v)
            }
        },
        legend: { show: false },
        tooltip: { theme: 'light', y: { formatter: v => v ? v.toLocaleString() : '0' } }
    }).render();
} else if (perfContainer) {
    perfContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400"><i class="fas fa-chart-area mr-2"></i>No data yet</div>';
}

// Hourly Chart
const hourlyContainer = document.getElementById('hourlyChart');
if (hourlyContainer && hourlyDist.some(d => d.count > 0)) {
    new ApexCharts(hourlyContainer, {
        series: [{ name: 'Emails', data: hourlyDist.map(d => d.count) }],
        chart: { type: 'bar', height: 200, toolbar: { show: false }, fontFamily: 'inherit' },
        colors: ['#F97316'],
        plotOptions: { bar: { borderRadius: 4, columnWidth: '60%' } },
        dataLabels: { enabled: false },
        grid: { borderColor: '#f3f4f6' },
        xaxis: {
            categories: hourlyDist.map(d => d.hour),
            labels: { style: { colors: '#9ca3af', fontSize: '9px' }, rotate: 0 },
            axisBorder: { show: false },
            axisTicks: { show: false }
        },
        yaxis: {
            labels: {
                style: { colors: '#9ca3af', fontSize: '10px' },
                formatter: v => v >= 1000 ? (v/1000).toFixed(0) + 'k' : Math.round(v)
            }
        },
        tooltip: { theme: 'light' }
    }).render();
} else if (hourlyContainer) {
    hourlyContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400 text-sm"><i class="fas fa-clock mr-2"></i>No data yet</div>';
}

function changePeriod(period) {
    window.location.href = '/dashboard/analytics?period=' + period;
}

function exportData() {
    window.location.href = '/dashboard/analytics/api/export?period={{ period }}';
}

// Auto-refresh every 60 seconds
setInterval(() => {
    fetch('/dashboard/analytics/api/realtime')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Could update queue stats here
            }
        })
        .catch(() => {});
}, 60000);
</script>
{% endblock %}
