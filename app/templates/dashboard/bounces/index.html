{% extends "dashboard/base.html" %}
{% block title %}Bounce Management - SendBaba{% endblock %}
{% block page_title %}Bounce Management{% endblock %}
{% block page_subtitle %}Monitor bounces and manage suppression list{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-exclamation-circle text-red-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Hard Bounces</p>
                    <p class="text-2xl font-bold text-gray-900" id="hardBounces">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-clock text-yellow-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Soft Bounces</p>
                    <p class="text-2xl font-bold text-gray-900" id="softBounces">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-ban text-purple-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Spam Complaints</p>
                    <p class="text-2xl font-bold text-gray-900" id="spamComplaints">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-user-slash text-gray-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Suppressed Emails</p>
                    <p class="text-2xl font-bold text-gray-900" id="suppressionCount">-</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="border-b border-gray-200">
            <nav class="flex">
                <button onclick="showTab('recent')" id="tab-recent" class="tab-btn active px-6 py-4 font-medium text-gray-900 border-b-2 border-orange-500">
                    <i class="fas fa-history mr-2"></i>Recent Bounces
                </button>
                <button onclick="showTab('suppression')" id="tab-suppression" class="tab-btn px-6 py-4 font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-list mr-2"></i>Suppression List
                </button>
                <button onclick="showTab('check')" id="tab-check" class="tab-btn px-6 py-4 font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-search mr-2"></i>Check Emails
                </button>
            </nav>
        </div>
        
        <!-- Recent Bounces Tab -->
        <div id="panel-recent" class="tab-panel p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-100">
                            <th class="text-left py-3 px-4 font-medium text-gray-500">Email</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-500">Type</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-500">Reason</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-500">Date</th>
                        </tr>
                    </thead>
                    <tbody id="recentBouncesTable">
                        <tr><td colspan="4" class="py-8 text-center text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Suppression List Tab -->
        <div id="panel-suppression" class="tab-panel p-6 hidden">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-4">
                    <input type="text" id="searchSuppression" placeholder="Search emails..." 
                           class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    <button onclick="searchSuppression()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="flex gap-3">
                    <button onclick="showAddModal()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                        <i class="fas fa-plus mr-2"></i>Add Email
                    </button>
                    <button onclick="showImportModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        <i class="fas fa-upload mr-2"></i>Import
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-100">
                            <th class="text-left py-3 px-4 font-medium text-gray-500">Email</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-500">Type</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-500">Reason</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-500">Bounces</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-500">Added</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-500">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="suppressionTable">
                        <tr><td colspan="6" class="py-8 text-center text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="flex items-center justify-between mt-6">
                <p class="text-sm text-gray-500" id="suppressionInfo">Showing 0 of 0</p>
                <div class="flex gap-2">
                    <button onclick="prevPage()" id="prevBtn" class="px-4 py-2 border border-gray-300 rounded-lg disabled:opacity-50" disabled>Previous</button>
                    <button onclick="nextPage()" id="nextBtn" class="px-4 py-2 border border-gray-300 rounded-lg disabled:opacity-50">Next</button>
                </div>
            </div>
        </div>
        
        <!-- Check Emails Tab -->
        <div id="panel-check" class="tab-panel p-6 hidden">
            <div class="max-w-2xl">
                <p class="text-gray-600 mb-4">Paste emails (one per line) to check if they're suppressed:</p>
                <textarea id="checkEmailsInput" rows="6" 
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                          placeholder="email1@example.com&#10;email2@example.com&#10;..."></textarea>
                <button onclick="checkEmails()" class="mt-4 px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-medium">
                    <i class="fas fa-search mr-2"></i>Check Emails
                </button>
                
                <div id="checkResults" class="mt-6 hidden">
                    <h4 class="font-semibold text-gray-900 mb-4">Results</h4>
                    <div id="checkResultsContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Email Modal -->
<div id="addModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl max-w-md w-full mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Add to Suppression List</h3>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
            <input type="email" id="addEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
        </div>
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Reason</label>
            <input type="text" id="addReason" value="Manual addition" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
        </div>
        <div class="flex gap-3">
            <button onclick="closeAddModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
            <button onclick="addToSuppression()" class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">Add</button>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl max-w-md w-full mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Import Suppression List</h3>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Emails (one per line)</label>
            <textarea id="importEmails" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email1@example.com&#10;email2@example.com"></textarea>
        </div>
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Reason</label>
            <input type="text" id="importReason" value="Bulk import" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
        </div>
        <div class="flex gap-3">
            <button onclick="closeImportModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
            <button onclick="importSuppression()" class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">Import</button>
        </div>
    </div>
</div>

<style>
.tab-btn.active { color: #111827; border-bottom: 2px solid #f97316; }
.tab-btn:not(.active) { border-bottom: 2px solid transparent; }
</style>

<script>
let currentPage = 1;
let totalPages = 1;
let searchQuery = '';

// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadSuppression();
});

function loadStats() {
    fetch('/dashboard/bounces/api/stats')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                document.getElementById('hardBounces').textContent = stats.by_type?.hard || 0;
                document.getElementById('softBounces').textContent = stats.by_type?.soft || 0;
                document.getElementById('spamComplaints').textContent = (stats.by_type?.spam || 0) + (stats.by_type?.complaint || 0);
                document.getElementById('suppressionCount').textContent = data.suppression_count || 0;
                
                // Populate recent bounces
                const tbody = document.getElementById('recentBouncesTable');
                if (data.recent_bounces && data.recent_bounces.length > 0) {
                    tbody.innerHTML = data.recent_bounces.map(b => `
                        <tr class="border-b border-gray-50 hover:bg-gray-50">
                            <td class="py-3 px-4 font-medium">${b.email}</td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${getTypeClass(b.type)}">${b.type}</span>
                            </td>
                            <td class="py-3 px-4 text-gray-600 text-sm">${b.reason || '-'}</td>
                            <td class="py-3 px-4 text-gray-500 text-sm">${formatDate(b.bounced_at)}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="py-8 text-center text-gray-500">No recent bounces</td></tr>';
                }
            }
        });
}

function loadSuppression() {
    fetch(`/dashboard/bounces/api/suppression?page=${currentPage}&search=${searchQuery}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                totalPages = data.pages;
                
                const tbody = document.getElementById('suppressionTable');
                if (data.items && data.items.length > 0) {
                    tbody.innerHTML = data.items.map(s => `
                        <tr class="border-b border-gray-50 hover:bg-gray-50">
                            <td class="py-3 px-4 font-medium">${s.email}</td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${getTypeClass(s.type)}">${s.type}</span>
                            </td>
                            <td class="py-3 px-4 text-gray-600 text-sm">${s.reason || '-'}</td>
                            <td class="py-3 px-4 text-gray-600">${s.bounce_count || 1}</td>
                            <td class="py-3 px-4 text-gray-500 text-sm">${formatDate(s.added_at)}</td>
                            <td class="py-3 px-4">
                                <button onclick="removeSuppression('${s.email}')" class="text-red-600 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-500">No suppressed emails</td></tr>';
                }
                
                document.getElementById('suppressionInfo').textContent = `Page ${currentPage} of ${totalPages} (${data.total} total)`;
                document.getElementById('prevBtn').disabled = currentPage <= 1;
                document.getElementById('nextBtn').disabled = currentPage >= totalPages;
            }
        });
}

function showTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
    
    document.getElementById('tab-' + tab).classList.add('active');
    document.getElementById('panel-' + tab).classList.remove('hidden');
}

function getTypeClass(type) {
    const classes = {
        'hard': 'bg-red-100 text-red-700',
        'soft': 'bg-yellow-100 text-yellow-700',
        'spam': 'bg-purple-100 text-purple-700',
        'complaint': 'bg-pink-100 text-pink-700',
        'manual': 'bg-gray-100 text-gray-700',
        'import': 'bg-blue-100 text-blue-700'
    };
    return classes[type] || 'bg-gray-100 text-gray-700';
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString();
}

function searchSuppression() {
    searchQuery = document.getElementById('searchSuppression').value;
    currentPage = 1;
    loadSuppression();
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        loadSuppression();
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        currentPage++;
        loadSuppression();
    }
}

function showAddModal() {
    document.getElementById('addModal').classList.remove('hidden');
    document.getElementById('addModal').classList.add('flex');
}

function closeAddModal() {
    document.getElementById('addModal').classList.add('hidden');
    document.getElementById('addModal').classList.remove('flex');
}

function showImportModal() {
    document.getElementById('importModal').classList.remove('hidden');
    document.getElementById('importModal').classList.add('flex');
}

function closeImportModal() {
    document.getElementById('importModal').classList.add('hidden');
    document.getElementById('importModal').classList.remove('flex');
}

function addToSuppression() {
    const email = document.getElementById('addEmail').value;
    const reason = document.getElementById('addReason').value;
    
    fetch('/dashboard/bounces/api/suppression/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email, reason})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeAddModal();
            loadSuppression();
            loadStats();
        } else {
            alert(data.error || 'Failed to add');
        }
    });
}

function importSuppression() {
    const emailsText = document.getElementById('importEmails').value;
    const reason = document.getElementById('importReason').value;
    const emails = emailsText.split('\n').map(e => e.trim()).filter(e => e);
    
    fetch('/dashboard/bounces/api/suppression/import', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({emails, reason})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(`Imported ${data.added} emails`);
            closeImportModal();
            loadSuppression();
            loadStats();
        } else {
            alert(data.error || 'Import failed');
        }
    });
}

function removeSuppression(email) {
    if (!confirm(`Remove ${email} from suppression list?`)) return;
    
    fetch('/dashboard/bounces/api/suppression/remove', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadSuppression();
            loadStats();
        }
    });
}

function checkEmails() {
    const emailsText = document.getElementById('checkEmailsInput').value;
    const emails = emailsText.split('\n').map(e => e.trim()).filter(e => e);
    
    if (emails.length === 0) {
        alert('Please enter at least one email');
        return;
    }
    
    fetch('/dashboard/bounces/api/check', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({emails})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('checkResults').classList.remove('hidden');
            
            const html = `
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <p><strong>Total checked:</strong> ${data.total}</p>
                    <p><strong>Suppressed:</strong> <span class="text-red-600">${data.suppressed_count}</span></p>
                </div>
                <div class="space-y-2">
                    ${data.results.map(r => `
                        <div class="flex items-center justify-between p-3 border rounded-lg ${r.suppressed ? 'border-red-200 bg-red-50' : 'border-green-200 bg-green-50'}">
                            <span>${r.email}</span>
                            <span class="text-sm ${r.suppressed ? 'text-red-600' : 'text-green-600'}">
                                ${r.suppressed ? '⛔ Suppressed' : '✅ OK'}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('checkResultsContent').innerHTML = html;
        }
    });
}
</script>
{% endblock %}
