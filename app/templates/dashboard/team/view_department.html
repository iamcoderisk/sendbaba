{% extends "dashboard/base.html" %}
{% block title %}{{ department.name }} - Team{% endblock %}
{% block page_title %}{{ department.name }}{% endblock %}
{% block page_subtitle %}Department overview and management{% endblock %}

{% block extra_css %}
<style>
.stat-card { background: white; border-radius: 12px; padding: 16px; border: 1px solid #E5E7EB; }
.stat-value { font-size: 1.5rem; font-weight: 700; }
.stat-label { font-size: 12px; color: #6B7280; }
.card { background: white; border-radius: 16px; border: 1px solid #E5E7EB; overflow: hidden; }
.card-header { padding: 16px 20px; border-bottom: 1px solid #E5E7EB; display: flex; justify-content: space-between; align-items: center; }
.card-body { padding: 20px; }
.btn-primary { background: linear-gradient(135deg, #F97316, #EA580C); color: white; padding: 8px 16px; border-radius: 8px; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; font-size: 14px; }
.btn-secondary { background: #F3F4F6; color: #374151; padding: 8px 16px; border-radius: 8px; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; font-size: 14px; }
.avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 13px; }
.badge { padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; }
.badge-active { background: #DCFCE7; color: #166534; }
.badge-draft { background: #F3F4F6; color: #6B7280; }
.badge-sending { background: #FEF3C7; color: #92400E; }
.badge-completed { background: #DBEAFE; color: #1E40AF; }
.progress-bar { height: 8px; background: #E5E7EB; border-radius: 4px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 4px; }
.tab-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 13px; }
.tab-btn.active { background: {{ department.color }}; color: white; }
.tab-btn:not(.active) { background: #F3F4F6; color: #6B7280; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Back Button -->
    <a href="{{ url_for('team.index') }}" class="inline-flex items-center text-gray-500 hover:text-gray-700 mb-4">
        <i class="fas fa-arrow-left mr-2"></i> Back to Team
    </a>

    <!-- Department Header -->
    <div class="card mb-6">
        <div class="card-body">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-2xl flex items-center justify-center" style="background: {{ department.color }}22;">
                    <i class="fas fa-building text-2xl" style="color: {{ department.color }};"></i>
                </div>
                <div class="flex-1">
                    <h1 class="text-2xl font-bold text-gray-900">{{ department.name }}</h1>
                    <p class="text-gray-600">{{ department.description or 'No description' }}</p>
                </div>
                {% if is_owner %}
                <a href="{{ url_for('team.edit_department', dept_id=department.id) }}" class="btn-secondary">
                    <i class="fas fa-edit"></i> Edit
                </a>
                {% endif %}
            </div>
            
            <!-- Quota -->
            <div class="mt-4 p-4 bg-gray-50 rounded-xl">
                {% set quota_pct = (department.emails_sent_this_month / department.email_quota * 100) if department.email_quota > 0 else 0 %}
                <div class="flex justify-between text-sm mb-2">
                    <span class="font-medium">Monthly Email Quota</span>
                    <span>{{ '{:,}'.format(department.emails_sent_this_month) }} / {{ '{:,}'.format(department.email_quota) }} ({{ quota_pct|round(1) }}%)</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ quota_pct|min(100) }}%; background: {{ department.color }};"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <div class="stat-card">
            <div class="stat-value text-blue-600">{{ members|length }}</div>
            <div class="stat-label">Members</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-green-600">{{ contacts|length }}</div>
            <div class="stat-label">Contacts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-purple-600">{{ '{:,}'.format(email_stats.sent) }}</div>
            <div class="stat-label">Emails Sent</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-orange-600">{{ '{:,}'.format(email_stats.opened) }}</div>
            <div class="stat-label">Opened</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-red-600">{{ '{:,}'.format(email_stats.bounced) }}</div>
            <div class="stat-label">Bounced</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-2 mb-4">
        <button class="tab-btn active" onclick="showTab('members')">Members</button>
        <button class="tab-btn" onclick="showTab('contacts')">Contacts</button>
        <button class="tab-btn" onclick="showTab('campaigns')">Campaigns</button>
    </div>

    <!-- Members Tab -->
    <div id="members-tab" class="card">
        <div class="card-header">
            <h3 class="font-bold">Department Members</h3>
            {% if is_owner %}
            <a href="{{ url_for('team.invite_member') }}" class="btn-primary text-sm">
                <i class="fas fa-plus"></i> Add Member
            </a>
            {% endif %}
        </div>
        <div class="card-body p-0">
            {% if members %}
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Member</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Role</th>
                        <th class="px-
# Continue creating view_department.html
cat >> /opt/sendbaba-staging/app/templates/dashboard/team/view_department.html << 'HTMLEOF'
4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Contacts</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Emails/Month</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for member in members %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <div class="avatar" style="background: {{ department.color }};">{{ member.email[0]|upper }}</div>
                                <div>
                                    <div class="font-semibold text-gray-900">{{ member.full_name }}</div>
                                    <div class="text-sm text-gray-500">{{ member.email }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm capitalize">{{ member.role }}</td>
                        <td class="px-4 py-3 text-sm">{{ member.contact_count }}</td>
                        <td class="px-4 py-3 text-sm font-semibold">{{ '{:,}'.format(member.emails_sent_this_month) }}</td>
                        <td class="px-4 py-3">
                            {% if member.is_active %}<span class="badge badge-active">Active</span>
                            {% else %}<span class="badge badge-draft">Inactive</span>{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-8 text-gray-500">No members in this department</div>
            {% endif %}
        </div>
    </div>

    <!-- Contacts Tab -->
    <div id="contacts-tab" class="card" style="display: none;">
        <div class="card-header">
            <h3 class="font-bold">Department Contacts</h3>
            <a href="{{ url_for('team.add_department_contact', dept_id=department.id) }}" class="btn-primary text-sm">
                <i class="fas fa-plus"></i> Add Contact
            </a>
        </div>
        <div class="card-body p-0">
            {% if contacts %}
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Contact</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Owner</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Added</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for contact in contacts %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="font-semibold text-gray-900">{{ contact.name }}</div>
                            <div class="text-sm text-gray-500">{{ contact.email }}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ contact.owner }}</td>
                        <td class="px-4 py-3"><span class="badge badge-active">{{ contact.status }}</span></td>
                        <td class="px-4 py-3 text-sm text-gray-500">{{ contact.created_at.strftime('%b %d, %Y') if contact.created_at else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-8 text-gray-500">No contacts in this department</div>
            {% endif %}
        </div>
    </div>

    <!-- Campaigns Tab -->
    <div id="campaigns-tab" class="card" style="display: none;">
        <div class="card-header">
            <h3 class="font-bold">Department Campaigns</h3>
        </div>
        <div class="card-body p-0">
            {% if campaigns %}
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Campaign</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Sent</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Opened</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Created</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for campaign in campaigns %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-semibold text-gray-900">{{ campaign.name }}</td>
                        <td class="px-4 py-3">
                            <span class="badge badge-{{ campaign.status }}">{{ campaign.status }}</span>
                        </td>
                        <td class="px-4 py-3 text-sm">{{ '{:,}'.format(campaign.emails_sent) }}</td>
                        <td class="px-4 py-3 text-sm">{{ '{:,}'.format(campaign.emails_opened) }}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">{{ campaign.created_at.strftime('%b %d') if campaign.created_at else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-8 text-gray-500">No campaigns for this department</div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function showTab(tab) {
    ['members', 'contacts', 'campaigns'].forEach(t => {
        document.getElementById(t + '-tab').style.display = t === tab ? 'block' : 'none';
    });
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}
</script>
{% endblock %}
