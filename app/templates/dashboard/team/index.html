{% extends "dashboard/base.html" %}
{% block title %}Team Management - SendBaba{% endblock %}
{% block page_title %}Team Management{% endblock %}
{% block page_subtitle %}Manage departments and team members{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary: #F97316;
    --primary-dark: #EA580C;
    --primary-light: #FFF7ED;
    --primary-glow: rgba(249, 115, 22, 0.25);
}
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 28px; }
.stat-card {
    background: white; border-radius: 20px; padding: 24px;
    border: 1px solid #E5E7EB; transition: all 0.3s ease;
    position: relative; overflow: hidden;
}
.stat-card::after {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--primary-dark));
    transform: scaleX(0); transition: transform 0.3s;
}
.stat-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px var(--primary-glow); border-color: var(--primary); }
.stat-card:hover::after { transform: scaleX(1); }
.stat-icon {
    width: 52px; height: 52px; border-radius: 14px;
    background: var(--primary-light); color: var(--primary);
    display: flex; align-items: center; justify-content: center;
    font-size: 22px; margin-bottom: 16px; transition: all 0.3s;
}
.stat-card:hover .stat-icon { background: var(--primary); color: white; transform: scale(1.1) rotate(-5deg); }
.stat-value { font-size: 2.25rem; font-weight: 800; color: #111827; line-height: 1; }
.stat-label { font-size: 14px; color: #6B7280; margin-top: 6px; }
.action-bar {
    display: flex; flex-wrap: wrap; gap: 12px; padding: 20px; margin-bottom: 28px;
    background: linear-gradient(135deg, var(--primary-light), #FFEDD5);
    border-radius: 20px; border: 2px solid #FDBA74;
}
.btn {
    padding: 12px 22px; border-radius: 12px; font-weight: 600;
    text-decoration: none; display: inline-flex; align-items: center; gap: 8px;
    border: none; cursor: pointer; font-size: 14px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white; box-shadow: 0 4px 15px var(--primary-glow);
}
.btn-primary:hover { transform: translateY(-3px); box-shadow: 0 8px 25px var(--primary-glow); }
.btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); }
.btn-outline:hover { background: var(--primary); color: white; transform: translateY(-3px); }
.btn-sm { padding: 10px 16px; font-size: 13px; }
.section {
    background: white; border-radius: 20px; border: 1px solid #E5E7EB;
    margin-bottom: 28px; box-shadow: 0 4px 15px rgba(0,0,0,0.04); overflow: hidden;
}
.section-head {
    padding: 20px 24px; background: #FAFAFA; border-bottom: 1px solid #E5E7EB;
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;
}
.section-title { font-size: 18px; font-weight: 700; color: #111827; display: flex; align-items: center; gap: 10px; }
.section-title i { color: var(--primary); }
.section-body { padding: 24px; }
.dept-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
.dept-card {
    background: linear-gradient(135deg, #FAFAFA, #F3F4F6); border-radius: 16px; padding: 20px;
    border: 2px solid #E5E7EB; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: block; text-decoration: none; color: inherit;
}
.dept-card:hover { border-color: var(--primary); transform: translateY(-8px) scale(1.02); box-shadow: 0 25px 50px var(--primary-glow); }
.dept-icon { width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.3s; }
.dept-card:hover .dept-icon { transform: scale(1.15) rotate(-8deg); }
.dept-name { font-size: 17px; font-weight: 700; color: #111827; }
.dept-meta { font-size: 13px; color: #6B7280; margin-top: 2px; }
.dept-desc { font-size: 14px; color: #4B5563; margin: 14px 0; line-height: 1.5; }
.progress-wrap { margin-top: 14px; }
.progress-info { display: flex; justify-content: space-between; font-size: 12px; color: #6B7280; margin-bottom: 6px; }
.progress-bar { height: 6px; background: #E5E7EB; border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-dark)); border-radius: 3px; transition: width 0.5s; }
.dept-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 14px; padding-top: 14px; border-top: 1px solid #E5E7EB; }
.dept-link { font-size: 13px; font-weight: 600; color: var(--primary); }
.member-head { display: none; padding: 14px 24px; background: #F9FAFB; border-bottom: 1px solid #E5E7EB; font-size: 11px; font-weight: 600; color: #6B7280; text-transform: uppercase; }
@media(min-width:768px) { .member-head { display: flex; align-items: center; } }
.member-row { display: flex; align-items: center; padding: 16px 24px; border-bottom: 1px solid #F3F4F6; transition: all 0.2s; flex-wrap: wrap; gap: 12px; }
.member-row:last-child { border-bottom: none; }
.member-row:hover { background: var(--primary-light); }
.avatar { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 16px; flex-shrink: 0; transition: transform 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.member-row:hover .avatar { transform: scale(1.1); }
.member-info { flex: 1; min-width: 180px; display: flex; align-items: center; gap: 12px; }
.member-name { font-weight: 600; color: #111827; }
.member-email { font-size: 13px; color: #6B7280; }
.badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
.badge-active { background: #D1FAE5; color: #065F46; }
.badge-pending { background: #FEF3C7; color: #92400E; }
.badge-role { background: var(--primary-light); color: var(--primary-dark); }
.dept-select { padding: 8px 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 13px; background: white; cursor: pointer; transition: all 0.2s; min-width: 130px; }
.dept-select:hover, .dept-select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px var(--primary-glow); }
.action-btn { width: 34px; height: 34px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; border: none; cursor: pointer; background: transparent; transition: all 0.2s; }
.action-btn:hover { transform: scale(1.15); }
.action-btn.edit { color: var(--primary); }
.action-btn.edit:hover { background: var(--primary-light); }
.action-btn.delete { color: #EF4444; }
.action-btn.delete:hover { background: #FEE2E2; }
.empty { text-align: center; padding: 50px 20px; }
.empty-icon { width: 70px; height: 70px; border-radius: 18px; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 28px; animation: float 3s ease-in-out infinite; }
@keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
.empty-title { font-size: 18px; font-weight: 700; color: #111827; margin-bottom: 8px; }
.empty-desc { color: #6B7280; margin-bottom: 20px; max-width: 350px; margin-left: auto; margin-right: auto; }
@media(max-width:768px) { .member-row { flex-direction: column; align-items: flex-start; } .dept-grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon"><i class="fas fa-building"></i></div><div class="stat-value">{{ stats.total_departments }}</div><div class="stat-label">Departments</div></div>
        <div class="stat-card"><div class="stat-icon"><i class="fas fa-users"></i></div><div class="stat-value">{{ stats.total_members }}</div><div class="stat-label">Team Members</div></div>
        <div class="stat-card"><div class="stat-icon"><i class="fas fa-check-circle"></i></div><div class="stat-value">{{ stats.active_members }}</div><div class="stat-label">Active</div></div>
        <div class="stat-card"><div class="stat-icon"><i class="fas fa-clock"></i></div><div class="stat-value">{{ stats.pending_invitations }}</div><div class="stat-label">Pending</div></div>
    </div>
    <div class="action-bar">
        <a href="{{ url_for('team.create_department') }}" class="btn btn-primary"><i class="fas fa-building"></i> Create Department</a>
        <a href="{{ url_for('team.invite_member') }}" class="btn btn-primary"><i class="fas fa-user-plus"></i> Invite Member</a>
        <a href="{{ url_for('team.send_single_email') }}" class="btn btn-outline"><i class="fas fa-envelope"></i> Send Email</a>
        <a href="{{ url_for('team.billing') }}" class="btn btn-outline"><i class="fas fa-chart-bar"></i> Usage</a>
    </div>
    <div class="section">
        <div class="section-head">
            <div class="section-title"><i class="fas fa-building"></i> Departments ({{ departments|length }})</div>
            <a href="{{ url_for('team.create_department') }}" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add</a>
        </div>
        <div class="section-body">
            {% if departments %}
            <div class="dept-grid">
                {% for d in departments %}
                <a href="{{ url_for('team.view_department', dept_id=d.id) }}" class="dept-card">
                    <div style="display:flex;gap:14px;align-items:flex-start;margin-bottom:8px;">
                        <div class="dept-icon" style="background:{{ d.color }}22;color:{{ d.color }};"><i class="fas fa-building"></i></div>
                        <div style="flex:1;min-width:0;"><div class="dept-name">{{ d.name }}</div><div class="dept-meta">{{ d.member_count }} members Â· {{ d.contact_count }} contacts</div></div>
                    </div>
                    <div class="dept-desc">{{ d.description or 'No description' }}</div>
                    <div class="progress-wrap">
                        {% set pct = (d.emails_sent_this_month / d.email_quota * 100) if d.email_quota > 0 else 0 %}
                        {% set pct_capped = pct if pct <= 100 else 100 %}
                        <div class="progress-info"><span>{{ d.emails_sent_this_month }} / {{ d.email_quota }}</span><span>{{ pct|round(1) }}%</span></div>
                        <div class="progress-bar"><div class="progress-fill" style="width:{{ pct_capped }}%;"></div></div>
                    </div>
                    <div class="dept-footer"><span style="font-size:12px;color:#6B7280;"><i class="fas fa-envelope"></i> {{ d.total_emails }} sent</span><span class="dept-link">View <i class="fas fa-arrow-right"></i></span></div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty"><div class="empty-icon"><i class="fas fa-building"></i></div><div class="empty-title">No Departments</div><div class="empty-desc">Create departments to organize your team.</div><a href="{{ url_for('team.create_department') }}" class="btn btn-primary"><i class="fas fa-plus"></i> Create</a></div>
            {% endif %}
        </div>
    </div>
    <div class="section">
        <div class="section-head">
            <div class="section-title"><i class="fas fa-users"></i> Team Members ({{ members|length }})</div>
            <a href="{{ url_for('team.invite_member') }}" class="btn btn-primary btn-sm"><i class="fas fa-user-plus"></i> Invite</a>
        </div>
        {% if members %}
        <div class="member-head"><div style="flex:1;">Member</div><div style="width:150px;">Department</div><div style="width:90px;">Role</div><div style="width:90px;">Status</div><div style="width:80px;text-align:right;">Actions</div></div>
        {% for m in members %}
        <div class="member-row">
            <div class="member-info"><div class="avatar" style="background:linear-gradient(135deg,{{ m.department_color }},{{ m.department_color }}dd);">{{ m.email[0]|upper }}</div><div><div class="member-name">{{ m.full_name }}</div><div class="member-email">{{ m.email }}</div></div></div>
            <div style="width:150px;"><form action="{{ url_for('team.change_department', mid=m.id) }}" method="POST" style="margin:0;"><select name="department_id" class="dept-select" onchange="this.form.submit()"><option value="">Unassigned</option>{% for dept in departments %}<option value="{{ dept.id }}" {% if dept.id == m.department_id %}selected{% endif %}>{{ dept.name }}</option>{% endfor %}</select></form></div>
            <div style="width:90px;"><span class="badge badge-role">{{ (m.role or 'member')|capitalize }}</span></div>
            <div style="width:90px;">{% if m.invitation_accepted %}<span class="badge badge-active"><i class="fas fa-check"></i> Active</span>{% else %}<span class="badge badge-pending"><i class="fas fa-clock"></i> Pending</span>{% endif %}</div>
            <div style="width:80px;text-align:right;"><a href="{{ url_for('team.edit_member', mid=m.id) }}" class="action-btn edit"><i class="fas fa-edit"></i></a><form action="{{ url_for('team.delete_member', mid=m.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Remove?');"><button class="action-btn delete"><i class="fas fa-trash"></i></button></form></div>
        </div>
        {% endfor %}
        {% else %}
        <div class="section-body"><div class="empty"><div class="empty-icon"><i class="fas fa-users"></i></div><div class="empty-title">No Members</div><div class="empty-desc">Invite team members to collaborate.</div><a href="{{ url_for('team.invite_member') }}" class="btn btn-primary"><i class="fas fa-user-plus"></i> Invite</a></div></div>
        {% endif %}
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.stat-card, .dept-card, .member-row').forEach((el, i) => {
        el.style.opacity = '0'; el.style.transform = 'translateY(20px)';
        setTimeout(() => { el.style.transition = 'all 0.4s ease'; el.style.opacity = '1'; el.style.transform = 'translateY(0)'; }, i * 60);
    });
});
</script>
{% endblock %}
