{% extends "dashboard/base.html" %}
{% block title %}Send Email - SendBaba{% endblock %}
{% block page_title %}Send Email{% endblock %}
{% block page_subtitle %}Compose and send personalized emails{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary: #F97316;
    --primary-dark: #EA580C;
    --primary-light: #FFF7ED;
    --gray-50: #F9FAFB;
    --gray-100: #F3F4F6;
    --gray-200: #E5E7EB;
    --gray-300: #D1D5DB;
    --gray-500: #6B7280;
    --gray-700: #374151;
    --gray-900: #111827;
    --success: #10B981;
    --error: #EF4444;
    --warning: #F59E0B;
}

* { box-sizing: border-box; }

.alert-banner {
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.alert-banner.warning {
    background: #FEF3C7;
    border: 1px solid #F59E0B;
    color: #92400E;
}

.alert-banner.error {
    background: #FEE2E2;
    border: 1px solid #EF4444;
    color: #991B1B;
}

.alert-banner i { font-size: 20px; }
.alert-banner a { color: var(--primary); font-weight: 600; text-decoration: underline; }

.email-composer {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 24px;
    min-height: calc(100vh - 200px);
}

@media (max-width: 1100px) {
    .email-composer { grid-template-columns: 1fr; }
}

.card {
    background: white;
    border-radius: 16px;
    border: 1px solid var(--gray-200);
    overflow: hidden;
}

.card-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--gray-100);
    background: var(--gray-50);
}

.card-header h3 {
    font-size: 15px;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-header h3 i { color: var(--primary); }
.card-body { padding: 24px; }

.form-section {
    margin-bottom: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--gray-100);
}

.form-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.form-section-title {
    font-size: 12px;
    font-weight: 700;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 16px;
}

.form-group { margin-bottom: 16px; }
.form-group:last-child { margin-bottom: 0; }

.form-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 13px;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 8px;
}

.form-label .required { color: var(--error); }

.form-input, .form-select {
    width: 100%;
    padding: 12px 14px;
    border: 2px solid var(--gray-200);
    border-radius: 10px;
    font-size: 14px;
    transition: all 0.2s;
    background: white;
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.1);
}

.form-input:disabled, .form-select:disabled {
    background: var(--gray-100);
    cursor: not-allowed;
    color: var(--gray-500);
}

.form-input::placeholder { color: var(--gray-300); }

.form-input-group {
    display: flex;
    gap: 8px;
}

.form-input-group .form-input { flex: 1; }
.form-input-group .form-select { width: 200px; flex-shrink: 0; }

.form-help {
    font-size: 12px;
    color: var(--gray-500);
    margin-top: 6px;
}

.form-help.warning { color: var(--warning); }
.form-help a { color: var(--primary); text-decoration: underline; }

.autocomplete-wrapper { position: relative; }

.autocomplete-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 12px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    max-height: 220px;
    overflow-y: auto;
    z-index: 100;
    display: none;
}

.autocomplete-dropdown.show { display: block; }

.autocomplete-item {
    padding: 12px 14px;
    cursor: pointer;
    border-bottom: 1px solid var(--gray-100);
    transition: background 0.15s;
}

.autocomplete-item:last-child { border-bottom: none; }
.autocomplete-item:hover { background: var(--primary-light); }
.autocomplete-item .name { font-weight: 600; color: var(--gray-900); font-size: 14px; }
.autocomplete-item .email { font-size: 12px; color: var(--gray-500); margin-top: 2px; }

.template-picker { margin-bottom: 24px; }

.template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
}

.template-card {
    background: var(--gray-50);
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 16px 10px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
}

.template-card:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(249,115,22,0.12);
}

.template-card.selected {
    border-color: var(--primary);
    background: var(--primary-light);
}

.template-icon {
    width: 44px;
    height: 44px;
    background: white;
    border-radius: 10px;
    margin: 0 auto 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

.template-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-900);
}

.editor-panel {
    display: flex;
    flex-direction: column;
}

.editor-toolbar {
    background: var(--gray-50);
    padding: 12px 16px;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    align-items: center;
}

.toolbar-group {
    display: flex;
    gap: 4px;
    align-items: center;
}

.toolbar-divider {
    width: 1px;
    height: 24px;
    background: var(--gray-200);
    margin: 0 8px;
}

.toolbar-btn {
    width: 34px;
    height: 34px;
    border: none;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-700);
    transition: all 0.15s;
    font-size: 13px;
}

.toolbar-btn:hover {
    background: var(--primary);
    color: white;
}

.toolbar-select {
    height: 34px;
    padding: 0 10px;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    font-size: 12px;
    background: white;
}

.toolbar-color {
    width: 34px;
    height: 34px;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    padding: 4px;
    cursor: pointer;
}

.editor-content {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
    min-height: 400px;
}

#emailEditor {
    min-height: 350px;
    outline: none;
    font-family: Arial, sans-serif;
    font-size: 15px;
    line-height: 1.7;
    color: var(--gray-700);
}

#emailEditor:empty:before {
    content: 'Start writing your email content here...';
    color: var(--gray-300);
}

.merge-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.merge-tag {
    background: #EDE9FE;
    color: #6D28D9;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    border: none;
}

.merge-tag:hover {
    background: #6D28D9;
    color: white;
}

.btn-send {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    width: 100%;
    padding: 16px;
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.2s;
    margin-top: 20px;
}

.btn-send:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px rgba(249, 115, 22, 0.35);
}

.btn-send:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: var(--gray-400);
}

.btn-send .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.recent-list { margin-top: 20px; }

.recent-item {
    padding: 14px;
    background: var(--gray-50);
    border-radius: 10px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

.recent-item:hover { background: var(--primary-light); }

.recent-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 6px;
}

.recent-to { font-weight: 600; color: var(--gray-900); font-size: 13px; }
.recent-subject { font-size: 12px; color: var(--gray-500); margin-top: 4px; }
.recent-date { font-size: 11px; color: var(--gray-400); }

.status-badge {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
}

.status-sent { background: #D1FAE5; color: #065F46; }
.status-queued { background: #FEF3C7; color: #92400E; }
.status-failed { background: #FEE2E2; color: #991B1B; }
.status-sending { background: #DBEAFE; color: #1E40AF; }

.toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: var(--gray-900);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s;
    z-index: 1000;
}

.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { background: #065F46; }
.toast.error { background: #991B1B; }

@media (max-width: 768px) {
    .form-input-group { flex-direction: column; }
    .form-input-group .form-select { width: 100%; }
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-6">
        <a href="{{ url_for('team.index') }}" class="inline-flex items-center text-gray-500 hover:text-orange-500 font-medium transition">
            <i class="fas fa-arrow-left mr-2"></i>Back to Team
        </a>
    </div>
    
    {% if not domains or domains|length == 0 %}
    <div class="alert-banner error">
        <i class="fas fa-exclamation-circle"></i>
        <div>
            <strong>No verified sending domain!</strong> You must add and verify a domain before you can send emails.
            <a href="{{ url_for('domain.list_domains') }}">Go to Domains ‚Üí</a>
        </div>
    </div>
    {% endif %}
    
    {% if templates %}
    <div class="card template-picker">
        <div class="card-header">
            <h3><i class="fas fa-palette"></i> Choose a Template</h3>
        </div>
        <div class="card-body">
            <div class="template-grid">
                {% for template in templates %}
                <div class="template-card{% if loop.first %} selected{% endif %}" 
                     data-template-id="{{ template.id }}" 
                     onclick="selectTemplate({{ template.id }})">
                    <div class="template-icon">
                        {% if template.category == 'welcome' %}üéâ
                        {% elif template.category == 'followup' %}üìã
                        {% elif template.category == 'thankyou' %}üíö
                        {% elif template.category == 'blank' %}üìù
                        {% else %}‚úâÔ∏è{% endif %}
                    </div>
                    <div class="template-name">{{ template.name }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="email-composer">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-cog"></i> Email Settings</h3>
            </div>
            <div class="card-body">
                <div class="form-section">
                    <div class="form-section-title">Sender Information</div>
                    
                    <div class="form-group">
                        <label class="form-label">From Name</label>
                        <input type="text" id="fromName" class="form-input" 
                               placeholder="Your Name or Company" value="{{ user_name }}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            From Email <span class="required">*</span>
                        </label>
                        {% if domains and domains|length > 0 %}
                        <div class="form-input-group">
                            <input type="text" id="fromEmailUser" class="form-input" placeholder="noreply" value="noreply">
                            <select id="fromEmailDomain" class="form-select">
                                {% for domain in domains %}
                                <option value="{{ domain.domain }}">@{{ domain.domain }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <p class="form-help">Using your verified domain</p>
                        {% else %}
                        <input type="text" class="form-input" placeholder="No verified domain available" disabled>
                        <p class="form-help warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <a href="{{ url_for('domain.list_domains') }}">Add and verify a domain</a> to send emails
                        </p>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Reply-To <span class="text-xs text-gray-400">(Optional)</span></label>
                        <input type="email" id="replyTo" class="form-input" 
                               placeholder="replies@yourdomain.com" value="{{ user_email }}">
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">Recipient</div>
                    
                    <div class="form-group autocomplete-wrapper">
                        <label class="form-label">To <span class="required">*</span></label>
                        <input type="email" id="recipientEmail" class="form-input" 
                               placeholder="recipient@example.com" autocomplete="off"
                               {% if not domains %}disabled{% endif %}>
                        <div class="autocomplete-dropdown" id="contactDropdown"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Recipient Name</label>
                        <input type="text" id="recipientName" class="form-input" placeholder="John Doe"
                               {% if not domains %}disabled{% endif %}>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">Content</div>
                    
                    <div class="form-group">
                        <label class="form-label">Subject Line <span class="required">*</span></label>
                        <input type="text" id="emailSubject" class="form-input" placeholder="Enter your email subject"
                               {% if not domains %}disabled{% endif %}>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">Personalization Tags</div>
                    <p class="text-xs text-gray-500 mb-3">Click to insert into email body</p>
                    <div class="merge-tags">
                        <button type="button" class="merge-tag" onclick="insertMergeTag('{{first_name}}')" {% if not domains %}disabled{% endif %}>first_name</button>
                        <button type="button" class="merge-tag" onclick="insertMergeTag('{{name}}')" {% if not domains %}disabled{% endif %}>name</button>
                        <button type="button" class="merge-tag" onclick="insertMergeTag('{{email}}')" {% if not domains %}disabled{% endif %}>email</button>
                        <button type="button" class="merge-tag" onclick="insertMergeTag('{{company}}')" {% if not domains %}disabled{% endif %}>company</button>
                    </div>
                </div>
                
                <button type="button" id="sendBtn" class="btn-send" onclick="sendEmail()" 
                        {% if not domains or domains|length == 0 %}disabled{% endif %}>
                    <i class="fas fa-paper-plane"></i>
                    <span>{% if domains and domains|length > 0 %}Send Email{% else %}Add Domain to Send{% endif %}</span>
                </button>
                
                {% if recent_emails %}
                <div class="recent-list">
                    <div class="form-section-title" style="margin-top: 24px;">Recent Sends</div>
                    {% for email in recent_emails[:5] %}
                    <div class="recent-item" onclick="reuseEmail('{{ email.recipient_email }}', '{{ email.recipient_name or '' }}', '{{ email.subject }}')">
                        <div class="recent-header">
                            <span class="recent-to">{{ email.recipient_email[:25] }}...</span>
                            <span class="status-badge status-{{ email.status }}">{{ email.status }}</span>
                        </div>
                        <div class="recent-subject">{{ email.subject[:35] }}...</div>
                        <div class="recent-date">{{ email.created_at.strftime('%b %d, %I:%M %p') if email.created_at else '' }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card editor-panel">
            <div class="editor-toolbar">
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" onclick="execCmd('bold')" title="Bold"><i class="fas fa-bold"></i></button>
                    <button type="button" class="toolbar-btn" onclick="execCmd('italic')" title="Italic"><i class="fas fa-italic"></i></button>
                    <button type="button" class="toolbar-btn" onclick="execCmd('underline')" title="Underline"><i class="fas fa-underline"></i></button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" onclick="execCmd('justifyLeft')"><i class="fas fa-align-left"></i></button>
                    <button type="button" class="toolbar-btn" onclick="execCmd('justifyCenter')"><i class="fas fa-align-center"></i></button>
                    <button type="button" class="toolbar-btn" onclick="execCmd('justifyRight')"><i class="fas fa-align-right"></i></button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" onclick="execCmd('insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
                    <button type="button" class="toolbar-btn" onclick="execCmd('insertOrderedList')"><i class="fas fa-list-ol"></i></button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" onclick="addLink()" title="Insert Link"><i class="fas fa-link"></i></button>
                    <button type="button" class="toolbar-btn" onclick="addImage()" title="Insert Image"><i class="fas fa-image"></i></button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <select class="toolbar-select" onchange="execCmd('fontSize', this.value); this.selectedIndex=0;">
                        <option value="">Size</option>
                        <option value="1">Small</option>
                        <option value="3">Normal</option>
                        <option value="5">Large</option>
                    </select>
                    <input type="color" class="toolbar-color" onchange="execCmd('foreColor', this.value);" value="#374151" title="Text Color">
                </div>
            </div>
            
            <div class="editor-content">
                <div id="emailEditor" contenteditable="{% if domains %}true{% else %}false{% endif %}"></div>
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast">
    <i class="fas fa-check-circle" id="toastIcon"></i>
    <span id="toastMessage">Message</span>
</div>

<script>
const contacts = {{ contacts|tojson|safe }};
const templates = {{ templates|tojson|safe }};
const hasDomains = {{ 'true' if domains and domains|length > 0 else 'false' }};

const recipientEmailInput = document.getElementById('recipientEmail');
const recipientNameInput = document.getElementById('recipientName');
const dropdown = document.getElementById('contactDropdown');
const editor = document.getElementById('emailEditor');
const sendBtn = document.getElementById('sendBtn');

document.addEventListener('DOMContentLoaded', () => {
    if (templates.length > 0) {
        loadTemplateContent(templates[0]);
    }
});

function loadTemplateContent(template) {
    editor.innerHTML = template.html_content || '<p>Start writing your email...</p>';
    if (template.subject) {
        document.getElementById('emailSubject').value = template.subject;
    }
}

function selectTemplate(templateId) {
    document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
    document.querySelector(`[data-template-id="${templateId}"]`)?.classList.add('selected');
    
    fetch(`/dashboard/team/api/template/${templateId}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) loadTemplateContent(data.template);
        })
        .catch(console.error);
}

if (recipientEmailInput) {
    recipientEmailInput.addEventListener('input', function() {
        const q = this.value.toLowerCase();
        if (q.length < 1) { dropdown.classList.remove('show'); return; }
        
        const matches = contacts.filter(c => 
            c.email.toLowerCase().includes(q) || c.name.toLowerCase().includes(q)
        ).slice(0, 6);
        
        if (matches.length) {
            dropdown.innerHTML = matches.map(c => `
                <div class="autocomplete-item" data-email="${c.email}" data-name="${c.name}">
                    <div class="name">${c.name || c.email.split('@')[0]}</div>
                    <div class="email">${c.email}</div>
                </div>
            `).join('');
            dropdown.classList.add('show');
        } else {
            dropdown.classList.remove('show');
        }
    });
}

dropdown?.addEventListener('click', function(e) {
    const item = e.target.closest('.autocomplete-item');
    if (item) {
        recipientEmailInput.value = item.dataset.email;
        recipientNameInput.value = item.dataset.name || '';
        dropdown.classList.remove('show');
        document.getElementById('emailSubject').focus();
    }
});

document.addEventListener('click', e => {
    if (recipientEmailInput && !recipientEmailInput.contains(e.target) && !dropdown?.contains(e.target)) {
        dropdown?.classList.remove('show');
    }
});

function execCmd(cmd, val = null) {
    document.execCommand(cmd, false, val);
    editor.focus();
}

function addLink() {
    const url = prompt('Enter URL:', 'https://');
    if (url) execCmd('createLink', url);
}

function addImage() {
    const url = prompt('Enter image URL:', 'https://');
    if (url) execCmd('insertImage', url);
}

function insertMergeTag(tag) {
    editor.focus();
    document.execCommand('insertText', false, tag);
}

function reuseEmail(email, name, subject) {
    if (!hasDomains) return;
    recipientEmailInput.value = email;
    recipientNameInput.value = name;
    document.getElementById('emailSubject').value = subject;
}

function showToast(msg, type = 'success') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toastIcon');
    const message = document.getElementById('toastMessage');
    
    toast.className = 'toast ' + type;
    icon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
    message.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 4000);
}

function getFromEmail() {
    if (!hasDomains) return null;
    const userPart = document.getElementById('fromEmailUser');
    const domainPart = document.getElementById('fromEmailDomain');
    if (userPart && domainPart) {
        return `${userPart.value.trim() || 'noreply'}@${domainPart.value}`;
    }
    return null;
}

async function sendEmail() {
    if (!hasDomains) {
        showToast('Please add and verify a domain first', 'error');
        return;
    }
    
    const fromName = document.getElementById('fromName').value.trim();
    const fromEmail = getFromEmail();
    const replyTo = document.getElementById('replyTo').value.trim();
    const recipientEmail = recipientEmailInput.value.trim();
    const recipientName = recipientNameInput.value.trim();
    const subject = document.getElementById('emailSubject').value.trim();
    const htmlBody = editor.innerHTML;
    const textBody = editor.innerText;
    
    if (!fromEmail) { showToast('From email is required', 'error'); return; }
    if (!recipientEmail) { showToast('Recipient email is required', 'error'); recipientEmailInput.focus(); return; }
    if (!subject) { showToast('Subject is required', 'error'); document.getElementById('emailSubject').focus(); return; }
    
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<div class="spinner"></div><span>Sending...</span>';
    
    try {
        const res = await fetch('/dashboard/team/send-email/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                from_name: fromName,
                from_email: fromEmail,
                reply_to: replyTo || fromEmail,
                recipient_email: recipientEmail,
                recipient_name: recipientName,
                subject: subject,
                html_body: htmlBody,
                text_body: textBody
            })
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast(`Email queued for ${recipientEmail}!`, 'success');
            recipientEmailInput.value = '';
            recipientNameInput.value = '';
            document.getElementById('emailSubject').value = '';
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.error || 'Failed to send', 'error');
        }
    } catch (err) {
        console.error(err);
        showToast('Network error', 'error');
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i><span>Send Email</span>';
    }
}

document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Enter' && hasDomains) {
        e.preventDefault();
        sendEmail();
    }
});
</script>
{% endblock %}
