{% extends "dashboard/base.html" %}
{% block title %}Forms - SendBaba{% endblock %}
{% block page_title %}Forms{% endblock %}
{% block page_subtitle %}Create signup forms to grow your list{% endblock %}

{% block extra_css %}
<style>
:root{--primary:#F97316}
.form-card{background:#fff;border:1px solid #E5E7EB;border-radius:16px;padding:20px;transition:all .3s}
.form-card:hover{border-color:#FDBA74;transform:translateY(-4px);box-shadow:0 20px 40px -12px rgba(249,115,22,.2)}
.form-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px}
.status-badge{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
.status-active{background:#DCFCE7;color:#166534}
.status-draft{background:#F3F4F6;color:#4B5563}
.status-paused{background:#FEF3C7;color:#92400E}
.stat-item{text-align:center;padding:0 16px;border-right:1px solid #E5E7EB}
.stat-item:last-child{border-right:none}
.stat-value{font-size:1.4rem;font-weight:700}
.stat-label{font-size:11px;color:#9CA3AF;text-transform:uppercase}
.action-btn{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9CA3AF;background:transparent;border:none;cursor:pointer;transition:all .2s}
.action-btn:hover{background:#FFF7ED;color:var(--primary)}
.action-btn.delete:hover{background:#FEE2E2;color:#DC2626}
.btn-primary{background:linear-gradient(135deg,var(--primary),#EA580C);color:#fff;padding:12px 24px;border-radius:12px;font-weight:600;border:none;cursor:pointer;display:inline-flex;align-items:center;gap:8px;text-decoration:none}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(249,115,22,.3)}
.dropdown-menu{position:absolute;right:0;top:100%;margin-top:8px;background:#fff;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.15);min-width:220px;z-index:50;display:none}
.dropdown-menu.active{display:block}
.dropdown-item{display:block;padding:14px 20px;color:#374151;text-decoration:none;border-bottom:1px solid #F3F4F6}
.dropdown-item:hover{background:#FFF7ED}
.empty-state{text-align:center;padding:60px 20px;background:#fff;border-radius:20px;border:2px dashed #E5E7EB}
.toast-container{position:fixed;bottom:24px;right:24px;z-index:9999}
.toast{background:#fff;padding:16px 20px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.15);display:flex;align-items:center;gap:12px;margin-top:8px;animation:slideIn .3s}
@keyframes slideIn{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
        <div></div>
        <div class="relative" id="createDropdown">
            <button onclick="document.getElementById('createMenu').classList.toggle('active')" class="btn-primary">
                <i class="fas fa-plus"></i> Create Form <i class="fas fa-chevron-down text-xs opacity-70"></i>
            </button>
            <div id="createMenu" class="dropdown-menu">
                <a href="/dashboard/forms/create?type=inline" class="dropdown-item"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center"><i class="fas fa-align-left text-orange-600"></i></div><div><div class="font-semibold">Inline Form</div><div class="text-sm text-gray-500">Embed in website</div></div></div></a>
                <a href="/dashboard/forms/create?type=popup" class="dropdown-item"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center"><i class="fas fa-window-restore text-blue-600"></i></div><div><div class="font-semibold">Pop-up</div><div class="text-sm text-gray-500">Modal overlay</div></div></div></a>
                <a href="/dashboard/forms/create?type=slide_in" class="dropdown-item"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center"><i class="fas fa-comment text-green-600"></i></div><div><div class="font-semibold">Slide-in</div><div class="text-sm text-gray-500">Corner widget</div></div></div></a>
            </div>
        </div>
    </div>

    <div id="formsList" class="space-y-4"></div>
    <div id="loadingState" class="text-center py-12"><i class="fas fa-spinner fa-spin text-3xl text-orange-500"></i></div>
    <div id="emptyState" class="hidden empty-state">
        <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-file-alt text-3xl text-orange-400"></i></div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">No forms yet</h3>
        <p class="text-gray-500 mb-6">Create your first form to collect subscribers</p>
        <a href="/dashboard/forms/create?type=inline" class="btn-primary"><i class="fas fa-plus"></i> Create Form</a>
    </div>
</div>

<div id="embedModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4" onclick="if(event.target===this)this.classList.add('hidden')">
    <div class="bg-white rounded-2xl max-w-lg w-full p-6">
        <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Embed Code</h3><button onclick="document.getElementById('embedModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div>
        <div class="bg-gray-900 rounded-xl p-4 mb-4"><pre id="embedCode" class="text-sm text-green-400 font-mono whitespace-pre-wrap"></pre></div>
        <button onclick="navigator.clipboard.writeText(document.getElementById('embedCode').textContent);showToast('Copied!','success')" class="btn-primary w-full justify-center"><i class="fas fa-copy"></i> Copy Code</button>
    </div>
</div>

<div id="toastContainer" class="toast-container"></div>

<script>
async function loadForms(){
    try{
        const r=await fetch('/dashboard/forms/api/list');
        const d=await r.json();
        document.getElementById('loadingState').classList.add('hidden');
        if(!d.forms||d.forms.length===0){document.getElementById('emptyState').classList.remove('hidden');return;}
        const icons={inline:'fa-align-left',popup:'fa-window-restore',slide_in:'fa-comment',sticky_bar:'fa-minus'};
        const colors={inline:'bg-orange-100 text-orange-600',popup:'bg-blue-100 text-blue-600',slide_in:'bg-green-100 text-green-600',sticky_bar:'bg-purple-100 text-purple-600'};
        document.getElementById('formsList').innerHTML=d.forms.map(f=>`
            <div class="form-card">
                <div class="flex flex-col md:flex-row md:items-center gap-4">
                    <div class="flex items-center gap-4 flex-1">
                        <div class="form-icon ${colors[f.form_type]||'bg-gray-100'}"><i class="fas ${icons[f.form_type]||'fa-file'}"></i></div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-gray-900 truncate">${f.name}</h3>
                            <div class="flex items-center gap-3 mt-1">
                                <span class="text-sm text-gray-500 capitalize">${(f.form_type||'').replace('_',' ')}</span>
                                <span class="status-badge status-${f.status}">${f.status}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="stat-item"><div class="stat-value">${f.views||0}</div><div class="stat-label">Views</div></div>
                        <div class="stat-item"><div class="stat-value">${f.submissions||0}</div><div class="stat-label">Leads</div></div>
                        <div class="stat-item border-none"><div class="stat-value text-green-600">${f.conversion_rate||0}%</div><div class="stat-label">CVR</div></div>
                    </div>
                    <div class="flex items-center gap-1 ml-4">
                        <button onclick="showEmbed('${f.id}')" class="action-btn" title="Embed"><i class="fas fa-code"></i></button>
                        <a href="/dashboard/forms/${f.id}/edit" class="action-btn" title="Edit"><i class="fas fa-edit"></i></a>
                        <a href="/dashboard/forms/${f.id}/submissions" class="action-btn" title="Submissions"><i class="fas fa-list"></i></a>
                        <button onclick="toggleStatus('${f.id}')" class="action-btn" title="Toggle"><i class="fas fa-${f.status==='active'?'pause':'play'}"></i></button>
                        <button onclick="deleteForm('${f.id}')" class="action-btn delete" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>
        `).join('');
    }catch(e){console.error(e);document.getElementById('loadingState').innerHTML='<p class="text-red-500">Failed to load</p>';}
}
async function showEmbed(id){const r=await fetch('/dashboard/forms/api/'+id+'/embed-code');const d=await r.json();document.getElementById('embedCode').textContent=d.embed_code||'';document.getElementById('embedModal').classList.remove('hidden');document.getElementById('embedModal').classList.add('flex');}
async function toggleStatus(id){await fetch('/dashboard/forms/api/'+id+'/toggle-status',{method:'POST'});loadForms();}
async function deleteForm(id){if(!confirm('Delete this form?'))return;await fetch('/dashboard/forms/api/'+id,{method:'DELETE'});loadForms();}
function showToast(msg,type){const c=document.getElementById('toastContainer');const t=document.createElement('div');t.className='toast';t.innerHTML='<i class="fas fa-'+(type==='success'?'check-circle text-green-500':'times-circle text-red-500')+' text-xl"></i><span>'+msg+'</span>';c.appendChild(t);setTimeout(()=>t.remove(),3000);}
document.addEventListener('click',e=>{if(!e.target.closest('#createDropdown'))document.getElementById('createMenu').classList.remove('active');});
loadForms();
</script>
{% endblock %}
