{% extends "dashboard/base.html" %}
{% block title %}{% if form %}Edit{% else %}Create{% endif %} Form - SendBaba{% endblock %}
{% block page_title %}{% if form %}Edit Form{% else %}Create Form{% endif %}{% endblock %}

{% block extra_css %}
<style>
:root{--primary:#F97316}
.builder-wrap{display:flex;gap:24px;min-height:calc(100vh - 200px)}
.sidebar{width:340px;background:#fff;border-radius:16px;border:1px solid #E5E7EB;padding:20px;flex-shrink:0}
.preview-area{flex:1;background:#F3F4F6;border-radius:16px;padding:24px;display:flex;flex-direction:column}
.sidebar-tabs{display:flex;gap:4px;margin-bottom:20px}
.sidebar-tab{flex:1;padding:10px;text-align:center;font-size:13px;font-weight:600;color:#6B7280;cursor:pointer;border:none;background:#F3F4F6;border-radius:8px}
.sidebar-tab.active{background:var(--primary);color:#fff}
.field-item{background:#F9FAFB;border:1px solid #E5E7EB;border-radius:12px;padding:14px;margin-bottom:12px}
.field-input{width:100%;padding:10px 12px;border:2px solid #E5E7EB;border-radius:8px;font-size:13px;outline:none;box-sizing:border-box}
.field-input:focus{border-color:var(--primary)}
.add-field-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.add-field-btn{padding:12px;border:2px dashed #E5E7EB;border-radius:10px;background:#fff;cursor:pointer;font-size:13px;color:#6B7280;display:flex;align-items:center;justify-content:center;gap:8px}
.add-field-btn:hover{border-color:var(--primary);color:var(--primary);background:#FFF7ED}
.preview-frame{background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.1);max-width:420px;margin:0 auto;padding:28px}
.preview-field{margin-bottom:16px}
.preview-label{display:block;font-size:14px;font-weight:500;margin-bottom:6px}
.preview-input{width:100%;padding:12px;border:2px solid #E5E7EB;border-radius:10px;font-size:14px;box-sizing:border-box}
.preview-button{width:100%;padding:14px;border:none;border-radius:10px;font-size:15px;font-weight:600;color:#fff;cursor:pointer;margin-top:8px}
.btn-save{padding:12px 24px;border-radius:12px;font-weight:600;cursor:pointer;border:none;font-size:14px}
.btn-draft{background:#fff;border:2px solid #E5E7EB;color:#374151}
.btn-draft:hover{border-color:var(--primary);color:var(--primary)}
.btn-publish{background:linear-gradient(135deg,var(--primary),#EA580C);color:#fff;box-shadow:0 4px 12px rgba(249,115,22,.3)}
.btn-publish:hover{transform:translateY(-2px)}
.setting-group{margin-bottom:16px}
.setting-label{display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px}
.color-input{width:100%;height:40px;border:2px solid #E5E7EB;border-radius:8px;cursor:pointer;padding:4px}
.toast-container{position:fixed;bottom:24px;right:24px;z-index:9999}
.toast{background:#fff;padding:16px 20px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.15);display:flex;align-items:center;gap:12px;margin-top:8px}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <a href="/dashboard/forms" class="text-gray-500 hover:text-orange-500"><i class="fas fa-arrow-left mr-2"></i>Back</a>
        <div class="flex gap-3">
            <button onclick="saveForm('draft')" class="btn-save btn-draft"><i class="fas fa-save mr-2"></i>Save Draft</button>
            <button onclick="saveForm('active')" class="btn-save btn-publish"><i class="fas fa-rocket mr-2"></i>Publish</button>
        </div>
    </div>
    
    <div class="builder-wrap">
        <div class="sidebar">
            <input type="text" id="formName" value="{{ form.name if form else 'Untitled Form' }}" placeholder="Form Name" class="field-input mb-4" style="font-size:15px;font-weight:600">
            
            <div class="sidebar-tabs">
                <button onclick="switchTab('fields')" id="tabFields" class="sidebar-tab active">Fields</button>
                <button onclick="switchTab('design')" id="tabDesign" class="sidebar-tab">Design</button>
                <button onclick="switchTab('settings')" id="tabSettings" class="sidebar-tab">Settings</button>
            </div>
            
            <div id="panelFields">
                <h4 class="font-semibold text-gray-700 text-sm mb-3">Form Fields</h4>
                <div id="fieldsList"></div>
                <h4 class="font-semibold text-gray-700 text-sm mb-3 mt-4">Add Field</h4>
                <div class="add-field-grid">
                    <button onclick="addField('text','Text')" class="add-field-btn"><i class="fas fa-font"></i>Text</button>
                    <button onclick="addField('email','Email')" class="add-field-btn"><i class="fas fa-envelope"></i>Email</button>
                    <button onclick="addField('tel','Phone')" class="add-field-btn"><i class="fas fa-phone"></i>Phone</button>
                    <button onclick="addField('text','Name')" class="add-field-btn"><i class="fas fa-user"></i>Name</button>
                </div>
            </div>
            
            <div id="panelDesign" style="display:none">
                <div class="setting-group"><label class="setting-label">Primary Color</label><input type="color" id="primaryColor" value="{{ (form.design.primary_color if form else '#F97316') }}" class="color-input" onchange="updatePreview()"></div>
                <div class="setting-group"><label class="setting-label">Background</label><input type="color" id="bgColor" value="{{ (form.design.background_color if form else '#FFFFFF') }}" class="color-input" onchange="updatePreview()"></div>
                <div class="setting-group"><label class="setting-label">Text Color</label><input type="color" id="textColor" value="{{ (form.design.text_color if form else '#1F2937') }}" class="color-input" onchange="updatePreview()"></div>
                <div class="setting-group"><label class="setting-label">Button Text</label><input type="text" id="buttonText" value="{{ (form.design.button_text if form else 'Subscribe') }}" class="field-input" oninput="updatePreview()"></div>
            </div>
            
            <div id="panelSettings" style="display:none">
                <div class="setting-group"><label class="setting-label">Form Type</label><select id="formType" class="field-input"><option value="inline" {{ 'selected' if (form.form_type if form else form_type)=='inline' }}>Inline</option><option value="popup" {{ 'selected' if (form.form_type if form else form_type)=='popup' }}>Pop-up</option><option value="slide_in" {{ 'selected' if (form.form_type if form else form_type)=='slide_in' }}>Slide-in</option></select></div>
                <div class="setting-group"><label class="setting-label">Trigger</label><select id="triggerType" class="field-input"><option value="immediate">Immediately</option><option value="time_delay">After delay</option><option value="scroll">After scroll</option></select></div>
                <div class="setting-group"><label class="setting-label">Success Message</label><textarea id="successMessage" class="field-input" rows="2">{{ form.success_message if form else 'Thanks for subscribing!' }}</textarea></div>
            </div>
        </div>
        
        <div class="preview-area">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Preview</h3>
            <div class="flex-1 flex items-start justify-center pt-8">
                <div id="previewFrame" class="preview-frame"></div>
            </div>
        </div>
    </div>
</div>

<div id="toastContainer" class="toast-container"></div>

<script>
const formId='{{ form.id if form else "" }}';
let fields={{ form.fields_list | tojson | safe if form else '[{"id":"email_1","type":"email","label":"Email Address","placeholder":"Enter your email","required":true}]' }};

function switchTab(tab){
    document.querySelectorAll('.sidebar-tab').forEach(t=>t.classList.remove('active'));
    document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
    document.getElementById('panelFields').style.display=tab==='fields'?'block':'none';
    document.getElementById('panelDesign').style.display=tab==='design'?'block':'none';
    document.getElementById('panelSettings').style.display=tab==='settings'?'block':'none';
}

function renderFields(){
    document.getElementById('fieldsList').innerHTML=fields.map((f,i)=>`
        <div class="field-item">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-semibold text-gray-700">${f.label||'Field'}</span>
                <button onclick="removeField(${i})" class="text-red-400 hover:text-red-600 text-sm"><i class="fas fa-trash"></i></button>
            </div>
            <input type="text" value="${f.label||''}" placeholder="Label" class="field-input mb-2" onchange="updateField(${i},'label',this.value)">
            <input type="text" value="${f.placeholder||''}" placeholder="Placeholder" class="field-input" onchange="updateField(${i},'placeholder',this.value)">
        </div>
    `).join('');
    updatePreview();
}

function updateField(i,k,v){fields[i][k]=v;if(k==='label')renderFields();else updatePreview();}
function addField(type,label){fields.push({id:type+'_'+Date.now(),type:type,label:label,placeholder:'',required:false});renderFields();}
function removeField(i){if(fields.length>1){fields.splice(i,1);renderFields();}else{showToast('Need at least one field','error');}}

function updatePreview(){
    const pc=document.getElementById('primaryColor').value;
    const bg=document.getElementById('bgColor').value;
    const tc=document.getElementById('textColor').value;
    const bt=document.getElementById('buttonText').value||'Subscribe';
    let html='';
    fields.forEach(f=>{html+=`<div class="preview-field"><label class="preview-label" style="color:${tc}">${f.label}${f.required?' *':''}</label><input type="${f.type}" placeholder="${f.placeholder||''}" class="preview-input"></div>`;});
    html+=`<button class="preview-button" style="background:${pc}">${bt}</button>`;
    document.getElementById('previewFrame').innerHTML=html;
    document.getElementById('previewFrame').style.background=bg;
}

async function saveForm(status){
    const data={
        name:document.getElementById('formName').value||'Untitled Form',
        form_type:document.getElementById('formType').value,
        fields:fields,
        design:{primary_color:document.getElementById('primaryColor').value,background_color:document.getElementById('bgColor').value,text_color:document.getElementById('textColor').value,button_text:document.getElementById('buttonText').value||'Subscribe'},
        trigger_type:document.getElementById('triggerType').value,
        success_message:document.getElementById('successMessage').value,
        status:status
    };
    const url=formId?'/dashboard/forms/api/'+formId:'/dashboard/forms/api/create';
    const method=formId?'PUT':'POST';
    try{
        const r=await fetch(url,{method:method,headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        const d=await r.json();
        if(d.success){
            showToast(status==='active'?'Published!':'Saved!','success');
            if(!formId&&d.form)setTimeout(()=>window.location.href='/dashboard/forms/'+d.form.id+'/edit',1000);
        }else{showToast(d.error||'Failed','error');}
    }catch(e){showToast('Network error','error');}
}

function showToast(msg,type){const c=document.getElementById('toastContainer');const t=document.createElement('div');t.className='toast';t.innerHTML='<i class="fas fa-'+(type==='success'?'check-circle text-green-500':'times-circle text-red-500')+' text-xl"></i><span class="font-medium">'+msg+'</span>';c.appendChild(t);setTimeout(()=>t.remove(),3000);}

renderFields();
</script>
{% endblock %}
