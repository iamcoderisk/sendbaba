{% extends "base.html" %}

{% block title %}{{ ticket.ticket_number }} - Admin{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100">
    <!-- Header -->
    <div class="bg-gray-900 text-white">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="{{ url_for('tickets.admin_dashboard') }}" class="text-gray-400 hover:text-white">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <div>
                        <span class="text-gray-400 text-sm">{{ ticket.ticket_number }}</span>
                        <h1 class="text-xl font-bold">{{ ticket.subject }}</h1>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="px-3 py-1 rounded-full text-sm font-semibold
                        {% if ticket.status == 'open' %}bg-green-500
                        {% elif ticket.status == 'pending' %}bg-yellow-500
                        {% elif ticket.status == 'resolved' %}bg-blue-500
                        {% else %}bg-gray-500{% endif %}">
                        {{ ticket.status|title }}
                    </span>
                    <span class="px-3 py-1 rounded text-sm font-semibold
                        {% if ticket.priority == 'urgent' %}bg-red-500
                        {% elif ticket.priority == 'high' %}bg-orange-500
                        {% elif ticket.priority == 'medium' %}bg-yellow-500
                        {% else %}bg-gray-500{% endif %}">
                        {{ ticket.priority|title }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Original Message -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="px-6 py-4 bg-gray-50 border-b flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center font-semibold">
                                {{ (ticket.user_name or ticket.user_email or 'U')[0]|upper }}
                            </div>
                            <div>
                                <div class="font-semibold">{{ ticket.user_name or ticket.user_email }}</div>
                                <div class="text-sm text-gray-500">{{ ticket.created_at.strftime('%b %d, %Y at %H:%M') }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="whitespace-pre-wrap text-gray-700">{{ ticket.description }}</div>
                    </div>
                </div>
                
                <!-- Replies -->
                {% for reply in replies %}
                <div class="bg-white rounded-xl shadow-sm overflow-hidden 
                    {% if reply.is_internal_note %}border-2 border-yellow-200 bg-yellow-50{% elif reply.is_staff %}border-l-4 border-orange-500{% endif %}">
                    <div class="px-6 py-4 border-b flex items-center justify-between
                        {% if reply.is_internal_note %}bg-yellow-100{% else %}bg-gray-50{% endif %}">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center font-semibold
                                {% if reply.is_staff %}bg-orange-500 text-white{% else %}bg-gray-300 text-gray-700{% endif %}">
                                {{ (reply.user_name or reply.user_email or 'S')[0]|upper }}
                            </div>
                            <div>
                                <div class="font-semibold">
                                    {{ reply.user_name or reply.user_email }}
                                    {% if reply.is_staff %}<span class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded ml-1">Staff</span>{% endif %}
                                    {% if reply.is_internal_note %}<span class="text-xs bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded ml-1">Internal Note</span>{% endif %}
                                </div>
                                <div class="text-sm text-gray-500">{{ reply.created_at.strftime('%b %d, %Y at %H:%M') }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="whitespace-pre-wrap text-gray-700">{{ reply.message }}</div>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Reply Form -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <form action="{{ url_for('tickets.admin_reply_ticket', ticket_id=ticket.id) }}" method="POST">
                        <div class="p-6 space-y-4">
                            <div class="flex items-center gap-4 mb-4">
                                <label class="flex items-center gap-2">
                                    <input type="radio" name="reply_type" value="public" checked 
                                           onchange="document.getElementById('is_internal').value='false'">
                                    <span>Public Reply</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="radio" name="reply_type" value="internal"
                                           onchange="document.getElementById('is_internal').value='true'">
                                    <span class="text-yellow-700">Internal Note</span>
                                </label>
                            </div>
                            <input type="hidden" name="is_internal" id="is_internal" value="false">
                            
                            {% if canned_responses %}
                            <select id="cannedResponse" onchange="insertCanned()" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">-- Insert Canned Response --</option>
                                {% for cr in canned_responses %}
                                <option value="{{ cr.content }}">{{ cr.title }}</option>
                                {% endfor %}
                            </select>
                            {% endif %}
                            
                            <textarea name="message" id="messageBox" required rows="6"
                                      class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500"
                                      placeholder="Type your reply..."></textarea>
                            
                            <div class="flex items-center gap-4">
                                <label class="text-sm text-gray-600">Set status:</label>
                                <select name="status" class="px-3 py-2 border rounded-lg">
                                    <option value="">No change</option>
                                    <option value="open">Open</option>
                                    <option value="pending">Pending</option>
                                    <option value="resolved">Resolved</option>
                                    <option value="closed">Closed</option>
                                </select>
                            </div>
                        </div>
                        <div class="px-6 py-4 bg-gray-50 border-t flex justify-end">
                            <button type="submit" class="bg-orange-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-orange-600">
                                <i class="fas fa-paper-plane mr-2"></i>Send Reply
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Ticket Info -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="font-semibold text-gray-900 mb-4">Ticket Details</h3>
                    <form action="{{ url_for('tickets.admin_update_ticket', ticket_id=ticket.id) }}" method="POST" class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-500">Status</label>
                            <select name="status" class="w-full mt-1 px-3 py-2 border rounded-lg">
                                <option value="open" {{ 'selected' if ticket.status == 'open' }}>Open</option>
                                <option value="pending" {{ 'selected' if ticket.status == 'pending' }}>Pending</option>
                                <option value="resolved" {{ 'selected' if ticket.status == 'resolved' }}>Resolved</option>
                                <option value="closed" {{ 'selected' if ticket.status == 'closed' }}>Closed</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-gray-500">Priority</label>
                            <select name="priority" class="w-full mt-1 px-3 py-2 border rounded-lg">
                                <option value="low" {{ 'selected' if ticket.priority == 'low' }}>Low</option>
                                <option value="medium" {{ 'selected' if ticket.priority == 'medium' }}>Medium</option>
                                <option value="high" {{ 'selected' if ticket.priority == 'high' }}>High</option>
                                <option value="urgent" {{ 'selected' if ticket.priority == 'urgent' }}>Urgent</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-gray-500">Category</label>
                            <select name="category_id" class="w-full mt-1 px-3 py-2 border rounded-lg">
                                <option value="">None</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}" {{ 'selected' if ticket.category_id == cat.id }}>{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-gray-500">Assigned To</label>
                            <select name="assigned_to" class="w-full mt-1 px-3 py-2 border rounded-lg">
                                <option value="">Unassigned</option>
                                {% for staff in staff_members %}
                                <option value="{{ staff.id }}" {{ 'selected' if ticket.assigned_to == staff.id }}>{{ staff.name or staff.email }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-gray-900 text-white py-2 rounded-lg hover:bg-gray-800">
                            Update Ticket
                        </button>
                    </form>
                </div>
                
                <!-- Customer Info -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="font-semibold text-gray-900 mb-4">Customer</h3>
                    <div class="space-y-3">
                        <div>
                            <div class="text-sm text-gray-500">Email</div>
                            <div>{{ ticket.user_email }}</div>
                        </div>
                        {% if ticket.user_name %}
                        <div>
                            <div class="text-sm text-gray-500">Name</div>
                            <div>{{ ticket.user_name }}</div>
                        </div>
                        {% endif %}
                        {% if ticket.org_name %}
                        <div>
                            <div class="text-sm text-gray-500">Organization</div>
                            <div>{{ ticket.org_name }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Activity Log -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="font-semibold text-gray-900 mb-4">Activity</h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        {% for activity in activities %}
                        <div class="flex gap-3 text-sm">
                            <div class="w-2 h-2 rounded-full bg-gray-300 mt-1.5"></div>
                            <div>
                                <div class="text-gray-700">{{ activity.action|replace('_', ' ')|title }}</div>
                                <div class="text-gray-400 text-xs">{{ activity.created_at.strftime('%b %d, %H:%M') }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function insertCanned() {
    const select = document.getElementById('cannedResponse');
    const textarea = document.getElementById('messageBox');
    if (select.value) {
        textarea.value = select.value;
        select.value = '';
    }
}
</script>
{% endblock %}
