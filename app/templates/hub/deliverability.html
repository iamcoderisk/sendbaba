{% extends "hub/base.html" %}
{% set active_page = 'deliverability' %}

{% block title %}Deliverability Center{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Deliverability Center</h1>
            <p class="text-gray-500">Monitor inbox placement, authentication, and sender reputation</p>
        </div>
        <div class="flex items-center space-x-3">
            <button onclick="runDeliverabilityTest()" class="px-4 py-2 bg-white border border-gray-200 rounded-xl hover:bg-gray-50">
                <i class="fas fa-flask mr-2"></i>Run Test
            </button>
            <button onclick="openAuthChecker()" class="px-4 py-2 gradient-primary text-white rounded-xl card-shadow">
                <i class="fas fa-shield-alt mr-2"></i>Check Authentication
            </button>
        </div>
    </div>

    <!-- Deliverability Score -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-2xl p-6 card-shadow">
            <h3 class="font-bold text-gray-800 mb-4">Deliverability Score</h3>
            <div id="deliverability-score-chart" style="height: 180px;"></div>
            <p class="text-center text-gray-500 mt-2">Your deliverability is <span class="font-bold text-green-600">Excellent</span></p>
        </div>
        <div class="lg:col-span-3 grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white rounded-2xl p-5 card-shadow border-l-4 border-green-500">
                <p class="text-gray-500 text-sm mb-1">Inbox Rate</p>
                <p class="text-3xl font-bold text-green-600"><span id="inbox-rate">0</span>%</p>
                <p class="text-xs text-gray-400 mt-1">Target: >95%</p>
            </div>
            <div class="bg-white rounded-2xl p-5 card-shadow border-l-4 border-yellow-500">
                <p class="text-gray-500 text-sm mb-1">Spam Rate</p>
                <p class="text-3xl font-bold text-yellow-600"><span id="spam-rate">0</span>%</p>
                <p class="text-xs text-gray-400 mt-1">Target: <1%</p>
            </div>
            <div class="bg-white rounded-2xl p-5 card-shadow border-l-4 border-red-500">
                <p class="text-gray-500 text-sm mb-1">Bounce Rate</p>
                <p class="text-3xl font-bold text-red-600"><span id="bounce-rate">0</span>%</p>
                <p class="text-xs text-gray-400 mt-1">Target: <2%</p>
            </div>
            <div class="bg-white rounded-2xl p-5 card-shadow border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm mb-1">Complaint Rate</p>
                <p class="text-3xl font-bold text-blue-600"><span id="complaint-rate">0</span>%</p>
                <p class="text-xs text-gray-400 mt-1">Target: <0.1%</p>
            </div>
        </div>
    </div>

    <!-- Authentication Status -->
    <div class="bg-white rounded-2xl p-6 card-shadow">
        <h3 class="font-bold text-gray-800 mb-4">Email Authentication Status</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="auth-status">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Provider Inbox Placement -->
    <div class="bg-white rounded-2xl p-6 card-shadow">
        <h3 class="font-bold text-gray-800 mb-4">Inbox Placement by Provider</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="border border-gray-100 rounded-xl p-4">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                        <i class="fab fa-google text-red-500 text-xl"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-800">Gmail</h4>
                        <p class="text-xs text-gray-500">google.com</p>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Inbox</span>
                        <span class="font-bold text-green-600">94%</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 94%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>Spam: 4%</span>
                        <span>Missing: 2%</span>
                    </div>
                </div>
            </div>
            <div class="border border-gray-100 rounded-xl p-4">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fab fa-microsoft text-blue-500 text-xl"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-800">Outlook</h4>
                        <p class="text-xs text-gray-500">outlook.com</p>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Inbox</span>
                        <span class="font-bold text-green-600">91%</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 91%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>Spam: 6%</span>
                        <span>Missing: 3%</span>
                    </div>
                </div>
            </div>
            <div class="border border-gray-100 rounded-xl p-4">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                        <i class="fab fa-yahoo text-purple-500 text-xl"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-800">Yahoo</h4>
                        <p class="text-xs text-gray-500">yahoo.com</p>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Inbox</span>
                        <span class="font-bold text-green-600">89%</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 89%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>Spam: 8%</span>
                        <span>Missing: 3%</span>
                    </div>
                </div>
            </div>
            <div class="border border-gray-100 rounded-xl p-4">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-envelope text-gray-500 text-xl"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-800">Others</h4>
                        <p class="text-xs text-gray-500">Various ISPs</p>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Inbox</span>
                        <span class="font-bold text-green-600">96%</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 96%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>Spam: 2%</span>
                        <span>Missing: 2%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Domain Health -->
    <div class="bg-white rounded-2xl p-6 card-shadow">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-gray-800">Domain Health Check</h3>
            <button onclick="recheckDomains()" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-sm hover:bg-blue-100">
                <i class="fas fa-sync-alt mr-1"></i>Recheck All
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="text-left text-sm text-gray-500 border-b">
                        <th class="pb-3 font-medium">Domain</th>
                        <th class="pb-3 font-medium">SPF</th>
                        <th class="pb-3 font-medium">DKIM</th>
                        <th class="pb-3 font-medium">DMARC</th>
                        <th class="pb-3 font-medium">MX</th>
                        <th class="pb-3 font-medium">Reputation</th>
                        <th class="pb-3 font-medium">Last Check</th>
                        <th class="pb-3 font-medium">Actions</th>
                    </tr>
                </thead>
                <tbody id="domain-health-table" class="text-sm">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Deliverability Trend -->
    <div class="bg-white rounded-2xl p-6 card-shadow">
        <h3 class="font-bold text-gray-800 mb-4">Deliverability Trend (30 Days)</h3>
        <div id="deliverability-trend-chart" style="height: 300px;"></div>
    </div>
</div>

<!-- Auth Checker Modal -->
<div id="auth-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="closeAuthChecker()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-white rounded-2xl card-shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-800">Check Email Authentication</h3>
            <button onclick="closeAuthChecker()" class="p-2 hover:bg-gray-100 rounded-lg">
                <i class="fas fa-times text-gray-400"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Domain to Check</label>
                <input type="text" id="check-domain" placeholder="example.com" class="w-full border border-gray-200 rounded-xl p-3">
            </div>
            <button onclick="checkDomainAuth()" class="w-full py-3 gradient-primary text-white rounded-xl font-medium">
                Check Authentication
            </button>
            <div id="auth-results" class="hidden space-y-3">
                <!-- Results appear here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let deliverabilityScoreChart, trendChart;

function initCharts() {
    deliverabilityScoreChart = new ApexCharts(document.querySelector("#deliverability-score-chart"), {
        chart: { type: 'radialBar', height: 180 },
        series: [94],
        colors: ['#10b981'],
        plotOptions: {
            radialBar: {
                hollow: { size: '70%' },
                dataLabels: {
                    name: { show: false },
                    value: { fontSize: '28px', fontWeight: 'bold', formatter: v => v + '%' }
                }
            }
        }
    });
    deliverabilityScoreChart.render();

    trendChart = new ApexCharts(document.querySelector("#deliverability-trend-chart"), {
        chart: { type: 'line', height: 300, toolbar: { show: false } },
        series: [
            { name: 'Inbox Rate', data: [92, 93, 91, 94, 95, 93, 94, 96, 95, 94] },
            { name: 'Spam Rate', data: [5, 4, 6, 4, 3, 5, 4, 2, 3, 4] },
            { name: 'Bounce Rate', data: [3, 3, 3, 2, 2, 2, 2, 2, 2, 2] }
        ],
        colors: ['#10b981', '#f59e0b', '#ef4444'],
        stroke: { curve: 'smooth', width: 2 },
        xaxis: { categories: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7', 'Week 8', 'Week 9', 'Week 10'] },
        yaxis: { min: 0, max: 100, labels: { formatter: v => v + '%' } },
        legend: { position: 'top' },
        grid: { borderColor: '#f1f5f9' }
    });
    trendChart.render();
}

async function fetchDeliverabilityData() {
    try {
        const res = await fetch('/hub/api/deliverability');
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('inbox-rate').textContent = data.inbox_rate;
            document.getElementById('spam-rate').textContent = data.spam_rate;
            document.getElementById('bounce-rate').textContent = data.bounce_rate;
            document.getElementById('complaint-rate').textContent = data.complaint_rate;
            
            renderAuthStatus(data.auth_status);
            renderDomainHealth(data.domains);
        }
    } catch (e) {
        console.error(e);
    }
}

function renderAuthStatus(status) {
    const container = document.getElementById('auth-status');
    const items = [
        { name: 'SPF', status: status.spf, desc: 'Sender Policy Framework' },
        { name: 'DKIM', status: status.dkim, desc: 'DomainKeys Identified Mail' },
        { name: 'DMARC', status: status.dmarc, desc: 'Domain-based Message Authentication' },
        { name: 'PTR', status: status.ptr, desc: 'Reverse DNS Records' }
    ];
    
    container.innerHTML = items.map(item => `
        <div class="border rounded-xl p-4 ${item.status === 'pass' ? 'border-green-200 bg-green-50' : item.status === 'warning' ? 'border-yellow-200 bg-yellow-50' : 'border-red-200 bg-red-50'}">
            <div class="flex items-center justify-between mb-2">
                <span class="font-bold text-gray-800">${item.name}</span>
                <span class="px-2 py-1 rounded-full text-xs font-medium ${item.status === 'pass' ? 'bg-green-100 text-green-700' : item.status === 'warning' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">
                    ${item.status === 'pass' ? '✓ Pass' : item.status === 'warning' ? '⚠ Warning' : '✗ Fail'}
                </span>
            </div>
            <p class="text-sm text-gray-500">${item.desc}</p>
        </div>
    `).join('');
}

function renderDomainHealth(domains) {
    const tbody = document.getElementById('domain-health-table');
    tbody.innerHTML = domains.map(d => `
        <tr class="border-b border-gray-50 hover:bg-gray-50">
            <td class="py-3 font-medium">${d.domain}</td>
            <td class="py-3">${getStatusIcon(d.spf)}</td>
            <td class="py-3">${getStatusIcon(d.dkim)}</td>
            <td class="py-3">${getStatusIcon(d.dmarc)}</td>
            <td class="py-3">${getStatusIcon(d.mx)}</td>
            <td class="py-3">
                <span class="px-2 py-1 rounded-full text-xs font-medium ${d.reputation === 'good' ? 'bg-green-100 text-green-700' : d.reputation === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">
                    ${d.reputation}
                </span>
            </td>
            <td class="py-3 text-gray-500">${d.last_check}</td>
            <td class="py-3">
                <button onclick="checkDomain('${d.domain}')" class="text-blue-500 hover:text-blue-700">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function getStatusIcon(status) {
    if (status === 'pass') return '<span class="text-green-500"><i class="fas fa-check-circle"></i></span>';
    if (status === 'warning') return '<span class="text-yellow-500"><i class="fas fa-exclamation-circle"></i></span>';
    return '<span class="text-red-500"><i class="fas fa-times-circle"></i></span>';
}

function openAuthChecker() {
    document.getElementById('auth-modal').classList.remove('hidden');
}

function closeAuthChecker() {
    document.getElementById('auth-modal').classList.add('hidden');
}

function checkDomainAuth() {
    const domain = document.getElementById('check-domain').value;
    if (!domain) { showToast('Please enter a domain', 'error'); return; }
    
    document.getElementById('auth-results').classList.remove('hidden');
    document.getElementById('auth-results').innerHTML = `
        <div class="bg-green-50 border border-green-200 rounded-xl p-4">
            <div class="flex items-center justify-between">
                <span class="font-medium">SPF</span>
                <span class="text-green-600">✓ Pass</span>
            </div>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-xl p-4">
            <div class="flex items-center justify-between">
                <span class="font-medium">DKIM</span>
                <span class="text-green-600">✓ Pass</span>
            </div>
        </div>
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
            <div class="flex items-center justify-between">
                <span class="font-medium">DMARC</span>
                <span class="text-yellow-600">⚠ Warning</span>
            </div>
            <p class="text-sm text-yellow-600 mt-1">Consider adding a stricter DMARC policy</p>
        </div>
    `;
    showToast(`Checking ${domain}...`, 'info');
}

function runDeliverabilityTest() {
    showToast('Running deliverability test...', 'info');
}

function recheckDomains() {
    showToast('Rechecking all domains...', 'info');
    fetchDeliverabilityData();
}

function checkDomain(domain) {
    showToast(`Checking ${domain}...`, 'info');
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    initCharts();
    fetchDeliverabilityData();
});
</script>
{% endblock %}
