{% extends "hub/base.html" %}
{% block title %}IP Warmup - SendBaba Hub{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">IP Warmup Manager</h1>
            <p class="text-gray-500">{{ ips|length }} IPs configured • Manage IP reputation warmup</p>
        </div>
        <div class="flex gap-3">
            <button onclick="resetDailyCounters()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200">
                <i class="fas fa-sync mr-2"></i>Reset Daily
            </button>
            <button onclick="autoAdvance()" class="px-4 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600">
                <i class="fas fa-forward mr-2"></i>Auto-Advance
            </button>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="grid grid-cols-4 gap-4">
        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
            <div class="text-2xl font-bold text-green-600">{{ ips|selectattr('warmup_day', 'ge', 30)|list|length }}</div>
            <div class="text-sm text-gray-500">Fully Warmed</div>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
            <div class="text-2xl font-bold text-yellow-600">{{ ips|selectattr('warmup_day', 'lt', 30)|list|length }}</div>
            <div class="text-sm text-gray-500">Warming Up</div>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
            <div class="text-2xl font-bold text-blue-600">{{ ips|map(attribute='daily_limit')|sum|int }}</div>
            <div class="text-sm text-gray-500">Total Daily Capacity</div>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
            <div class="text-2xl font-bold text-purple-600">{{ ips|map(attribute='sent_today')|sum|int }}</div>
            <div class="text-sm text-gray-500">Sent Today</div>
        </div>
    </div>

    <!-- Warmup Schedules Info -->
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <h2 class="text-lg font-semibold text-gray-800 mb-4"><i class="fas fa-calendar-alt text-[#f86d31] mr-2"></i>Warmup Schedules</h2>
        <div class="grid grid-cols-3 gap-4">
            <div class="p-4 bg-blue-50 rounded-xl">
                <h3 class="font-semibold text-blue-800">Conservative (19 days)</h3>
                <p class="text-sm text-blue-600 mt-1">50 → 50,000 emails/day</p>
                <p class="text-xs text-blue-500 mt-2">Best for new IPs, safest</p>
            </div>
            <div class="p-4 bg-orange-50 rounded-xl border-2 border-[#f86d31]">
                <h3 class="font-semibold text-orange-800">Standard (14 days)</h3>
                <p class="text-sm text-orange-600 mt-1">100 → 100,000 emails/day</p>
                <p class="text-xs text-orange-500 mt-2">Recommended for most</p>
            </div>
            <div class="p-4 bg-red-50 rounded-xl">
                <h3 class="font-semibold text-red-800">Aggressive (8 days)</h3>
                <p class="text-sm text-red-600 mt-1">500 → 50,000 emails/day</p>
                <p class="text-xs text-red-500 mt-2">Experienced senders only</p>
            </div>
        </div>
    </div>

    <!-- IP Status Grid -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-4 border-b border-gray-100">
            <h2 class="text-lg font-semibold text-gray-800">
                <i class="fas fa-server text-blue-500 mr-2"></i>IP Addresses
            </h2>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">IP / Hostname</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Day</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Daily Limit</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Sent Today</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Progress</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for ip in ips %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="font-mono text-gray-800">{{ ip.ip_address }}</div>
                            <div class="text-xs text-gray-500">{{ ip.hostname }}</div>
                        </td>
                        <td class="px-4 py-3">
                            {% if ip.warmup_day >= 30 %}
                            <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded-full">
                                <i class="fas fa-check mr-1"></i>Ready
                            </span>
                            {% else %}
                            <span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-700 rounded-full">
                                <i class="fas fa-fire mr-1"></i>Warming
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-gray-800 font-semibold">Day {{ ip.warmup_day or 1 }}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-gray-800 font-medium">{{ "{:,}".format(ip.daily_limit or 500) }}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-gray-800">{{ "{:,}".format(ip.sent_today or 0) }}</span>
                        </td>
                        <td class="px-4 py-3">
                            {% set progress = ((ip.sent_today or 0) / (ip.daily_limit or 1) * 100)|round(1) %}
                            <div class="flex items-center gap-2">
                                <div class="w-20 bg-gray-200 rounded-full h-2">
                                    <div class="h-2 rounded-full {% if progress >= 90 %}bg-green-500{% elif progress >= 50 %}bg-yellow-500{% else %}bg-[#f86d31]{% endif %}" style="width: {{ [progress, 100]|min }}%"></div>
                                </div>
                                <span class="text-xs text-gray-500 w-12">{{ progress }}%</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex gap-1">
                                <button onclick="advanceIP('{{ ip.ip_address }}')" class="p-2 text-green-600 hover:bg-green-50 rounded-lg" title="Advance to next day">
                                    <i class="fas fa-step-forward"></i>
                                </button>
                                <button onclick="openScheduleModal('{{ ip.ip_address }}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Set schedule">
                                    <i class="fas fa-calendar"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-server text-4xl mb-2 opacity-30 block"></i>
                            <p>No IPs configured</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tips -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-100">
        <h2 class="text-lg font-semibold text-gray-800 mb-3"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>IP Warmup Best Practices</h2>
        <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
            <div class="flex items-start gap-2"><i class="fas fa-check-circle text-green-500 mt-0.5"></i><span>Start with engaged subscribers who open and click</span></div>
            <div class="flex items-start gap-2"><i class="fas fa-check-circle text-green-500 mt-0.5"></i><span>Send consistently every day during warmup</span></div>
            <div class="flex items-start gap-2"><i class="fas fa-check-circle text-green-500 mt-0.5"></i><span>Monitor bounce rates - stop if above 5%</span></div>
            <div class="flex items-start gap-2"><i class="fas fa-check-circle text-green-500 mt-0.5"></i><span>Use authenticated domains (SPF, DKIM, DMARC)</span></div>
            <div class="flex items-start gap-2"><i class="fas fa-times-circle text-red-500 mt-0.5"></i><span>Don't skip days or send irregularly</span></div>
            <div class="flex items-start gap-2"><i class="fas fa-times-circle text-red-500 mt-0.5"></i><span>Don't exceed daily limits during warmup</span></div>
        </div>
    </div>
</div>

<!-- Schedule Modal -->
<div id="schedule-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl max-w-md w-full mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Set Warmup Schedule</h3>
        <p class="text-sm text-gray-500 mb-4">IP: <span id="schedule-ip" class="font-mono"></span></p>
        
        <div class="space-y-3">
            <label class="flex items-center p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100">
                <input type="radio" name="schedule" value="conservative" class="mr-3">
                <div><span class="font-medium text-gray-800">Conservative</span><span class="text-sm text-gray-500 ml-2">19 days</span></div>
            </label>
            <label class="flex items-center p-3 bg-orange-50 rounded-xl cursor-pointer hover:bg-orange-100 border-2 border-[#f86d31]">
                <input type="radio" name="schedule" value="standard" checked class="mr-3">
                <div><span class="font-medium text-gray-800">Standard</span><span class="text-sm text-gray-500 ml-2">14 days</span></div>
            </label>
            <label class="flex items-center p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100">
                <input type="radio" name="schedule" value="aggressive" class="mr-3">
                <div><span class="font-medium text-gray-800">Aggressive</span><span class="text-sm text-gray-500 ml-2">8 days</span></div>
            </label>
        </div>
        
        <div class="flex gap-3 mt-6">
            <button onclick="closeScheduleModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200">Cancel</button>
            <button onclick="applySchedule()" class="flex-1 px-4 py-2 bg-[#f86d31] text-white rounded-xl hover:bg-[#e55a20]">Apply</button>
        </div>
    </div>
</div>

<script>
let currentIP = null;

function openScheduleModal(ip) {
    currentIP = ip;
    document.getElementById('schedule-ip').textContent = ip;
    document.getElementById('schedule-modal').classList.remove('hidden');
    document.getElementById('schedule-modal').classList.add('flex');
}

function closeScheduleModal() {
    document.getElementById('schedule-modal').classList.add('hidden');
    document.getElementById('schedule-modal').classList.remove('flex');
}

async function applySchedule() {
    const schedule = document.querySelector('input[name="schedule"]:checked').value;
    try {
        const r = await fetch('/hub/api/ip-warmup/schedule', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ip_address: currentIP, schedule_type: schedule})
        });
        const data = await r.json();
        if (data.success) {
            alert('Schedule applied! Starting at ' + data.schedule[0] + ' emails/day');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch(e) {
        alert('Error: ' + e.message);
    }
    closeScheduleModal();
}

async function advanceIP(ip) {
    if (!confirm('Advance ' + ip + ' to the next warmup day?')) return;
    try {
        const r = await fetch('/hub/api/ip-warmup/advance', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ip_address: ip})
        });
        const data = await r.json();
        if (data.success) {
            alert('Advanced to Day ' + data.new_day + ' (' + data.new_limit.toLocaleString() + '/day)');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch(e) {
        alert('Error: ' + e.message);
    }
}

async function resetDailyCounters() {
    if (!confirm('Reset daily email counters for all IPs?')) return;
    try {
        const r = await fetch('/hub/api/ip-warmup/reset', {method: 'POST'});
        const data = await r.json();
        if (data.success) {
            alert('Reset ' + data.reset_count + ' IPs');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch(e) {
        alert('Error: ' + e.message);
    }
}

async function autoAdvance() {
    if (!confirm('Auto-advance all IPs that reached 90% of their daily limit?')) return;
    try {
        const r = await fetch('/hub/api/ip-warmup/auto-advance', {method: 'POST'});
        const data = await r.json();
        if (data.success) {
            alert('Advanced ' + data.advanced + ' IPs');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch(e) {
        alert('Error: ' + e.message);
    }
}
</script>
{% endblock %}
