{% extends "hub/base.html" %}
{% block title %}Staff Email Accounts{% endblock %}
{% block content %}
<style>
.staff-page{padding:24px}
.staff-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.staff-header h1{font-size:28px;font-weight:700;color:#111827;margin:0}
.add-btn{background:linear-gradient(135deg,#f97316,#ea580c);color:#fff;border:none;padding:12px 24px;border-radius:10px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px}
.add-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(249,115,22,.4)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.stat-card h3{font-size:13px;color:#6b7280;margin:0 0 8px;text-transform:uppercase;letter-spacing:.5px}
.stat-card .value{font-size:32px;font-weight:700;color:#111827}
.stat-card.orange .value{color:#f97316}
.stat-card.green .value{color:#10b981}
.stat-card.red .value{color:#ef4444}
.staff-table{width:100%;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.staff-table th{background:#f9fafb;padding:14px 16px;text-align:left;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.5px}
.staff-table td{padding:14px 16px;border-top:1px solid #f3f4f6}
.staff-table tr:hover{background:#fef3e7}
.email-cell{display:flex;align-items:center;gap:12px}
.avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#f97316,#ea580c);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600}
.email-info .email{font-weight:600;color:#111827}
.email-info .name{font-size:13px;color:#6b7280}
.badge{padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
.badge.active{background:#d1fae5;color:#059669}
.badge.suspended{background:#fee2e2;color:#dc2626}
.badge.admin{background:#fef3c7;color:#d97706}
.badge.staff{background:#e0e7ff;color:#4f46e5}
.action-btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-size:13px;margin-right:4px}
.action-btn.edit{background:#e0e7ff;color:#4f46e5}
.action-btn.reset{background:#fef3c7;color:#d97706}
.action-btn.delete{background:#fee2e2;color:#dc2626}
.action-btn:hover{opacity:.8}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
.modal.show{display:flex}
.modal-box{background:#fff;border-radius:16px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto}
.modal-head{padding:20px 24px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
.modal-head h2{margin:0;font-size:20px}
.modal-close{width:36px;height:36px;border:none;background:#f3f4f6;border-radius:50%;cursor:pointer;font-size:18px}
.modal-body{padding:24px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:14px;font-weight:600;color:#374151;margin-bottom:6px}
.form-group input,.form-group select{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:8px;font-size:15px}
.form-group input:focus,.form-group select:focus{outline:none;border-color:#f97316;box-shadow:0 0 0 3px rgba(249,115,22,.1)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.submit-btn{width:100%;padding:14px;background:linear-gradient(135deg,#f97316,#ea580c);color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-top:8px}
.submit-btn:hover{box-shadow:0 4px 12px rgba(249,115,22,.4)}
.submit-btn:disabled{opacity:.6;cursor:not-allowed}
.empty-state{text-align:center;padding:60px 20px;color:#6b7280}
.empty-state i{font-size:48px;opacity:.3;margin-bottom:16px}
.toast-container{position:fixed;top:20px;right:20px;z-index:9999}
.toast{padding:14px 20px;border-radius:10px;color:#fff;margin-bottom:10px;display:flex;align-items:center;gap:10px;animation:slideIn .3s ease;box-shadow:0 4px 12px rgba(0,0,0,.15)}
.toast.success{background:linear-gradient(135deg,#10b981,#059669)}
.toast.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
.toast.warning{background:linear-gradient(135deg,#f59e0b,#d97706)}
.toast.info{background:linear-gradient(135deg,#3b82f6,#2563eb)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.confirm-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1001;align-items:center;justify-content:center}
.confirm-modal.show{display:flex}
.confirm-box{background:#fff;border-radius:16px;padding:24px;max-width:400px;text-align:center}
.confirm-box h3{margin:0 0 12px;font-size:20px}
.confirm-box p{color:#6b7280;margin:0 0 24px}
.confirm-btns{display:flex;gap:12px;justify-content:center}
.confirm-btns button{padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;border:none}
.confirm-btns .cancel{background:#f3f4f6;color:#374151}
.confirm-btns .danger{background:#ef4444;color:#fff}
@media(max-width:768px){
    .staff-header{flex-direction:column;align-items:stretch}
    .form-row{grid-template-columns:1fr}
    .staff-table{display:block;overflow-x:auto}
}
</style>

<div class="toast-container" id="toast-container"></div>

<div class="staff-page">
    <div class="staff-header">
        <h1><i class="fas fa-users-cog"></i> Staff Email Accounts</h1>
        <button class="add-btn" onclick="openAddModal()"><i class="fas fa-plus"></i> Add Staff</button>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card orange"><h3>Total Staff</h3><div class="value" id="stat-total">0</div></div>
        <div class="stat-card green"><h3>Active</h3><div class="value" id="stat-active">0</div></div>
        <div class="stat-card red"><h3>Suspended</h3><div class="value" id="stat-suspended">0</div></div>
        <div class="stat-card"><h3>Storage Used</h3><div class="value" id="stat-storage">0 MB</div></div>
    </div>
    
    <table class="staff-table">
        <thead>
            <tr>
                <th>Email Account</th>
                <th>Role</th>
                <th>Status</th>
                <th>Recovery Email</th>
                <th>Last Login</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="staff-list">
            <tr><td colspan="6" class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></td></tr>
        </tbody>
    </table>
</div>

<!-- Add Staff Modal -->
<div class="modal" id="add-modal">
    <div class="modal-box">
        <div class="modal-head">
            <h2><i class="fas fa-user-plus"></i> Add Staff Account</h2>
            <button class="modal-close" onclick="closeAddModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form id="add-form" onsubmit="addStaff(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" name="first_name" placeholder="John">
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" name="last_name" placeholder="Doe">
                    </div>
                </div>
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" name="username" placeholder="john.doe" required>
                    <small style="color:#6b7280">Will create: username@sendbaba.com</small>
                </div>
                <div class="form-group">
                    <label>Recovery Email *</label>
                    <input type="email" name="recovery_email" placeholder="personal@gmail.com" required>
                    <small style="color:#6b7280">Login credentials will be sent here</small>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select name="role">
                        <option value="staff">Staff</option>
                        <option value="admin">Admin</option>
                        <option value="support">Support</option>
                    </select>
                </div>
                <button type="submit" class="submit-btn" id="add-btn">
                    <i class="fas fa-plus"></i> Create Account
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div class="confirm-modal" id="confirm-modal">
    <div class="confirm-box">
        <h3 id="confirm-title">Confirm Action</h3>
        <p id="confirm-msg">Are you sure?</p>
        <div class="confirm-btns">
            <button class="cancel" onclick="closeConfirm()">Cancel</button>
            <button class="danger" id="confirm-btn" onclick="confirmAction()">Confirm</button>
        </div>
    </div>
</div>

<script>
var confirmCallback = null;

function toast(message, type) {
    var container = document.getElementById('toast-container');
    var t = document.createElement('div');
    t.className = 'toast ' + (type || 'info');
    var icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle';
    t.innerHTML = '<i class="fas fa-' + icon + '"></i> ' + message;
    container.appendChild(t);
    setTimeout(function() { t.style.opacity = '0'; setTimeout(function() { t.remove(); }, 300); }, 4000);
}

function loadStaff() {
    fetch('/hub/api/staff-emails')
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('stat-total').textContent = data.stats.total;
            document.getElementById('stat-active').textContent = data.stats.active;
            document.getElementById('stat-suspended').textContent = data.stats.suspended;
            document.getElementById('stat-storage').textContent = data.stats.total_storage.toFixed(1) + ' MB';
            
            var list = document.getElementById('staff-list');
            if (data.staff.length === 0) {
                list.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="fas fa-inbox"></i><p>No staff accounts yet</p></td></tr>';
                return;
            }
            
            list.innerHTML = data.staff.map(s => {
                var initial = s.email.charAt(0).toUpperCase();
                var isActive = s.is_active !== false;
                var lastLogin = s.last_login ? new Date(s.last_login).toLocaleDateString() : 'Never';
                return `<tr>
                    <td><div class="email-cell"><div class="avatar">${initial}</div><div class="email-info"><div class="email">${s.email}</div><div class="name">${s.name || '-'}</div></div></div></td>
                    <td><span class="badge ${s.role}">${s.role}</span></td>
                    <td><span class="badge ${isActive ? 'active' : 'suspended'}">${isActive ? 'Active' : 'Suspended'}</span></td>
                    <td>${s.recovery_email || '-'}</td>
                    <td>${lastLogin}</td>
                    <td>
                        <button class="action-btn reset" onclick="resetPassword(${s.id}, '${s.email}')" title="Reset Password"><i class="fas fa-key"></i></button>
                        <button class="action-btn edit" onclick="toggleStatus(${s.id}, ${isActive})" title="${isActive ? 'Suspend' : 'Activate'}"><i class="fas fa-${isActive ? 'ban' : 'check'}"></i></button>
                        <button class="action-btn delete" onclick="deleteStaff(${s.id}, '${s.email}')" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
        }
    })
    .catch(e => toast('Failed to load staff', 'error'));
}

function openAddModal() { document.getElementById('add-modal').classList.add('show'); }
function closeAddModal() { document.getElementById('add-modal').classList.remove('show'); }

function addStaff(e) {
    e.preventDefault();
    var form = e.target;
    var btn = document.getElementById('add-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    
    var data = {
        username: form.username.value,
        first_name: form.first_name.value,
        last_name: form.last_name.value,
        recovery_email: form.recovery_email.value,
        role: form.role.value
    };
    
    fetch('/hub/api/staff-emails', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeAddModal();
            form.reset();
            loadStaff();
            if (data.email_sent) {
                toast('Staff account created! Credentials sent to ' + data.recovery_email, 'success');
            } else if (data.recovery_email) {
                toast('Account created but email failed. Password: ' + data.password, 'warning');
            } else {
                toast('Account created! Password: ' + data.password, 'success');
            }
        } else {
            toast(data.error || 'Failed to create account', 'error');
        }
    })
    .catch(e => toast('Network error', 'error'))
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-plus"></i> Create Account';
    });
}

function resetPassword(id, email) {
    showConfirm('Reset Password', 'Send new password to recovery email for ' + email + '?', function() {
        fetch('/hub/api/staff-emails/' + id + '/reset-password', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                if (data.email_sent) {
                    toast('Password reset! Sent to ' + data.recovery_email, 'success');
                } else if (data.recovery_email) {
                    toast('Password reset but email failed. New password: ' + data.password, 'warning');
                } else {
                    toast('Password reset! New password: ' + data.password, 'warning');
                }
            } else {
                toast(data.error || 'Reset failed', 'error');
            }
        })
        .catch(e => toast('Network error', 'error'));
    });
}

function toggleStatus(id, isActive) {
    var action = isActive ? 'suspend' : 'active';
    fetch('/hub/api/staff-emails/' + id + '/status', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ status: action })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadStaff();
            toast('Account ' + (isActive ? 'suspended' : 'activated'), 'success');
        } else {
            toast(data.error || 'Update failed', 'error');
        }
    })
    .catch(e => toast('Network error', 'error'));
}

function deleteStaff(id, email) {
    showConfirm('Delete Account', 'Permanently delete ' + email + '? This cannot be undone.', function() {
        fetch('/hub/api/staff-emails/' + id, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                loadStaff();
                toast('Account deleted', 'success');
            } else {
                toast(data.error || 'Delete failed', 'error');
            }
        })
        .catch(e => toast('Network error', 'error'));
    });
}

function showConfirm(title, msg, callback) {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-msg').textContent = msg;
    confirmCallback = callback;
    document.getElementById('confirm-modal').classList.add('show');
}

function closeConfirm() {
    document.getElementById('confirm-modal').classList.remove('show');
    confirmCallback = null;
}

function confirmAction() {
    closeConfirm();
    if (confirmCallback) confirmCallback();
}

document.getElementById('add-modal').addEventListener('click', function(e) {
    if (e.target === this) closeAddModal();
});

document.getElementById('confirm-modal').addEventListener('click', function(e) {
    if (e.target === this) closeConfirm();
});

loadStaff();
</script>
{% endblock %}
