{% extends 'hub/base.html' %}
{% block title %}Contacts - Sales CRM{% endblock %}
{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Contacts</h1>
            <p class="text-gray-600">Manage your sales contacts</p>
        </div>
        <button onclick="openModal()" class="px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg font-medium hover:shadow-lg flex items-center gap-2">
            <i class="fas fa-plus"></i> New Contact
        </button>
    </div>

    <div class="bg-white rounded-xl shadow-sm border p-4">
        <input type="text" id="search" placeholder="Search contacts..." onkeyup="loadContacts()" class="px-4 py-2 border rounded-lg w-full max-w-md">
    </div>

    <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Company</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job Title</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody id="contacts-table" class="divide-y divide-gray-200"></tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
        <div class="p-6 border-b flex justify-between items-center">
            <h2 class="text-xl font-bold">New Contact</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <form id="contact-form" onsubmit="saveContact(event)" class="p-6 space-y-4">
            <input type="hidden" id="contact-id">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">First Name *</label>
                    <input type="text" id="contact-first-name" required class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Last Name</label>
                    <input type="text" id="contact-last-name" class="w-full px-4 py-2 border rounded-lg">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Email</label>
                <input type="email" id="contact-email" class="w-full px-4 py-2 border rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Phone</label>
                <input type="text" id="contact-phone" class="w-full px-4 py-2 border rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Job Title</label>
                <input type="text" id="contact-job-title" class="w-full px-4 py-2 border rounded-lg">
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded-lg">Cancel</button>
                <button type="submit" class="px-6 py-2 bg-orange-500 text-white rounded-lg">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', loadContacts);

async function loadContacts() {
    const search = document.getElementById('search').value;
    const res = await fetch(`/hub/sales/api/contacts?search=${search}`);
    const data = await res.json();
    const tbody = document.getElementById('contacts-table');
    
    if (data.success && data.contacts.length > 0) {
        tbody.innerHTML = data.contacts.map(c => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 font-medium">${c.first_name} ${c.last_name || ''}</td>
                <td class="px-6 py-4 text-gray-500">${c.email || '-'}</td>
                <td class="px-6 py-4 text-gray-500">${c.phone || '-'}</td>
                <td class="px-6 py-4 text-gray-500">${c.company_name || '-'}</td>
                <td class="px-6 py-4 text-gray-500">${c.job_title || '-'}</td>
                <td class="px-6 py-4 text-right">
                    <button onclick="editContact('${c.id}')" class="text-blue-600 hover:underline mr-3">Edit</button>
                    <button onclick="deleteContact('${c.id}')" class="text-red-600 hover:underline">Delete</button>
                </td>
            </tr>
        `).join('');
    } else {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">No contacts found</td></tr>';
    }
}

function openModal() { document.getElementById('modal').classList.remove('hidden'); document.getElementById('contact-form').reset(); document.getElementById('contact-id').value = ''; }
function closeModal() { document.getElementById('modal').classList.add('hidden'); }

async function editContact(id) {
    const res = await fetch(`/hub/sales/api/contacts?search=`);
    const data = await res.json();
    const c = data.contacts.find(x => x.id === id);
    if (c) {
        document.getElementById('contact-id').value = c.id;
        document.getElementById('contact-first-name').value = c.first_name;
        document.getElementById('contact-last-name').value = c.last_name || '';
        document.getElementById('contact-email').value = c.email || '';
        document.getElementById('contact-phone').value = c.phone || '';
        document.getElementById('contact-job-title').value = c.job_title || '';
        document.getElementById('modal').classList.remove('hidden');
    }
}

async function saveContact(e) {
    e.preventDefault();
    const id = document.getElementById('contact-id').value;
    const data = {
        first_name: document.getElementById('contact-first-name').value,
        last_name: document.getElementById('contact-last-name').value,
        email: document.getElementById('contact-email').value,
        phone: document.getElementById('contact-phone').value,
        job_title: document.getElementById('contact-job-title').value
    };
    await fetch(id ? `/hub/sales/api/contacts/${id}` : '/hub/sales/api/contacts', {
        method: id ? 'PUT' : 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    closeModal();
    loadContacts();
}

async function deleteContact(id) {
    if (confirm('Delete this contact?')) {
        await fetch(`/hub/sales/api/contacts/${id}`, {method: 'DELETE'});
        loadContacts();
    }
}
</script>
{% endblock %}
