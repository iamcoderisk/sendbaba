{% extends 'hub/base.html' %}

{% block title %}Sales Pipeline - SendBaba Hub{% endblock %}

{% block content %}
<div class="h-full flex flex-col">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Sales Pipeline</h1>
            <p class="text-gray-600">Drag and drop deals between stages</p>
        </div>
        <div class="flex gap-3">
            <button onclick="openDealModal()" class="px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                <i class="fas fa-plus"></i> New Deal
            </button>
        </div>
    </div>

    <!-- Pipeline Board -->
    <div class="flex-1 overflow-x-auto pb-4">
        <div class="flex gap-4 h-full min-w-max" id="pipeline-board">
            <div class="text-center py-20 w-full">
                <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
                <p class="text-gray-500">Loading pipeline...</p>
            </div>
        </div>
    </div>
</div>

<!-- Deal Modal -->
<div id="deal-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-900" id="modal-title">New Deal</h2>
            <button onclick="closeDealModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <form id="deal-form" onsubmit="saveDeal(event)" class="p-6 space-y-4">
            <input type="hidden" id="deal-id">
            <div class="grid md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deal Name *</label>
                    <input type="text" id="deal-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2 text-gray-500">$</span>
                        <input type="number" id="deal-amount" step="0.01" class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Expected Close</label>
                    <input type="date" id="deal-close-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
                    <select id="deal-contact" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <option value="">Select contact...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                    <select id="deal-company" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <option value="">Select company...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pricing Plan</label>
                    <select id="deal-plan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <option value="">Select plan...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Stage</label>
                    <select id="deal-stage" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"></select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="deal-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t">
                <button type="button" onclick="closeDealModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">Cancel</button>
                <button type="submit" class="px-6 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg font-medium hover:shadow-lg">Save Deal</button>
            </div>
        </form>
    </div>
</div>

<style>
.pipeline-column { width: 300px; min-width: 300px; background: #f9fafb; border-radius: 12px; display: flex; flex-direction: column; max-height: calc(100vh - 250px); }
.pipeline-header { padding: 16px; border-bottom: 1px solid #e5e7eb; }
.pipeline-cards { flex: 1; overflow-y: auto; padding: 12px; min-height: 100px; }
.deal-card { background: white; border-radius: 10px; padding: 14px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: grab; transition: all 0.2s; border: 2px solid transparent; }
.deal-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
.deal-card.dragging { opacity: 0.5; }
.pipeline-cards.drag-over { background: #fef3c7; border: 2px dashed #f59e0b; border-radius: 8px; }
</style>

<script>
let stages = [], deals = [];

document.addEventListener('DOMContentLoaded', () => {
    loadPipeline();
    loadDropdownData();
});

async function loadPipeline() {
    try {
        const [stagesRes, dealsRes] = await Promise.all([
            fetch('/hub/sales/api/stages'),
            fetch('/hub/sales/api/deals?status=open')
        ]);
        const stagesData = await stagesRes.json();
        const dealsData = await dealsRes.json();
        
        if (stagesData.success) stages = stagesData.stages;
        if (dealsData.success) deals = dealsData.deals;
        
        renderPipeline();
    } catch (e) { console.error(e); }
}

function renderPipeline() {
    const board = document.getElementById('pipeline-board');
    board.innerHTML = stages.filter(s => s.is_active).map(stage => {
        const stageDeals = deals.filter(d => d.stage_id === stage.id);
        const total = stageDeals.reduce((s, d) => s + parseFloat(d.amount || 0), 0);
        return `
            <div class="pipeline-column">
                <div class="pipeline-header">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full" style="background: ${stage.color}"></div>
                            <h3 class="font-semibold text-gray-900">${stage.name}</h3>
                        </div>
                        <span class="text-sm text-gray-500">${stageDeals.length}</span>
                    </div>
                    <p class="text-sm text-gray-600">$${formatNumber(total)}</p>
                </div>
                <div class="pipeline-cards" data-stage="${stage.id}" ondragover="e=>(e.preventDefault(),e.currentTarget.classList.add('drag-over'))" ondragleave="e=>e.currentTarget.classList.remove('drag-over')" ondrop="handleDrop(event, '${stage.id}')">
                    ${stageDeals.map(d => `
                        <div class="deal-card" draggable="true" data-id="${d.id}" ondragstart="handleDragStart(event)">
                            <div class="flex justify-between mb-2">
                                <span class="font-medium text-gray-900 text-sm">${d.name}</span>
                                <button onclick="editDeal('${d.id}')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-ellipsis-v"></i></button>
                            </div>
                            ${d.company_name ? `<p class="text-xs text-gray-500 mb-2"><i class="fas fa-building mr-1"></i>${d.company_name}</p>` : ''}
                            <p class="font-semibold text-gray-900">$${formatNumber(d.amount || 0)}</p>
                        </div>
                    `).join('')}
                    ${stageDeals.length === 0 ? '<p class="text-center text-gray-400 text-sm py-4">No deals</p>' : ''}
                </div>
            </div>
        `;
    }).join('');
    
    // Populate stage dropdown
    document.getElementById('deal-stage').innerHTML = stages.filter(s => !s.is_won && !s.is_lost).map(s => `<option value="${s.id}">${s.name}</option>`).join('');
}

let draggedId = null;
function handleDragStart(e) { draggedId = e.target.dataset.id; e.target.classList.add('dragging'); }
async function handleDrop(e, stageId) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    if (draggedId) {
        await fetch(`/hub/sales/api/deals/${draggedId}/move`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({stage_id: stageId})
        });
        loadPipeline();
    }
}

async function loadDropdownData() {
    const [contacts, companies, plans] = await Promise.all([
        fetch('/hub/sales/api/contacts?per_page=100').then(r => r.json()),
        fetch('/hub/sales/api/companies?per_page=100').then(r => r.json()),
        fetch('/hub/api/plans').then(r => r.json())
    ]);
    if (contacts.success) document.getElementById('deal-contact').innerHTML = '<option value="">Select...</option>' + contacts.contacts.map(c => `<option value="${c.id}">${c.first_name} ${c.last_name || ''}</option>`).join('');
    if (companies.success) document.getElementById('deal-company').innerHTML = '<option value="">Select...</option>' + companies.companies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    if (plans.success) document.getElementById('deal-plan').innerHTML = '<option value="">Select...</option>' + plans.plans.map(p => `<option value="${p.id}">${p.name} - $${p.price_monthly}/mo</option>`).join('');
}

function openDealModal() { document.getElementById('deal-modal').classList.remove('hidden'); document.getElementById('modal-title').textContent = 'New Deal'; document.getElementById('deal-form').reset(); document.getElementById('deal-id').value = ''; }
function closeDealModal() { document.getElementById('deal-modal').classList.add('hidden'); }

function editDeal(id) {
    const deal = deals.find(d => d.id === id);
    if (!deal) return;
    document.getElementById('deal-modal').classList.remove('hidden');
    document.getElementById('modal-title').textContent = 'Edit Deal';
    document.getElementById('deal-id').value = deal.id;
    document.getElementById('deal-name').value = deal.name || '';
    document.getElementById('deal-amount').value = deal.amount || '';
    document.getElementById('deal-close-date').value = deal.expected_close_date ? deal.expected_close_date.split('T')[0] : '';
    document.getElementById('deal-contact').value = deal.contact_id || '';
    document.getElementById('deal-company').value = deal.company_id || '';
    document.getElementById('deal-plan').value = deal.pricing_plan_id || '';
    document.getElementById('deal-stage').value = deal.stage_id || '';
    document.getElementById('deal-description').value = deal.description || '';
}

async function saveDeal(e) {
    e.preventDefault();
    const id = document.getElementById('deal-id').value;
    const data = {
        name: document.getElementById('deal-name').value,
        amount: parseFloat(document.getElementById('deal-amount').value) || 0,
        expected_close_date: document.getElementById('deal-close-date').value || null,
        contact_id: document.getElementById('deal-contact').value || null,
        company_id: document.getElementById('deal-company').value || null,
        pricing_plan_id: document.getElementById('deal-plan').value || null,
        stage_id: document.getElementById('deal-stage').value || null,
        description: document.getElementById('deal-description').value || null
    };
    const res = await fetch(id ? `/hub/sales/api/deals/${id}` : '/hub/sales/api/deals', {
        method: id ? 'PUT' : 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    if ((await res.json()).success) { closeDealModal(); loadPipeline(); }
}

function formatNumber(n) { return new Intl.NumberFormat().format(n || 0); }
</script>
{% endblock %}
