{% extends 'hub/base.html' %}
{% block title %}Companies - Sales CRM{% endblock %}
{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Companies</h1>
            <p class="text-gray-600">Manage your company accounts</p>
        </div>
        <button onclick="openModal()" class="px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg font-medium hover:shadow-lg flex items-center gap-2">
            <i class="fas fa-plus"></i> New Company
        </button>
    </div>

    <div class="bg-white rounded-xl shadow-sm border p-4">
        <input type="text" id="search" placeholder="Search companies..." onkeyup="loadCompanies()" class="px-4 py-2 border rounded-lg w-full max-w-md">
    </div>

    <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Company</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Industry</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Website</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody id="companies-table" class="divide-y divide-gray-200"></tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
        <div class="p-6 border-b flex justify-between items-center">
            <h2 class="text-xl font-bold">New Company</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <form id="company-form" onsubmit="saveCompany(event)" class="p-6 space-y-4">
            <input type="hidden" id="company-id">
            <div>
                <label class="block text-sm font-medium mb-1">Company Name *</label>
                <input type="text" id="company-name" required class="w-full px-4 py-2 border rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Industry</label>
                <input type="text" id="company-industry" class="w-full px-4 py-2 border rounded-lg">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="company-email" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Phone</label>
                    <input type="text" id="company-phone" class="w-full px-4 py-2 border rounded-lg">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Website</label>
                <input type="url" id="company-website" class="w-full px-4 py-2 border rounded-lg">
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded-lg">Cancel</button>
                <button type="submit" class="px-6 py-2 bg-orange-500 text-white rounded-lg">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', loadCompanies);

async function loadCompanies() {
    const search = document.getElementById('search').value;
    const res = await fetch(`/hub/sales/api/companies?search=${search}`);
    const data = await res.json();
    const tbody = document.getElementById('companies-table');
    
    if (data.success && data.companies.length > 0) {
        tbody.innerHTML = data.companies.map(c => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 font-medium">${c.name}</td>
                <td class="px-6 py-4 text-gray-500">${c.industry || '-'}</td>
                <td class="px-6 py-4 text-gray-500">${c.email || '-'}</td>
                <td class="px-6 py-4 text-gray-500">${c.phone || '-'}</td>
                <td class="px-6 py-4 text-gray-500">${c.website ? `<a href="${c.website}" target="_blank" class="text-blue-600">${c.website}</a>` : '-'}</td>
                <td class="px-6 py-4 text-right">
                    <button onclick="deleteCompany('${c.id}')" class="text-red-600 hover:underline">Delete</button>
                </td>
            </tr>
        `).join('');
    } else {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">No companies found</td></tr>';
    }
}

function openModal() { document.getElementById('modal').classList.remove('hidden'); document.getElementById('company-form').reset(); }
function closeModal() { document.getElementById('modal').classList.add('hidden'); }

async function saveCompany(e) {
    e.preventDefault();
    const data = {
        name: document.getElementById('company-name').value,
        industry: document.getElementById('company-industry').value,
        email: document.getElementById('company-email').value,
        phone: document.getElementById('company-phone').value,
        website: document.getElementById('company-website').value
    };
    await fetch('/hub/sales/api/companies', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    closeModal();
    loadCompanies();
}

async function deleteCompany(id) {
    if (confirm('Delete this company?')) {
        await fetch(`/hub/sales/api/companies/${id}`, {method: 'DELETE'});
        loadCompanies();
    }
}
</script>
{% endblock %}
