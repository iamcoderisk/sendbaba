{% extends "hub/base.html" %}
{% set active_page = 'users' %}

{% block title %}Users{% endblock %}

{% block content %}
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
    <div>
        <h1 class="text-xl lg:text-2xl font-bold text-gray-800">Users Management</h1>
        <p class="text-gray-500 text-sm">Manage all registered users</p>
    </div>
    <div class="w-full sm:w-auto">
        <div class="relative">
            <input type="text" id="search-input" placeholder="Search users..." 
                class="w-full sm:w-64 pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
        </div>
    </div>
</div>

<!-- Stats -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-6 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-4">
        <p class="text-gray-500 text-xs">Total Users</p>
        <p id="total-users" class="text-xl lg:text-3xl font-bold text-gray-800">--</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4">
        <p class="text-gray-500 text-xs">Active</p>
        <p id="active-users" class="text-xl lg:text-3xl font-bold text-green-600">--</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4">
        <p class="text-gray-500 text-xs">Verified</p>
        <p id="verified-users" class="text-xl lg:text-3xl font-bold text-blue-600">--</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4">
        <p class="text-gray-500 text-xs">Today</p>
        <p id="new-today" class="text-xl lg:text-3xl font-bold text-purple-600">--</p>
    </div>
</div>

<!-- Users Table -->
<div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full min-w-[600px]">
            <thead class="bg-gray-50">
                <tr class="text-left text-xs lg:text-sm text-gray-500">
                    <th class="px-4 lg:px-6 py-3 lg:py-4">User</th>
                    <th class="px-4 lg:px-6 py-3 lg:py-4 hidden md:table-cell">Organization</th>
                    <th class="px-4 lg:px-6 py-3 lg:py-4">Status</th>
                    <th class="px-4 lg:px-6 py-3 lg:py-4 hidden sm:table-cell">Emails</th>
                    <th class="px-4 lg:px-6 py-3 lg:py-4 hidden lg:table-cell">Joined</th>
                    <th class="px-4 lg:px-6 py-3 lg:py-4">Actions</th>
                </tr>
            </thead>
            <tbody id="users-table" class="text-sm">
                <!-- Users populated by JS -->
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="px-4 lg:px-6 py-3 lg:py-4 border-t flex flex-col sm:flex-row items-center justify-between gap-3">
        <p class="text-xs lg:text-sm text-gray-500">Showing <span id="showing-count">0</span> of <span id="total-count">0</span></p>
        <div class="flex space-x-2">
            <button onclick="changePage(-1)" class="px-3 lg:px-4 py-2 border rounded hover:bg-gray-50 text-sm">Prev</button>
            <button onclick="changePage(1)" class="px-3 lg:px-4 py-2 border rounded hover:bg-gray-50 text-sm">Next</button>
        </div>
    </div>
</div>

<!-- User Modal -->
<div id="user-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-md p-4 lg:p-6 max-h-[90vh] overflow-y-auto">
        <h3 class="text-lg lg:text-xl font-bold mb-4">Edit User</h3>
        <form id="user-form">
            <input type="hidden" id="edit-user-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="edit-email" class="w-full px-4 py-2 border rounded-lg bg-gray-50" disabled>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Active</label>
                        <select id="edit-active" class="w-full px-4 py-2 border rounded-lg">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Verified</label>
                        <select id="edit-verified" class="w-full px-4 py-2 border rounded-lg">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select id="edit-role" class="w-full px-4 py-2 border rounded-lg">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                        <option value="owner">Owner</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let totalPages = 1;
    let searchTimeout;

    async function loadUsers(page = 1, search = '') {
        try {
            const res = await fetch(`/hub/api/users?page=${page}&per_page=20&search=${encodeURIComponent(search)}`);
            const data = await res.json();
            
            if (data.success) {
                currentPage = data.page;
                totalPages = data.pages;
                
                document.getElementById('total-users').textContent = data.total;
                document.getElementById('total-count').textContent = data.total;
                document.getElementById('showing-count').textContent = data.users.length;
                
                const table = document.getElementById('users-table');
                table.innerHTML = data.users.map(u => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 lg:px-6 py-3 lg:py-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 lg:w-10 lg:h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="text-blue-600 font-medium text-sm">${(u.first_name || u.email)[0].toUpperCase()}</span>
                                </div>
                                <div class="min-w-0">
                                    <p class="font-medium text-sm truncate">${u.first_name || ''} ${u.last_name || ''}</p>
                                    <p class="text-xs text-gray-500 truncate">${u.email}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 lg:px-6 py-3 lg:py-4 text-sm hidden md:table-cell">${u.org_name || '-'}</td>
                        <td class="px-4 lg:px-6 py-3 lg:py-4">
                            <span class="px-2 py-0.5 rounded-full text-xs ${u.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                ${u.is_active ? 'Active' : 'Off'}
                            </span>
                        </td>
                        <td class="px-4 lg:px-6 py-3 lg:py-4 text-sm hidden sm:table-cell">${formatNumber(u.email_count || 0)}</td>
                        <td class="px-4 lg:px-6 py-3 lg:py-4 text-sm text-gray-500 hidden lg:table-cell">${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}</td>
                        <td class="px-4 lg:px-6 py-3 lg:py-4">
                            <button onclick="editUser('${u.id}')" class="text-blue-600 hover:text-blue-800 p-1">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteUser('${u.id}')" class="text-red-600 hover:text-red-800 p-1 ml-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">No users found</td></tr>';
            }
        } catch (e) { console.error(e); }
    }

    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            loadUsers(newPage, document.getElementById('search-input').value);
        }
    }

    document.getElementById('search-input').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => loadUsers(1, e.target.value), 300);
    });

    async function editUser(userId) {
        const res = await fetch(`/hub/api/users/${userId}`);
        const data = await res.json();
        if (data.success) {
            document.getElementById('edit-user-id').value = userId;
            document.getElementById('edit-email').value = data.user.email;
            document.getElementById('edit-active').value = data.user.is_active ? 'true' : 'false';
            document.getElementById('edit-verified').value = data.user.is_verified ? 'true' : 'false';
            document.getElementById('edit-role').value = data.user.role || 'user';
            document.getElementById('user-modal').classList.remove('hidden');
            document.getElementById('user-modal').classList.add('flex');
        }
    }

    function closeModal() {
        document.getElementById('user-modal').classList.add('hidden');
        document.getElementById('user-modal').classList.remove('flex');
    }

    document.getElementById('user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const userId = document.getElementById('edit-user-id').value;
        const res = await fetch(`/hub/api/users/${userId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                is_active: document.getElementById('edit-active').value === 'true',
                is_verified: document.getElementById('edit-verified').value === 'true',
                role: document.getElementById('edit-role').value
            })
        });
        if ((await res.json()).success) {
            closeModal();
            loadUsers(currentPage);
        }
    });

    async function deleteUser(userId) {
        if (confirm('Delete this user?')) {
            await fetch(`/hub/api/users/${userId}`, { method: 'DELETE' });
            loadUsers(currentPage);
        }
    }

    loadUsers();
</script>
{% endblock %}
