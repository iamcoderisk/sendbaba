{% extends "hub/base.html" %}
{% set active_page = 'dashboard' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
    <div>
        <h1 class="text-xl lg:text-2xl font-bold text-gray-800">Dashboard</h1>
        <p class="text-gray-500 text-sm">Welcome back, {{ admin.hub_admin_name or 'Admin' }}</p>
    </div>
    <div class="flex items-center space-x-4">
        <span id="last-update" class="text-xs text-gray-500 hidden sm:block"></span>
        <button onclick="refreshAll()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm">
            <i class="fas fa-sync-alt mr-1"></i><span class="hidden sm:inline">Refresh</span>
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-6 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-4 lg:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-xs lg:text-sm">Total Users</p>
                <p id="stat-users" class="text-xl lg:text-3xl font-bold text-gray-800">--</p>
            </div>
            <div class="w-10 h-10 lg:w-12 lg:h-12 bg-blue-100 rounded-full flex items-center justify-center">
                <i class="fas fa-users text-blue-600 text-sm lg:text-base"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm p-4 lg:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-xs lg:text-sm">Organizations</p>
                <p id="stat-orgs" class="text-xl lg:text-3xl font-bold text-gray-800">--</p>
            </div>
            <div class="w-10 h-10 lg:w-12 lg:h-12 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-building text-green-600 text-sm lg:text-base"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm p-4 lg:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-xs lg:text-sm">Emails Today</p>
                <p id="stat-emails-24h" class="text-xl lg:text-3xl font-bold text-gray-800">--</p>
            </div>
            <div class="w-10 h-10 lg:w-12 lg:h-12 bg-purple-100 rounded-full flex items-center justify-center">
                <i class="fas fa-envelope text-purple-600 text-sm lg:text-base"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm p-4 lg:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-xs lg:text-sm">Workers</p>
                <p id="stat-workers" class="text-xl lg:text-3xl font-bold text-gray-800">--</p>
            </div>
            <div class="w-10 h-10 lg:w-12 lg:h-12 bg-orange-100 rounded-full flex items-center justify-center">
                <i class="fas fa-server text-orange-600 text-sm lg:text-base"></i>
            </div>
        </div>
    </div>
</div>

<!-- Second Row -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6 mb-6">
    <!-- Capacity Card -->
    <div class="bg-white rounded-xl shadow-sm p-4 lg:p-6">
        <h3 class="font-bold text-gray-800 mb-4 text-sm lg:text-base">Daily Capacity</h3>
        <div class="space-y-4">
            <div>
                <div class="flex justify-between text-xs lg:text-sm mb-1">
                    <span class="text-gray-500">Used</span>
                    <span id="capacity-used" class="font-medium">--</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 lg:h-3">
                    <div id="capacity-bar" class="bg-blue-600 h-2 lg:h-3 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 text-xs lg:text-sm">
                <div>
                    <p class="text-gray-500">Total</p>
                    <p id="stat-capacity" class="font-bold text-base lg:text-lg">--</p>
                </div>
                <div>
                    <p class="text-gray-500">Remaining</p>
                    <p id="stat-remaining" class="font-bold text-base lg:text-lg text-green-600">--</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Workers Status -->
    <div class="bg-white rounded-xl shadow-sm p-4 lg:p-6 lg:col-span-2">
        <h3 class="font-bold text-gray-800 mb-4 text-sm lg:text-base">Worker Nodes</h3>
        <div id="workers-grid" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-2 lg:gap-3">
            <!-- Workers populated by JS -->
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-4 lg:p-6">
        <h3 class="font-bold text-gray-800 mb-4 text-sm lg:text-base">Email Volume (24h)</h3>
        <div class="h-48 lg:h-auto">
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm p-4 lg:p-6">
        <h3 class="font-bold text-gray-800 mb-4 text-sm lg:text-base">Recent Campaigns</h3>
        <div id="campaigns-list" class="space-y-2 lg:space-y-3 max-h-48 lg:max-h-64 overflow-y-auto">
            <!-- Campaigns populated by JS -->
        </div>
    </div>
</div>

<!-- IP Pools -->
<div class="bg-white rounded-xl shadow-sm p-4 lg:p-6">
    <h3 class="font-bold text-gray-800 mb-4 text-sm lg:text-base">IP Pool Status</h3>
    <div class="overflow-x-auto -mx-4 lg:mx-0">
        <table class="w-full min-w-[600px]">
            <thead>
                <tr class="text-left text-xs lg:text-sm text-gray-500 border-b">
                    <th class="pb-3 px-4 lg:px-2">IP Address</th>
                    <th class="pb-3 hidden sm:table-cell">Hostname</th>
                    <th class="pb-3">Status</th>
                    <th class="pb-3">Warmup</th>
                    <th class="pb-3">Sent / Limit</th>
                    <th class="pb-3">Usage</th>
                </tr>
            </thead>
            <tbody id="ip-pools-table" class="text-xs lg:text-sm">
                <!-- IPs populated by JS -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let hourlyChart = null;
    
    async function loadStats() {
        try {
            const res = await fetch('/hub/api/stats');
            const data = await res.json();
            if (data.success) {
                const s = data.stats;
                document.getElementById('stat-users').textContent = formatNumber(s.total_users);
                document.getElementById('stat-orgs').textContent = formatNumber(s.total_orgs);
                document.getElementById('stat-emails-24h').textContent = formatNumber(s.emails_24h);
                document.getElementById('stat-capacity').textContent = formatNumber(s.total_capacity);
                document.getElementById('stat-remaining').textContent = formatNumber(s.remaining_capacity);
                
                const usedPct = s.total_capacity > 0 ? (s.total_sent_today / s.total_capacity * 100).toFixed(1) : 0;
                document.getElementById('capacity-used').textContent = `${formatNumber(s.total_sent_today)} (${usedPct}%)`;
                document.getElementById('capacity-bar').style.width = `${usedPct}%`;
                
                if (s.pending_orders > 0) {
                    document.getElementById('pending-badge').textContent = s.pending_orders;
                    document.getElementById('pending-badge').classList.remove('hidden');
                }
            }
        } catch (e) { console.error(e); }
    }
    
    async function loadWorkers() {
        try {
            const res = await fetch('/hub/api/workers');
            const data = await res.json();
            if (data.success) {
                document.getElementById('stat-workers').textContent = data.total_workers;
                
                const grid = document.getElementById('workers-grid');
                grid.innerHTML = data.workers.map(w => `
                    <div class="p-2 lg:p-3 rounded-lg border ${w.status === 'online' ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-mono truncate">${w.name.replace('worker@', '').slice(-8)}</span>
                            <span class="w-2 h-2 rounded-full flex-shrink-0 ${w.status === 'online' ? 'bg-green-500' : 'bg-red-500'}"></span>
                        </div>
                        <p class="text-xs text-gray-500">${w.concurrency} threads</p>
                    </div>
                `).join('');
            }
        } catch (e) { console.error(e); }
    }
    
    async function loadIPPools() {
        try {
            const res = await fetch('/hub/api/ip-pools');
            const data = await res.json();
            if (data.success) {
                const table = document.getElementById('ip-pools-table');
                table.innerHTML = data.ip_pools.map(ip => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-2 lg:py-3 px-4 lg:px-2 font-mono">${ip.ip_address}</td>
                        <td class="py-2 lg:py-3 hidden sm:table-cell">${ip.hostname || '-'}</td>
                        <td class="py-2 lg:py-3">
                            <span class="px-2 py-0.5 rounded-full text-xs ${ip.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                ${ip.is_active ? 'Active' : 'Off'}
                            </span>
                        </td>
                        <td class="py-2 lg:py-3">
                            <span class="px-2 py-0.5 rounded-full text-xs ${ip.warmup_day >= 30 ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                ${ip.warmup_day >= 30 ? 'âœ“' : 'D' + ip.warmup_day}
                            </span>
                        </td>
                        <td class="py-2 lg:py-3">${formatNumber(ip.sent_today)}/${formatNumber(ip.daily_limit)}</td>
                        <td class="py-2 lg:py-3">
                            <div class="flex items-center space-x-2">
                                <div class="w-16 lg:w-24 bg-gray-200 rounded-full h-1.5 lg:h-2">
                                    <div class="bg-blue-600 h-1.5 lg:h-2 rounded-full" style="width: ${ip.usage_pct || 0}%"></div>
                                </div>
                                <span class="text-xs text-gray-500">${ip.usage_pct || 0}%</span>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        } catch (e) { console.error(e); }
    }
    
    async function loadHourlyChart() {
        try {
            const res = await fetch('/hub/api/emails/hourly');
            const data = await res.json();
            if (data.success && data.hourly.length > 0) {
                const ctx = document.getElementById('hourlyChart').getContext('2d');
                if (hourlyChart) hourlyChart.destroy();
                
                hourlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.hourly.map(h => new Date(h.hour).toLocaleTimeString('en-US', {hour: '2-digit'})),
                        datasets: [{
                            label: 'Sent',
                            data: data.hourly.map(h => h.sent),
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        }, {
                            label: 'Failed',
                            data: data.hourly.map(h => h.failed),
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                        plugins: { legend: { display: window.innerWidth > 640 } }
                    }
                });
            }
        } catch (e) { console.error(e); }
    }
    
    async function loadCampaigns() {
        try {
            const res = await fetch('/hub/api/campaigns/recent');
            const data = await res.json();
            if (data.success) {
                const list = document.getElementById('campaigns-list');
                list.innerHTML = data.campaigns.slice(0, 10).map(c => `
                    <div class="flex items-center justify-between p-2 lg:p-3 bg-gray-50 rounded-lg">
                        <div class="min-w-0 flex-1">
                            <p class="font-medium text-xs lg:text-sm truncate">${c.name || 'Unnamed'}</p>
                            <p class="text-xs text-gray-500 truncate">${c.org_name || 'Unknown'}</p>
                        </div>
                        <div class="text-right ml-2 flex-shrink-0">
                            <span class="px-2 py-0.5 rounded text-xs ${
                                c.status === 'completed' ? 'bg-green-100 text-green-700' :
                                c.status === 'sending' ? 'bg-blue-100 text-blue-700' :
                                'bg-gray-100 text-gray-700'
                            }">${c.status}</span>
                        </div>
                    </div>
                `).join('') || '<p class="text-gray-500 text-sm text-center py-4">No campaigns yet</p>';
            }
        } catch (e) { console.error(e); }
    }
    
    async function refreshAll() {
        await Promise.all([loadStats(), loadWorkers(), loadIPPools(), loadHourlyChart(), loadCampaigns()]);
        document.getElementById('last-update').textContent = 'Updated: ' + new Date().toLocaleTimeString();
    }
    
    refreshAll();
    setInterval(refreshAll, 30000);
</script>
{% endblock %}
