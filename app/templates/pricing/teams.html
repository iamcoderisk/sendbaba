{% extends "base.html" %}

{% block title %}Team Pricing - SendBaba{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 py-12 px-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-bold text-gray-900 mb-4">Team Pricing Plans</h1>
            <p class="text-xl text-gray-600 mb-8">Scale your email sending with team-based limits</p>
            
            {% if current_plan and current_plan.plan != 'individual' %}
            <div class="inline-block bg-green-100 border border-green-300 rounded-lg px-6 py-3">
                <p class="text-green-800 font-semibold">
                    <i class="fas fa-check-circle mr-2"></i>Current Plan: {{ current_plan.plan|title }}
                    <span class="ml-4">{{ "{:,}".format(current_plan.daily_limit) }} emails/day</span>
                    <span class="ml-4">${{ "%.2f"|format(current_plan.price) }}/month</span>
                </p>
            </div>
            {% endif %}
        </div>

        <!-- Team Size Calculator -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-12">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Calculate Your Team Plan</h2>
            
            <div class="max-w-3xl mx-auto">
                <!-- Team Size Slider -->
                <div class="mb-8">
                    <label class="block text-lg font-semibold text-gray-700 mb-3">
                        Number of Team Members: <span class="text-purple-600" id="teamSizeDisplay">1</span>
                    </label>
                    <input type="range" id="teamSizeSlider" min="1" max="30" value="1" 
                           class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                           oninput="updateTeamSize(this.value)">
                    <div class="flex justify-between text-sm text-gray-500 mt-2">
                        <span>1 member</span>
                        <span>30+ members</span>
                    </div>
                </div>

                <!-- Billing Cycle Toggle -->
                <div class="flex justify-center items-center gap-4 mb-8">
                    <span class="text-gray-700 font-medium">Monthly</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="billingToggle" class="sr-only peer" onchange="updateBillingCycle()">
                        <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-purple-600"></div>
                    </label>
                    <span class="text-gray-700 font-medium">Annual <span class="text-green-600 text-sm">(Save 17%)</span></span>
                </div>

                <!-- Calculated Result -->
                <div id="calculatedPlan" class="bg-gradient-to-r from-purple-100 to-blue-100 rounded-xl p-8 hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Recommended Plan</p>
                            <p class="text-3xl font-bold text-purple-600" id="planName">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Daily Email Limit</p>
                            <p class="text-3xl font-bold text-gray-900" id="dailyLimit">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Total Price</p>
                            <p class="text-3xl font-bold text-gray-900">
                                $<span id="totalPrice">0</span>
                                <span class="text-lg text-gray-500">/<span id="billingPeriod">month</span></span>
                            </p>
                            <p class="text-sm text-green-600 font-semibold" id="savingsText"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Cost Per Member</p>
                            <p class="text-3xl font-bold text-gray-900">$<span id="pricePerMember">0</span></p>
                        </div>
                    </div>

                    <!-- Features -->
                    <div class="mt-6 pt-6 border-t border-gray-300">
                        <p class="font-semibold text-gray-700 mb-3">Included Features:</p>
                        <ul class="grid grid-cols-1 md:grid-cols-2 gap-2" id="featuresList"></ul>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4 mt-8">
                        <button onclick="startUpgrade()" id="upgradeBtn" class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white px-8 py-4 rounded-xl hover:from-purple-700 hover:to-blue-700 transition font-bold text-lg shadow-lg">
                            <i class="fas fa-rocket mr-2"></i>Upgrade Now
                        </button>
                        <button onclick="cancelCalculator()" class="px-8 py-4 border-2 border-gray-300 rounded-xl hover:bg-gray-50 transition font-semibold">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plan Comparison Table -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="px-8 py-6 bg-gradient-to-r from-purple-600 to-blue-600">
                <h2 class="text-3xl font-bold text-white text-center">Compare All Plans</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Plan</th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Team Size</th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Daily Limit</th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Monthly Price</th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Annual Price</th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Features</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for plan in plans %}
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-6 py-4">
                                <span class="font-bold text-lg text-purple-600">{{ plan.name|title }}</span>
                            </td>
                            <td class="px-6 py-4 text-gray-700">
                                {{ plan.min_members }}{% if plan.max_members %}-{{ plan.max_members }}{% else %}+{% endif %} members
                            </td>
                            <td class="px-6 py-4 text-gray-900 font-semibold">
                                {{ "{:,}".format(plan.daily_limit) }}
                            </td>
                            <td class="px-6 py-4 text-gray-900 font-bold">
                                ${{ "%.2f"|format(plan.monthly_price) }}
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-gray-900 font-bold">${{ "%.2f"|format(plan.annual_price) }}</span>
                                <span class="block text-xs text-green-600">Save ${{ "%.2f"|format((plan.monthly_price * 12) - plan.annual_price) }}</span>
                            </td>
                            <td class="px-6 py-4">
                                <ul class="text-sm text-gray-600 space-y-1">
                                    {% for feature in plan.features[:3] %}
                                    <li><i class="fas fa-check text-green-500 mr-1"></i>{{ feature }}</li>
                                    {% endfor %}
                                </ul>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- FAQ Section -->
        <div class="mt-12 bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">Frequently Asked Questions</h2>
            <div class="max-w-3xl mx-auto space-y-6">
                <div class="border-b border-gray-200 pb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">What happens if I exceed my daily limit?</h3>
                    <p class="text-gray-600">Your domain will be temporarily paused for 24 hours. Upgrade to a higher plan to increase your limit.</p>
                </div>
                <div class="border-b border-gray-200 pb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Can I change plans anytime?</h3>
                    <p class="text-gray-600">Yes! You can upgrade or downgrade your plan at any time. Changes take effect immediately.</p>
                </div>
                <div class="border-b border-gray-200 pb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Do team members share the daily limit?</h3>
                    <p class="text-gray-600">Yes, the daily limit is pooled across all team members. Admins can monitor usage in the dashboard.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upgrade Modal with Progress -->
<div id="upgradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">
        <div id="upgradeContent">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-rocket text-purple-600 text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">Confirm Upgrade</h3>
                <p class="text-gray-600">You're about to upgrade to:</p>
            </div>

            <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-6 mb-6">
                <div class="text-center">
                    <p class="text-lg font-semibold text-gray-700 mb-2" id="modalPlanName">-</p>
                    <p class="text-4xl font-bold text-purple-600 mb-1">$<span id="modalPrice">0</span></p>
                    <p class="text-sm text-gray-600" id="modalBillingCycle">per month</p>
                    <p class="text-sm text-gray-700 mt-4">
                        <span class="font-semibold" id="modalDailyLimit">-</span> emails/day
                    </p>
                </div>
            </div>

            <!-- Progress Bar (hidden initially) -->
            <div id="upgradeProgress" class="hidden mb-6">
                <div class="bg-gray-200 rounded-full h-3 overflow-hidden">
                    <div id="upgradeProgressBar" class="bg-gradient-to-r from-purple-600 to-blue-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p class="text-center text-sm text-gray-600 mt-2" id="upgradeStatusText">Processing...</p>
            </div>

            <div class="flex gap-4">
                <button onclick="closeUpgradeModal()" id="cancelUpgradeBtn" class="flex-1 px-6 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50 transition font-semibold">
                    Cancel
                </button>
                <button onclick="confirmUpgrade()" id="confirmUpgradeBtn" class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg hover:from-purple-700 hover:to-blue-700 transition font-semibold">
                    Confirm Upgrade
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<script>
let currentCalculation = null;

// Update team size
function updateTeamSize(value) {
    document.getElementById('teamSizeDisplay').textContent = value;
    calculatePrice();
}

// Update billing cycle
function updateBillingCycle() {
    const isAnnual = document.getElementById('billingToggle').checked;
    document.getElementById('billingPeriod').textContent = isAnnual ? 'year' : 'month';
    calculatePrice();
}

// Calculate price based on inputs
async function calculatePrice() {
    const teamSize = parseInt(document.getElementById('teamSizeSlider').value);
    const billingCycle = document.getElementById('billingToggle').checked ? 'annual' : 'monthly';
    
    try {
        const response = await fetch('/pricing/api/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ team_size: teamSize, billing_cycle: billingCycle })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentCalculation = data;
            
            // Update UI
            document.getElementById('calculatedPlan').classList.remove('hidden');
            document.getElementById('planName').textContent = data.plan_name.toUpperCase();
            document.getElementById('dailyLimit').textContent = data.daily_limit.toLocaleString();
            document.getElementById('totalPrice').textContent = data.price.toFixed(2);
            document.getElementById('pricePerMember').textContent = data.price_per_member.toFixed(2);
            
            // Show savings
            if (data.savings > 0) {
                document.getElementById('savingsText').textContent = `Save $${data.savings.toFixed(2)} annually!`;
                document.getElementById('savingsText').classList.remove('hidden');
            } else {
                document.getElementById('savingsText').classList.add('hidden');
            }
            
            // Update features
            const featuresList = document.getElementById('featuresList');
            featuresList.innerHTML = '';
            data.features.forEach(feature => {
                featuresList.innerHTML += `
                    <li class="text-gray-700">
                        <i class="fas fa-check text-green-500 mr-2"></i>${feature}
                    </li>
                `;
            });
        }
    } catch (error) {
        console.error('Calculate error:', error);
        showToast('error', 'Failed to calculate price');
    }
}

// Cancel calculator
function cancelCalculator() {
    document.getElementById('calculatedPlan').classList.add('hidden');
    document.getElementById('teamSizeSlider').value = 1;
    document.getElementById('teamSizeDisplay').textContent = 1;
    document.getElementById('billingToggle').checked = false;
}

// Start upgrade process
function startUpgrade() {
    if (!currentCalculation) {
        showToast('error', 'Please select a plan first');
        return;
    }
    
    // Populate modal
    document.getElementById('modalPlanName').textContent = currentCalculation.plan_name.toUpperCase() + ' Plan';
    document.getElementById('modalPrice').textContent = currentCalculation.price.toFixed(2);
    document.getElementById('modalBillingCycle').textContent = 'per ' + currentCalculation.billing_cycle.replace('ly', '');
    document.getElementById('modalDailyLimit').textContent = currentCalculation.daily_limit.toLocaleString();
    
    // Show modal
    document.getElementById('upgradeModal').classList.remove('hidden');
}

// Close upgrade modal
function closeUpgradeModal() {
    document.getElementById('upgradeModal').classList.add('hidden');
    document.getElementById('upgradeProgress').classList.add('hidden');
    document.getElementById('upgradeProgressBar').style.width = '0%';
}

// Confirm upgrade
async function confirmUpgrade() {
    if (!currentCalculation) return;
    
    // Disable buttons
    document.getElementById('confirmUpgradeBtn').disabled = true;
    document.getElementById('cancelUpgradeBtn').disabled = true;
    
    // Show progress
    document.getElementById('upgradeProgress').classList.remove('hidden');
    document.getElementById('upgradeStatusText').textContent = 'Processing upgrade...';
    
    // Animate progress bar
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        document.getElementById('upgradeProgressBar').style.width = progress + '%';
    }, 100);
    
    try {
        const response = await fetch('/pricing/api/upgrade', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                plan_name: currentCalculation.plan_name,
                team_size: parseInt(document.getElementById('teamSizeSlider').value),
                billing_cycle: document.getElementById('billingToggle').checked ? 'annual' : 'monthly'
            })
        });
        
        const data = await response.json();
        
        clearInterval(progressInterval);
        document.getElementById('upgradeProgressBar').style.width = '100%';
        
        if (data.success) {
            document.getElementById('upgradeStatusText').textContent = 'Upgrade successful!';
            showToast('success', data.message);
            
            setTimeout(() => {
                window.location.href = data.redirect || '/dashboard/';
            }, 1500);
        } else {
            document.getElementById('upgradeStatusText').textContent = 'Upgrade failed';
            showToast('error', data.error || 'Upgrade failed');
            
            // Re-enable buttons
            document.getElementById('confirmUpgradeBtn').disabled = false;
            document.getElementById('cancelUpgradeBtn').disabled = false;
        }
    } catch (error) {
        clearInterval(progressInterval);
        console.error('Upgrade error:', error);
        showToast('error', 'Network error occurred');
        
        // Re-enable buttons
        document.getElementById('confirmUpgradeBtn').disabled = false;
        document.getElementById('cancelUpgradeBtn').disabled = false;
    }
}

// Toast notification system
function showToast(type, message) {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
    };
    
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    const toast = document.createElement('div');
    toast.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 animate-slide-left min-w-80`;
    toast.innerHTML = `
        <i class="fas ${icons[type]} text-xl"></i>
        <span class="font-semibold flex-1">${message}</span>
        <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200 text-xl">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    document.getElementById('toastContainer').appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

// Initial calculation on page load
if (document.getElementById('teamSizeSlider')) {
    calculatePrice();
}
</script>

<style>
@keyframes slide-left {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
.animate-slide-left {
    animation: slide-left 0.3s ease-out;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: linear-gradient(135deg, #9333ea 0%, #3b82f6 100%);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(147, 51, 234, 0.4);
}

input[type="range"]::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: linear-gradient(135deg, #9333ea 0%, #3b82f6 100%);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(147, 51, 234, 0.4);
    border: none;
}
</style>
{% endblock %}
