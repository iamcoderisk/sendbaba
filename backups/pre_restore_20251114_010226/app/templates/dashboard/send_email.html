{% extends "base.html" %}

{% block title %}Send Email - SendBaba{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/templates.css">

<div class="max-w-4xl mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">üìß Send Email</h1>
        <p class="text-gray-600 mt-2">Send a single email or test your setup</p>
    </div>

    {% if not domains or domains|length == 0 %}
    <!-- No domains warning -->
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg">
        <div class="flex items-center mb-4">
            <div class="text-4xl mr-4">üîß</div>
            <div>
                <h3 class="text-lg font-semibold text-yellow-800">No Verified Domains</h3>
                <p class="text-yellow-700">You need to add and verify a domain before sending emails</p>
            </div>
        </div>
        <a href="{{ url_for('domains.list_domains') }}" 
           class="inline-block px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
            Add Your First Domain
        </a>
    </div>
    {% else %}

    <!-- Template Library Link -->
    <div class="mb-6">
        <a href="/dashboard/templates" class="inline-flex items-center px-4 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 border border-purple-200">
            <i class="fas fa-palette mr-2"></i>
            Browse Professional Templates
        </a>
    </div>

    <!-- Send Email Form -->
    <div class="bg-white rounded-lg shadow-lg p-8">
        <form id="sendEmailForm">
            <!-- From Section -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">From Email *</label>
                <div class="flex items-center space-x-4">
                    <input type="text" name="from_name" placeholder="sender" required
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                    <span class="text-gray-500">@</span>
                    <select name="from_domain" required
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                        {% for domain in domains %}
                        <option value="{{ domain.domain_name }}">{{ domain.domain_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <p class="text-xs text-gray-500 mt-1">Example: hello@{{ domains[0].domain_name }}</p>
            </div>

            <!-- To Email -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">To Email *</label>
                <input type="email" name="to_email" required
                       placeholder="recipient@example.com"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
            </div>

            <!-- Subject -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Subject *</label>
                <input type="text" name="subject" required
                       placeholder="Enter email subject"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
            </div>

            <!-- Quick Templates Dropdown -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Quick Templates</label>
                <select id="templateSelect" onchange="loadQuickTemplate(this.value)"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none bg-white">
                    <option value="">Blank (Custom HTML)</option>
                    <option value="simple">Simple Email</option>
                    <option value="welcome">Welcome Email</option>
                    <option value="newsletter">Newsletter</option>
                    <option value="promotional">Promotional</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Or <a href="/dashboard/templates" class="text-purple-600 hover:text-purple-700 font-semibold">browse 50+ professional templates</a></p>
            </div>

            <!-- Email Body -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Email Content *</label>
                
                <textarea name="html_body" id="htmlBody" rows="15" required
                          placeholder="<html><body><h1>Hello!</h1><p>Your message here...</p></body></html>"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none font-mono text-sm"></textarea>
                
                <p class="text-xs text-gray-500 mt-2">
                    ‚ú® HTML is supported for better formatting. Use variables like {{first_name}}, {{company}}, etc.
                </p>
            </div>

            <!-- Actions -->
            <div class="flex justify-between items-center pt-6 border-t">
                <div class="space-x-2">
                    <button type="button" onclick="previewEmail()"
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                        <i class="fas fa-eye mr-2"></i>Preview
                    </button>
                    <button type="button" onclick="sendTestEmail()"
                            class="px-6 py-3 border border-blue-300 text-blue-700 rounded-lg hover:bg-blue-50 transition">
                        <i class="fas fa-vial mr-2"></i>Test to Me
                    </button>
                </div>
                <button type="submit" id="sendBtn"
                        class="px-8 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold transition">
                    <i class="fas fa-paper-plane mr-2"></i>Send Email
                </button>
            </div>
        </form>
    </div>

    {% endif %}
</div>

<script>
// Quick template definitions
const quickTemplates = {
    'simple': `<!DOCTYPE html>
<html>
<body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
    <h2>Hello!</h2>
    <p>This is a simple email message.</p>
    <p>Best regards,<br>Your Name</p>
</body>
</html>`,
    
    'welcome': `<!DOCTYPE html>
<html>
<body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
        <h1 style="color: white; margin: 0;">Welcome!</h1>
    </div>
    <div style="background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px;">
        <h2>Hello {{first_name}}!</h2>
        <p>We're excited to have you on board.</p>
        <div style="text-align: center; margin: 30px 0;">
            <a href="#" style="display: inline-block; padding: 15px 30px; background: #667eea; color: white; text-decoration: none; border-radius: 5px;">Get Started</a>
        </div>
    </div>
</body>
</html>`,
    
    'newsletter': `<!DOCTYPE html>
<html>
<body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
    <h2 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px;">Monthly Newsletter</h2>
    <h3>What's New This Month</h3>
    <p>Hello {{first_name}},</p>
    <p>Here are the latest updates from {{company}}...</p>
    <div style="background: #f5f5f5; padding: 20px; margin: 20px 0; border-left: 4px solid #667eea;">
        <h4>Featured Article</h4>
        <p>Your content here...</p>
    </div>
</body>
</html>`,
    
    'promotional': `<!DOCTYPE html>
<html>
<body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f5f5f5; padding: 20px;">
    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 40px; text-align: center; border-radius: 10px; margin-bottom: 20px;">
        <h1 style="color: white; margin: 0 0 10px 0; font-size: 36px;">üéÅ SPECIAL OFFER</h1>
        <p style="color: white; font-size: 20px; margin: 0;">50% OFF Everything!</p>
    </div>
    <div style="background: white; padding: 30px; border-radius: 10px;">
        <p>Hi {{first_name}},</p>
        <p>Don't miss our biggest sale of the year!</p>
        <div style="text-align: center; margin: 30px 0;">
            <a href="#" style="display: inline-block; padding: 18px 40px; background: #f5576c; color: white; text-decoration: none; border-radius: 50px; font-weight: bold;">Shop Now</a>
        </div>
    </div>
</body>
</html>`
};

// Load quick template from dropdown
function loadQuickTemplate(templateKey) {
    if (templateKey && quickTemplates[templateKey]) {
        document.getElementById('htmlBody').value = quickTemplates[templateKey];
        showNotification('success', `Template "${templateKey}" loaded!`);
    }
}

// Load template from session storage (from template gallery)
document.addEventListener('DOMContentLoaded', function() {
    const savedTemplate = sessionStorage.getItem('selectedTemplate');
    const savedTemplateName = sessionStorage.getItem('selectedTemplateName');
    
    if (savedTemplate) {
        const htmlBody = document.getElementById('htmlBody');
        if (htmlBody) {
            htmlBody.value = savedTemplate;
            showNotification('success', `‚úÖ Template "${savedTemplateName || 'Selected template'}" loaded successfully!`);
            
            // Clear session storage
            sessionStorage.removeItem('selectedTemplate');
            sessionStorage.removeItem('selectedTemplateName');
        }
    }
});

// Show notification
function showNotification(type, message) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.style.cssText = 'margin-bottom: 1rem; padding: 1rem 1.5rem; border-radius: 8px; animation: slideDown 0.3s ease-out;';
    
    if (type === 'success') {
        alert.style.background = '#d1fae5';
        alert.style.color = '#065f46';
        alert.style.border = '1px solid #6ee7b7';
    } else if (type === 'error') {
        alert.style.background = '#fee2e2';
        alert.style.color = '#991b1b';
        alert.style.border = '1px solid #fca5a5';
    }
    
    alert.innerHTML = `<strong>${message}</strong>`;
    
    const form = document.getElementById('sendEmailForm');
    if (form) {
        form.parentElement.insertBefore(alert, form);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            alert.style.opacity = '0';
            alert.style.transition = 'opacity 0.3s';
            setTimeout(() => alert.remove(), 300);
        }, 5000);
    }
}

// Preview email
function previewEmail() {
    const subject = document.querySelector('input[name="subject"]').value;
    const body = document.getElementById('htmlBody').value;
    
    if (!subject || !body) {
        alert('Please fill in subject and body first');
        return;
    }
    
    const preview = window.open('', 'Preview', 'width=800,height=600');
    preview.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Email Preview - ${subject}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
                .preview-header { background: white; padding: 15px; margin-bottom: 20px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                .preview-body { background: white; padding: 20px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
            </style>
            <script src="https://scripts.sirv.com/sirvjs/v3/sirv.js"></script>
</head>
        <body>
            <div class="preview-header">
                <strong>Subject:</strong> ${subject}
            </div>
            <div class="preview-body">
                ${body}
            </div>
        </body>
        </html>
    `);
}

// Send test email
function sendTestEmail() {
    const form = document.getElementById('sendEmailForm');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = new FormData(form);
    formData.set('to_email', '{{ current_user.email }}');
    formData.set('is_test', 'true');
    
    sendEmailRequest(formData, 'Test email sent to {{ current_user.email }}!');
}

// Send email request
function sendEmailRequest(formData, successMessage) {
    const button = document.getElementById('sendBtn');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
    
    fetch('/api/emails/send', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => {
        return response.text().then(text => {
            try {
                return JSON.parse(text);
            } catch (e) {
                console.error('Failed to parse JSON:', e);
                console.error('Response was:', text);
                throw new Error('Server error. Please check logs.');
            }
        });
    })
    .then(data => {
        if (data.success) {
            showNotification('success', successMessage || 'Email sent successfully!');
            if (!successMessage) {
                document.getElementById('sendEmailForm').reset();
            }
        } else {
            showNotification('error', 'Error: ' + (data.error || 'Unknown error'));
        }
        button.disabled = false;
        button.innerHTML = originalText;
    })
    .catch(error => {
        console.error('Fetch error:', error);
        showNotification('error', 'Error: ' + error.message);
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

// Form submit handler
document.getElementById('sendEmailForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    sendEmailRequest(formData);
});
</script>
{% endblock %}
